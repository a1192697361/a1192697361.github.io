<!DOCTYPE html>
<html lang="zh-CN">
    
    <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport" />
    <meta name="description" content="Linux æœåŠ¡å™¨ç¼–ç¨‹å°è¯•è®°å½• - C++" />
    <meta name="hexo-theme-A4" content="v1.8.9" />
    <link rel="alternate icon" type="image/webp" href="/img/favicon.webp">
    <title>Fingsinz&#39;s space | é£ä¿¡æ¢“</title>

    
        
<link rel="stylesheet" href="/css/highlight/style1.css">

        
<link rel="stylesheet" href="/css/reset.css">

        
<link rel="stylesheet" href="/css/markdown.css">

        
<link rel="stylesheet" href="/css/fonts.css">
 
         <!--æ³¨æ„ï¼šé¦–é¡µæ—¢ä¸æ˜¯postä¹Ÿä¸æ˜¯page-->
        
        
        
<link rel="stylesheet" href="/css/ui.css">
 
        
<link rel="stylesheet" href="/css/style.css">


        
            <!--è¿”å›é¡¶éƒ¨css-->
            
<link rel="stylesheet" href="/css/returnToTop.css">

            
<link rel="stylesheet" href="/css/unicons.css">

        
        
            <!--ç›®å½•-->
            
<link rel="stylesheet" href="/css/toc.css">

        
    

    
        
<link rel="stylesheet" href="/css/returnToLastPage.css">

    
    
   
<link rel="stylesheet" href="/css/lightgallery.min.css">


<meta name="generator" content="Hexo 7.1.1">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet" /></head>
    
    <style>
        :root {
            --waline-theme-color: #000000; 
            --waline-color: #000000; 
            --waline-border-color: #000000; 
            --waline-white: #000000; 
            --waline-bgcolor-light: white;  
        }
        body {
            color: #000000;
            background: #bed2bb;
        }
        .post-md code {
            background: #e7f7f3;
            color: #7f688d; 
        }
        .post-md pre, .post-md .highlight {
            background: #e7f7f3;
            color: #7f688d; 
        }
        pre .string, pre .value, pre .inheritance, pre .header, pre .ruby .symbol, pre .xml .cdata {
            color: #000000;
        }
        pre .number, pre .preprocessor, pre .built_in, pre .literal, pre .params, pre .constant {
            color: #000000;
        }
        .year-font-color {
            color: #000000 !important;
        }
        .wl-card span.wl-nick {
            color: #000000; 
        }
        .wl-card .wl-badge {
            border: 1px solid #000000;
            color: #000000; 
        }
        .wl-btn {
            border: 1px solid #000000; 
            color:  #000000;  
        }
        .wl-btn.primary {
            color: white; 
        }
        .wl-header label {
            color: #000000;
        }
        a {
            color: #6b798e;
        }

        .post-md a {
            color: #6b798e;
        }

        .nav li a {
            color: #6b798e;
        }

        .archive-main a:link {
            color: #6b798e;
        }
        .archive-main a:visited {
            color: #6b798e; 
        }

        .archive li span {
            color: #000000;
        }

        .post-main-title {
            color: #000000;
        }

        .post-md h1,
        .post-md h2,
        .post-md h3,
        .post-md h4,
        .post-md h5,
        .post-md h6 {
            color: #000000;
        }

        [data-waline] p {
            color: #000000;
        }
        [data-waline] a {
            color: #000000;
        } 
        .wl-sort li.active {
            color: #000000;
        }

        .wl-card .wl-meta>span {
            background: white;
        }

        .paper {
            background: #bed2bb;
        }

        .index-main {
            background: white;
        }

        .paper-main {
            background: white;
        }

        .wl-panel {
            background: white;
        }

        .archive li:nth-child(odd) {
            background: white;
            ;
        }

        .archive li:nth-child(even) {
            background: white;
        }

        .post-md table tr:nth-child(odd) td {
            background: white;
        }

        .post-md table tr:nth-child(even) td {
            background: white;
        }

    
        .progress-wrap::after {
            color: #000000; /* ç®­å¤´çš„é¢œè‰² */
        }
        .progress-wrap svg.progress-circle path {
	        stroke: #000000; /* è¾¹æ¡†çš„é¢œè‰² */
        }
        .progress-wrap::before {
	        background-image: linear-gradient(298deg, #6b798e, #6b798e); /* é¼ æ ‡æ»‘è¿‡çš„ç®­å¤´é¢œè‰² */
         }

        .return-to-last-progress-wrap::after {
            color: #000000; /* ç®­å¤´çš„é¢œè‰² */
        }
        .return-to-last-progress-wrap svg.progress-circle path {
	        stroke: #000000; /* è¾¹æ¡†çš„é¢œè‰² */
        }
        .return-to-last-progress-wrap::before {
	        background-image: linear-gradient(298deg, #6b798e, #6b798e); /* é¼ æ ‡æ»‘è¿‡çš„ç®­å¤´é¢œè‰² */
         }

         .left-toc-container::-webkit-scrollbar-thumb {
            background-color: #000000; /* è®¾ç½®æ»šåŠ¨æ¡æ‹–åŠ¨å—çš„é¢œè‰² */
        }

        .bs-docs-sidebar .nav>.active>a,
        .bs-docs-sidebar .nav>li>a:hover,
        .bs-docs-sidebar .nav>li>a:focus {
            color: #6b798e;
            border-left-color: #6b798e;
        }
        .bs-docs-sidebar .nav>li>a {
            color:  #000000;
        }
    </style>

    
    <body>
        
            <div class="left-toc-container">
                <nav id="toc" class="bs-docs-sidebar"></nav>
            </div>
        
        <div class="paper">
            
            
            
            
                <div class="shadow-drop-2-bottom paper-main">
                    


<div class="header">
    <div class="header-container">
        <img style="
        width: 56px;
        height: auto;" alt="^-^" cache-control="max-age=86400" class="header-img" src="/img/favicon.webp" width="10%"></img>
        <div class="header-content">
            <a class="logo" href="/">Fingsinz&#39;s space</a> 
            <span class="description">æˆ‘åœ¨æƒ³ï¼Œæ—¶ä¸‹ä½ æ‰€éœ€è¦çš„ï¼Œåº”è¯¥æ˜¯ç—›ç—›å¿«å¿«æ¢ä¸ªå¿ƒæƒ…ï¼Œå¹²å¹²è„†è„†äº«å—äººç”Ÿã€‚</span> 
        </div>
        
    </div>
    
   
    <ul class="nav">
        
            
                <li><a href="/">é¦–é¡µğŸšï¸</a></li>
            
        
            
                <li><a href="/list/">æ–‡ç« ğŸ“„</a></li>
            
        
            
                <li><a href="/notes/">ç¬”è®°ğŸ“”</a></li>
            
        
            
                <li><a href="/funny/">è¶£äº‹ğŸ’¡</a></li>
            
        
            
                <li><a href="/about/">å…³äºğŸ§‘</a></li>
            
        
    </ul>
</div> 
        
                    
                    

                    
                    
                    
                    <!--è¯´æ˜æ˜¯æ–‡ç« posté¡µé¢-->
                    
                        <div class="post-main">

    
        <div class="post-main-title">
            Linux æœåŠ¡å™¨ç¼–ç¨‹å°è¯•è®°å½• - C++
        </div>
      
    

    <div class="post-md">
        
            
                <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%80-%E4%BB%8Esocket%E5%BC%80%E5%A7%8B"><span class="post-toc-text">ä¸€ã€ä»socketå¼€å§‹</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-1-%E6%9C%8D%E5%8A%A1%E7%AB%AF%E5%B9%B2%E4%BA%86%E4%BB%80%E4%B9%88"><span class="post-toc-text">1.1 æœåŠ¡ç«¯å¹²äº†ä»€ä¹ˆ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-2-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E9%85%8D%E5%90%88"><span class="post-toc-text">1.2 å®¢æˆ·ç«¯å¦‚ä½•é…åˆ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#1-3-%E8%AF%A5%E8%8A%82%E6%B6%89%E5%8F%8A%E5%87%BD%E6%95%B0%E5%8F%8A%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="post-toc-text">1.3 è¯¥èŠ‚æ¶‰åŠå‡½æ•°åŠæºä»£ç </span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%8C-%E5%AE%8C%E5%96%84%E4%BB%A3%E7%A0%81-%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99"><span class="post-toc-text">äºŒã€å®Œå–„ä»£ç ï¼Œæ•°æ®è¯»å†™</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-1-%E9%94%99%E8%AF%AF%E6%A3%80%E6%9F%A5%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="post-toc-text">2.1 é”™è¯¯æ£€æŸ¥å¤„ç†å‡½æ•°</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-2-%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%86%99"><span class="post-toc-text">2.2 æ•°æ®è¯»å†™</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#2-3-%E8%AF%A5%E8%8A%82%E6%B6%89%E5%8F%8A%E5%87%BD%E6%95%B0%E5%8F%8A%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="post-toc-text">2.3 è¯¥èŠ‚æ¶‰åŠå‡½æ•°åŠæºä»£ç </span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%89-%E9%AB%98%E5%B9%B6%E5%8F%91%E4%BD%BF%E7%94%A8epoll"><span class="post-toc-text">ä¸‰ã€é«˜å¹¶å‘ä½¿ç”¨epoll</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-1-%E4%BB%8Eselect-poll%E5%88%B0epoll"><span class="post-toc-text">3.1 ä»selectã€pollåˆ°epoll</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#3-2-%E5%B0%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%94%B9%E5%86%99%E6%88%90epoll%E7%89%88%E6%9C%AC"><span class="post-toc-text">3.2 å°†æœåŠ¡å™¨æ”¹å†™æˆepollç‰ˆæœ¬</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%9B%9B-%E5%B0%81%E8%A3%85%E6%88%90%E7%B1%BB-%E7%A8%8B%E5%BA%8F%E6%A8%A1%E5%9D%97%E5%8C%96"><span class="post-toc-text">å››ã€å°è£…æˆç±»ï¼Œç¨‹åºæ¨¡å—åŒ–</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-1-%E5%B0%86socket%E5%92%8Cinetaddress%E5%B0%81%E8%A3%85%E6%88%90%E7%B1%BB"><span class="post-toc-text">4.1 å°†socketå’ŒInetAddresså°è£…æˆç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-2-%E5%B0%86epoll%E5%B0%81%E8%A3%85%E6%88%90%E7%B1%BB"><span class="post-toc-text">4.2 å°†epollå°è£…æˆç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#4-3-%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E5%8F%8A%E6%BA%90%E4%BB%A3%E7%A0%81"><span class="post-toc-text">4.3 ç›®å½•ç»“æ„åŠæºä»£ç </span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%BA%94-%E5%90%91%E7%9D%80reactor%E6%A8%A1%E5%BC%8F%E8%BD%AC%E5%8F%98"><span class="post-toc-text">äº”ã€å‘ç€Reactoræ¨¡å¼è½¬å˜</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-1-reactor%E5%92%8Cproactor"><span class="post-toc-text">5.1 Reactorå’ŒProactor</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-2-%E5%8A%A0%E5%85%A5channel%E7%B1%BB"><span class="post-toc-text">5.2 åŠ å…¥Channelç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-3-%E5%8A%A0%E5%85%A5eventloop%E7%B1%BB"><span class="post-toc-text">5.3 åŠ å…¥EventLoopç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#5-4-%E5%8A%A0%E5%85%A5server%E7%B1%BB"><span class="post-toc-text">5.4 åŠ å…¥Serverç±»</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%85%AD-%E6%8A%8A%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E6%8E%A5%E5%8F%97%E6%8A%BD%E8%B1%A1%E5%8C%96"><span class="post-toc-text">å…­ã€æŠŠæœåŠ¡å™¨çš„æ¥å—æŠ½è±¡åŒ–</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-1-%E6%8A%BD%E8%B1%A1%E5%8C%96%E6%8E%A5%E5%8F%97"><span class="post-toc-text">6.1 æŠ½è±¡åŒ–æ¥å—</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#6-2-acceptor-%E7%B1%BB"><span class="post-toc-text">6.2 Acceptor ç±»</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B8%83-%E6%8A%8Atcp%E8%BF%9E%E6%8E%A5%E6%8A%BD%E8%B1%A1%E5%8C%96"><span class="post-toc-text">ä¸ƒã€æŠŠTCPè¿æ¥æŠ½è±¡åŒ–</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-1-%E6%8A%BD%E8%B1%A1%E5%8C%96%E8%BF%9E%E6%8E%A5"><span class="post-toc-text">7.1 æŠ½è±¡åŒ–è¿æ¥</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-2-connection-%E7%B1%BB"><span class="post-toc-text">7.2 Connection ç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#7-3-%E6%94%B9%E5%86%99-server-%E7%B1%BB"><span class="post-toc-text">7.3 æ”¹å†™ Server ç±»</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%85%AB-%E9%97%B2%E6%9D%A5%E6%97%A0%E4%BA%8B-%E6%95%B4%E4%B8%AA%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="post-toc-text">å…«ã€é—²æ¥æ— äº‹ï¼Œæ•´ä¸ªç¼“å†²åŒº</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#8-1-%E5%BC%95%E5%85%A5%E7%BC%93%E5%86%B2%E5%8C%BA"><span class="post-toc-text">8.1 å¼•å…¥ç¼“å†²åŒº</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#8-2-buffer%E7%B1%BB"><span class="post-toc-text">8.2 Bufferç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#8-3-%E5%85%B6%E4%BB%96%E6%96%B9%E9%9D%A2%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="post-toc-text">8.3 å…¶ä»–æ–¹é¢çš„æ”¹è¿›</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E4%B9%9D-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%95%8A%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="post-toc-text">ä¹ã€çº¿ç¨‹æ± å•Šçº¿ç¨‹æ± </span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#9-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8A%A0%E5%85%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="post-toc-text">9.1 ä¸ºä»€ä¹ˆåŠ å…¥çº¿ç¨‹æ± </span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#9-2-%E5%A6%82%E4%BD%95%E8%AE%BE%E8%AE%A1%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="post-toc-text">9.2 å¦‚ä½•è®¾è®¡çº¿ç¨‹æ± </span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#9-3-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%94%A8%E5%88%B0%E7%9A%84%E8%AF%AD%E6%B3%95%E7%9F%A5%E8%AF%86"><span class="post-toc-text">9.3 çº¿ç¨‹æ± ç”¨åˆ°çš„è¯­æ³•çŸ¥è¯†</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#9-4-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%B1%BB"><span class="post-toc-text">9.4 çº¿ç¨‹æ± ç±»</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81-%E6%9C%89%E4%BA%86%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B9%8B%E5%90%8E%E7%9A%84%E8%80%83%E8%99%91"><span class="post-toc-text">åã€æœ‰äº†çº¿ç¨‹æ± ä¹‹åçš„è€ƒè™‘</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#10-1-%E5%AE%8C%E5%96%84%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="post-toc-text">10.1 å®Œå–„çº¿ç¨‹æ± </span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#10-2-%E5%AE%8C%E5%96%84%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%94%A8%E5%88%B0%E7%9A%84%E8%AF%AD%E6%B3%95%E7%9F%A5%E8%AF%86"><span class="post-toc-text">10.2 å®Œå–„çº¿ç¨‹æ± ç”¨åˆ°çš„è¯­æ³•çŸ¥è¯†</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#10-3-%E5%86%8D%E4%BF%AE%E4%BF%AE%E8%A1%A5%E8%A1%A5"><span class="post-toc-text">10.3 å†ä¿®ä¿®è¡¥è¡¥</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%B8%80-%E6%94%B9%E5%86%99%E6%88%90%E4%B8%BB%E4%BB%8Ereactor%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%BC%8F"><span class="post-toc-text">åä¸€ã€æ”¹å†™æˆä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å¼</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#11-1-%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%BB%E4%BB%8Ereactor%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%A8%A1%E5%BC%8F"><span class="post-toc-text">11.1 ä»€ä¹ˆæ˜¯ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å¼</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#11-2-%E4%BB%A3%E7%A0%81%E4%B8%8A%E7%9A%84%E5%8F%98%E5%8C%96"><span class="post-toc-text">11.2 ä»£ç ä¸Šçš„å˜åŒ–</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%BA%8C-%E9%A1%B9%E7%9B%AE%E5%B7%A5%E7%A8%8B%E5%8C%96"><span class="post-toc-text">åäºŒã€é¡¹ç›®å·¥ç¨‹åŒ–</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#12-1-%E8%AE%A4%E8%AF%86cmake"><span class="post-toc-text">12.1 è®¤è¯†Cmake</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#12-2-%E5%B7%A5%E7%A8%8B%E5%8C%96%E7%9A%84%E5%AE%9E%E9%99%85%E6%93%8D%E4%BD%9C"><span class="post-toc-text">12.2 å·¥ç¨‹åŒ–çš„å®é™…æ“ä½œ</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E4%B8%89-%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8C%96"><span class="post-toc-text">åä¸‰ã€ä¸šåŠ¡é€»è¾‘è‡ªå®šä¹‰åŒ–</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#13-1-%E4%B8%9A%E5%8A%A1%E9%80%BB%E8%BE%91%E6%80%9D%E6%83%B3"><span class="post-toc-text">13.1 ä¸šåŠ¡é€»è¾‘æ€æƒ³</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#13-2-%E6%93%8D%E5%88%80%E5%8A%A8%E4%BB%A3%E7%A0%81"><span class="post-toc-text">13.2 æ“åˆ€åŠ¨ä»£ç </span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8D%81%E5%9B%9B-%E5%86%8D%E6%AC%A1%E9%87%8D%E6%9E%84-%E5%91%8A%E4%B8%80%E6%AE%B5%E8%90%BD"><span class="post-toc-text">åå››ã€å†æ¬¡é‡æ„ï¼Œå‘Šä¸€æ®µè½</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-1-%E9%87%8D%E6%9E%84%E6%80%9D%E6%83%B3"><span class="post-toc-text">14.1 é‡æ„æ€æƒ³</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-2-%E8%AE%BE%E8%AE%A1%E5%AE%8F%E5%AE%9A%E4%B9%89-common-h"><span class="post-toc-text">14.2 è®¾è®¡å®å®šä¹‰ï¼ˆCommon.hï¼‰</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-3-%E9%87%8D%E6%9E%84socket%E7%B1%BB"><span class="post-toc-text">14.3 é‡æ„Socketç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-4-%E5%B0%8F%E6%94%B9channel%E7%B1%BB%E5%92%8Cepoll%E7%B1%BB"><span class="post-toc-text">14.4 å°æ”¹Channelç±»å’ŒEpollç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-5-%E5%B0%8F%E6%94%B9eventloop%E7%B1%BB"><span class="post-toc-text">14.5 å°æ”¹EventLoopç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-6-%E5%B0%8F%E6%94%B9acceptor%E7%B1%BB"><span class="post-toc-text">14.6 å°æ”¹Acceptorç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-7-%E5%B0%8F%E6%94%B9connection%E7%B1%BB"><span class="post-toc-text">14.7 å°æ”¹Connectionç±»</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#14-8-%E9%87%8D%E5%A4%B4%E6%88%8Fserver%E7%B1%BB"><span class="post-toc-text">14.8 é‡å¤´æˆServerç±»</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E9%99%84%E5%BD%95"><span class="post-toc-text">é™„å½•</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%99%84-1-%E4%BB%A3%E7%A0%81%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="post-toc-text">é™„ 1 - ä»£ç è¿è¡Œç¯å¢ƒ</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%99%84-2-cmake%E7%9A%84%E5%AE%89%E8%A3%85%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="post-toc-text">é™„ 2 - CMakeçš„å®‰è£…å’Œä½¿ç”¨</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%99%84-2-1-%E6%A3%80%E6%9F%A5%E8%BF%9C%E7%A8%8B%E7%9A%84cmake%E7%8E%AF%E5%A2%83%E5%92%8C%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83"><span class="post-toc-text">é™„ 2.1 æ£€æŸ¥è¿œç¨‹çš„CMakeç¯å¢ƒå’Œç¼–è¯‘ç¯å¢ƒ</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%99%84-2-2-visual-studio-2022%E4%B8%AD%E4%BD%BF%E7%94%A8cmake%E8%BF%9B%E8%A1%8C%E8%BF%9C%E7%A8%8Blinux%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91"><span class="post-toc-text">é™„ 2.2 Visual Studio 2022ä¸­ä½¿ç”¨CMakeè¿›è¡Œè¿œç¨‹LinuxæœåŠ¡å™¨å¼€å‘</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%99%84-2-2-visual-studio-2022%E4%B8%AD%E4%BD%BF%E7%94%A8cmake%E8%BF%9B%E8%A1%8Cwsl%E5%BC%80%E5%8F%91"><span class="post-toc-text">é™„ 2.2 Visual Studio 2022ä¸­ä½¿ç”¨CMakeè¿›è¡ŒWSLå¼€å‘</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%99%84-2-3-cmake%E7%9B%B8%E5%85%B3%E8%B5%84%E6%96%99"><span class="post-toc-text">é™„ 2.3 CMakeç›¸å…³èµ„æ–™</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%99%84-3-%E5%8F%AF%E8%83%BD%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="post-toc-text">é™„ 3 - å¯èƒ½å‡ºç°çš„é—®é¢˜</span></a></li></ol></li></ol>
            
        
        <div class=".article-gallery"><p>å…³é”®è¯ï¼šC++ã€Linux</p>
<span id="more"></span>
<hr>
<blockquote>
<p><strong>Referencesï¼š</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/yuesong-feng/30dayMakeCppServer/">30å¤©è‡ªåˆ¶C++æœåŠ¡å™¨</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/yuesong-feng/pine">é…å¥—ç½‘ç»œåº“ pine</a></li>
</ul>
<p><em>Linuxä¸‹æ“ä½œã€‚</em></p>
</blockquote>
<h2 id="ä¸€-ä»socketå¼€å§‹">ä¸€ã€ä»socketå¼€å§‹</h2>
<p>socketï¼Œè¢«ç¿»è¯‘ä¸ºå¥—æ¥å­—ï¼Œå®ƒæ˜¯è®¡ç®—æœºä¹‹é—´è¿›è¡Œé€šä¿¡çš„ä¸€ç§çº¦å®šæˆ–ä¸€ç§æ–¹å¼ã€‚</p>
<ul>
<li>é€šè¿‡ socket è¿™ç§çº¦å®šï¼Œä¸€å°è®¡ç®—æœºå¯ä»¥æ¥æ”¶å…¶ä»–è®¡ç®—æœºçš„æ•°æ®ï¼Œä¹Ÿå¯ä»¥å‘å…¶ä»–è®¡ç®—æœºå‘é€æ•°æ®ã€‚</li>
</ul>
<h3 id="1-1-æœåŠ¡ç«¯å¹²äº†ä»€ä¹ˆ">1.1 æœåŠ¡ç«¯å¹²äº†ä»€ä¹ˆ</h3>
<p>åœ¨æœåŠ¡å™¨ç«¯ï¼Œéœ€è¦å»ºç«‹ä¸€ä¸ª socket å¥—æ¥å­—ï¼Œå¯¹å¤–æä¾›ä¸€ä¸ªç½‘ç»œé€šä¿¡æ¥å£ã€‚</p>
<ul>
<li>åœ¨ Linux ç³»ç»Ÿä¸­è¿™ä¸ªå¥—æ¥å­—ä»…ä»…æ˜¯ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªintç±»å‹çš„å€¼ã€‚</li>
<li>å¯¹å¥—æ¥å­—çš„æ‰€æœ‰æ“ä½œï¼ˆåŒ…æ‹¬åˆ›å»ºï¼‰éƒ½æ˜¯æœ€åº•å±‚çš„ç³»ç»Ÿè°ƒç”¨ã€‚</li>
</ul>
<ol>
<li>åˆ›å»ºå¥—æ¥å­—ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>åˆ›å»ºä¸€ä¸ª <code>sockaddr_in</code> ç»“æ„ä½“å¹¶åˆå§‹åŒ–ï¼ˆ<code>bzero</code> å‡½æ•°ï¼‰ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serverAddr;</span><br><span class="line"><span class="built_in">bzero</span>(&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr));</span><br></pre></td></tr></tbody></table></figure>
<ol start="3">
<li>è®¾ç½®åœ°å€æ—ã€IP åœ°å€å’Œç«¯å£å·ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">serverAddr.sin_family = AF_INET;</span><br><span class="line">serverAddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">serverAddr.sin_port = <span class="built_in">htons</span>(<span class="number">1234</span>);</span><br></pre></td></tr></tbody></table></figure>
<ol start="4">
<li>å°† socket åœ°å€ä¸æ–‡ä»¶æè¿°ç¬¦ç»‘å®šï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span>(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr));</span><br></pre></td></tr></tbody></table></figure>
<ol start="5">
<li>ä½¿ç”¨ <code>listen</code> å‡½æ•°ç›‘å¬å¥—æ¥å­—ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">listen</span>(sockfd, SOMAXCONN);</span><br></pre></td></tr></tbody></table></figure>
<ol start="6">
<li>æœåŠ¡ç«¯æƒ³è¦æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œéœ€è¦ä½¿ç”¨ <code>accept</code> å‡½æ•°ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> clientAddr;</span><br><span class="line"><span class="type">socklen_t</span> clientAddrLen = <span class="built_in">sizeof</span>(clientAddr);</span><br><span class="line"><span class="built_in">bzero</span>(&amp;clientAddr, <span class="built_in">sizeof</span>(clientAddr));</span><br><span class="line"><span class="type">int</span> clientSockfd = <span class="built_in">accept</span>(sockfd, (sockaddr *)&amp;clientAddr, &amp;clientAddrLen);</span><br></pre></td></tr></tbody></table></figure>
<ol start="7">
<li>è¾“å‡º socket è¿æ¥ä¿¡æ¯ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"Client connected: %d!\tIP: %s\tPort: %d\n"</span>, clientSockfd, <span class="built_in">inet_ntoa</span>(clientAddr.sin_addr), <span class="built_in">ntohs</span>(clientAddr.sin_port));</span><br></pre></td></tr></tbody></table></figure>
<p>è‡³æ­¤ï¼Œå®¢æˆ·ç«¯å·²ç»å¯ä»¥é€šè¿‡ IP åœ°å€å’Œç«¯å£å·è¿æ¥åˆ°è¿™ä¸ª socket ç«¯å£äº†ã€‚</p>
<h3 id="1-2-å®¢æˆ·ç«¯å¦‚ä½•é…åˆ">1.2 å®¢æˆ·ç«¯å¦‚ä½•é…åˆ</h3>
<p>åœ¨å®¢æˆ·ç«¯ï¼Œä¹Ÿéœ€è¦å»ºç«‹ä¸€ä¸ª socket å¥—æ¥å­—ã€‚</p>
<p>å¯¹äºå®¢æˆ·ç«¯ï¼ŒæœåŠ¡å™¨å­˜åœ¨çš„å”¯ä¸€æ ‡è¯†æ˜¯ IP åœ°å€å’Œç«¯å£å·ã€‚æ­¤æ—¶éœ€è¦å°†å¥—æ¥å­—ç»‘å®šåˆ°ä¸€ä¸ª IP åœ°å€å’Œç«¯å£ä¸Šã€‚</p>
<ol>
<li>åˆ›å»ºå¥—æ¥å­—ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>åˆ›å»ºä¸€ä¸ª <code>sockaddr_in</code> ç»“æ„ä½“ï¼Œå¹¶ç»‘å®š IP æ—ã€IP åœ°å€å’Œç«¯å£å·ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serverAddr;</span><br><span class="line"><span class="built_in">bzero</span>(&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr));</span><br><span class="line">serverAddr.sin_family = AF_INET;</span><br><span class="line">serverAddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">"127.0.0.1"</span>);</span><br><span class="line">serverAddr.sin_port = <span class="built_in">htons</span>(<span class="number">1234</span>);</span><br></pre></td></tr></tbody></table></figure>
<ol start="3">
<li>ä½¿ç”¨ <code>connect</code> å‡½æ•°è¿›è¡Œè¿æ¥ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">connect</span>(sockfd, (sockaddr *)&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr));</span><br></pre></td></tr></tbody></table></figure>
<p>æ³¨æ„ï¼Œéœ€è¦å…ˆ <code>./server</code> è¿è¡ŒæœåŠ¡ç«¯è¿›è¡Œç­‰å¾…ï¼Œå† <code>./client</code> è¿è¡Œå®¢æˆ·ç«¯è¿›è¡Œè¿æ¥è¯·æ±‚ã€‚</p>
<h3 id="1-3-è¯¥èŠ‚æ¶‰åŠå‡½æ•°åŠæºä»£ç ">1.3 è¯¥èŠ‚æ¶‰åŠå‡½æ•°åŠæºä»£ç </h3>
<ul>
<li>ç›¸å…³å¤´æ–‡ä»¶ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span> <span class="comment">// åˆ›å»º socket æ‰€éœ€</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span>  <span class="comment">// socket åœ°å€ç»“æ„ä½“æ‰€éœ€</span></span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆ›å»º socketï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">socket</span> <span class="params">(<span class="type">int</span> __domain, <span class="type">int</span> __type, <span class="type">int</span> __protocol)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __domainï¼šIP åœ°å€ç±»å‹ï¼ŒAF_INET è¡¨ç¤º IPv4ï¼ŒAF_INET6 è¡¨ç¤º IPv6ã€‚</span></span><br><span class="line"><span class="comment">* __typeï¼šæ•°æ®ä¼ è¾“æ–¹å¼ï¼ŒSOCK_STREAM è¡¨ç¤ºæµæ ¼å¼ã€é¢å‘é“¾æ¥ï¼Œå¤šç”¨äº TCPï¼› SOCK_DGRAM è¡¨ç¤ºæ•°æ®æŠ¥æ ¼å¼ã€æ— è¿æ¥ï¼Œå¤šç”¨äº UDPã€‚</span></span><br><span class="line"><span class="comment">* __protocolï¼šåè®®ï¼Œ0 è¡¨ç¤ºæ ¹æ®å‰é¢ä¸¤ä¸ªå‚æ•°è‡ªåŠ¨æ¨å¯¼åè®®ç±»å‹ã€‚è®¾ç½®ä¸º IPPROTO_TCP å’Œ IPPROTO_UDPï¼Œåˆ†åˆ«è¡¨ç¤º TCP å’Œ UDPã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åˆå§‹åŒ–ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">bzero</span> <span class="params">(<span class="type">void</span> *__s, <span class="type">size_t</span> __n)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __sï¼šæŒ‡å‘è¦æ¸…é›¶çš„å†…å­˜å—çš„æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="comment">* __nï¼šè¦æ¸…é›¶çš„å†…å­˜å—çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment">* è¯¥å‡½æ•°åœ¨å¤´æ–‡ä»¶ string.h æˆ– cstring ä¸­ã€‚</span></span><br><span class="line"><span class="comment">* Effective C++ - æ¡æ¬¾01ï¼šè§† C++ ä¸ºä¸€ä¸ªè¯­è¨€è”é‚¦ã€‚å†™ C å°±ç”¨ string.hï¼Œå†™ C++ å°±ç”¨ cstringã€‚</span></span><br><span class="line"><span class="comment">* Effective C++ - æ¡æ¬¾04ï¼šç¡®å®šå¯¹è±¡è¢«ä½¿ç”¨å‰å·²å…ˆè¢«åˆå§‹åŒ–ã€‚ä½¿ç”¨ bzero è¿›è¡Œåˆå§‹åŒ–ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç»‘å®šå‡½æ•°ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">bind</span> <span class="params">(<span class="type">int</span> __fd, __CONST_SOCKADDR_ARG __addr, <span class="type">socklen_t</span> __len)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* __addrï¼šsockaddr å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">* __lenï¼šsockaddr å‚æ•°çš„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>listen</code> å‡½æ•°ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">listen</span> <span class="params">(<span class="type">int</span> __fd, <span class="type">int</span> __n)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* __nï¼šæœ€å¤§ç›‘å¬é˜Ÿåˆ—é•¿åº¦ï¼Œå®å®šä¹‰ SOMAXCONN ä¸ºæœ€å¤§å€¼ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>accept</code> å‡½æ•°ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">accept</span> <span class="params">(<span class="type">int</span> __fd, __SOCKADDR_ARG __addr, <span class="type">socklen_t</span> *__restrict __addr_len)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __fdï¼šæœåŠ¡ç«¯çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* __addr`ï¼šsockaddr å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">* __addr_len`ï¼šæŒ‡å‘ sockaddr å‚æ•°å¤§å°çš„æŒ‡é’ˆã€‚å› ä¸º accept éœ€è¦å†™å…¥å®¢æˆ·ç«¯ socket é•¿åº¦ï¼Œæ‰€ä»¥éœ€è¦åœ°å€</span></span><br><span class="line"><span class="comment">* å¦å¤–ï¼Œè¯¥å‡½æ•°ä¼šé˜»å¡å½“å‰ç¨‹åºï¼Œç›´åˆ°æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯ socket è¢«æ¥å—åç¨‹åºæ‰ä¼šå¾€ä¸‹æ‰§è¡Œã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>connect</code> å‡½æ•°ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">connect</span> <span class="params">(<span class="type">int</span> __fd, __CONST_SOCKADDR_ARG __addr, <span class="type">socklen_t</span> __len)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __fdï¼šå®¢æˆ·ç«¯çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* __addrï¼šsockaddr å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">* __lenï¼šsockaddr å‚æ•°å¤§å°ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day1">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day1">Gitee</a></p>
<h2 id="äºŒ-å®Œå–„ä»£ç -æ•°æ®è¯»å†™">äºŒã€å®Œå–„ä»£ç ï¼Œæ•°æ®è¯»å†™</h2>
<p>ä¸Šé¢çš„ä»£ç æ˜¯åŸºç¡€ç‰ˆçš„ï¼Œä½†è¦æƒ³çœŸæ­£è¿è¡Œä½¿ç”¨ï¼Œéœ€è¦å®Œå–„ä»£ç ï¼Œå¹¶æŠ“ä½é”™è¯¯ã€‚</p>
<ul>
<li>Effective C++ ä¸­æœ‰æåˆ°ï¼šâ€œåˆ«è®©å¼‚å¸¸é€ƒç¦»ææ„å‡½æ•°â€ï¼ˆæ¡æ¬¾08ï¼‰ã€‚</li>
</ul>
<h3 id="2-1-é”™è¯¯æ£€æŸ¥å¤„ç†å‡½æ•°">2.1 é”™è¯¯æ£€æŸ¥å¤„ç†å‡½æ•°</h3>
<p>å¯¹äº Linux ç³»ç»Ÿè°ƒç”¨ï¼Œå¸¸è§çš„é”™è¯¯æç¤ºæ–¹å¼æ˜¯ä½¿ç”¨è¿”å›å€¼å’Œè®¾ç½®é”™è¯¯ç ã€‚</p>
<ul>
<li>å½“ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨è¿”å› <code>-1</code>ï¼Œè¯´æ˜æœ‰é”™è¯¯å‘ç”Ÿã€‚</li>
</ul>
<p>å¢åŠ ä¸€ä¸ªé”™è¯¯æ£€æŸ¥å¤„ç†å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">errorif</span><span class="params">(<span class="type">bool</span> condition, <span class="type">const</span> <span class="type">char</span> *errmsg)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">if</span> (condition)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">perror</span>(errmsg);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºåˆ¤æ–­æ˜¯å¦å‘ç”Ÿé”™è¯¯æ¡ä»¶ï¼Œè°ƒç”¨ <code>iostream</code> ä¸­çš„ <code>perror</code> æ‰“å°é”™è¯¯ã€‚</li>
<li>ç¬¬äºŒä¸ªå‚æ•°ä¸ºé”™è¯¯ä¿¡æ¯ã€‚</li>
<li>ç„¶åä½¿ç”¨ <code>exit</code> å‡½æ•°è®©ç¨‹åºé€€å‡ºå¹¶è¿”å›ä¸€ä¸ªé¢„å®šä¹‰å¸¸é‡ <code>EXIT_FAILURE</code>ã€‚</li>
</ul>
<p>ä½¿ç”¨å°±å¾ˆæ–¹ä¾¿ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> sockfd = <span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">errorif</span>(sockfd == <span class="number">-1</span>, <span class="string">"socket create error"</span>);</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹æ‰€æœ‰å‡½æ•°éƒ½è¿›è¡Œå¤„ç†é”™è¯¯ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">errorif</span>(<span class="built_in">bind</span>(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr)) == <span class="number">-1</span>, <span class="string">"socket bind error"</span>);</span><br><span class="line"><span class="built_in">errorif</span>(<span class="built_in">listen</span>(sockfd, SOMAXCONN) == <span class="number">-1</span>, <span class="string">"socket listen error"</span>);</span><br><span class="line"><span class="built_in">errorif</span>(clientfd == <span class="number">-1</span>, <span class="string">"socket accept error"</span>);</span><br><span class="line"><span class="built_in">errorif</span>(<span class="built_in">connect</span>(sockfd, (<span class="keyword">struct</span> sockaddr *)&amp;serverAddr, <span class="built_in">sizeof</span>(serverAddr)) == <span class="number">-1</span>, <span class="string">"socket connect error"</span>);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><em>é”™è¯¯çš„å¤„ç†æ˜¯å¿…é¡»çš„ï¼Œä½†å¤„ç†å‡½æ•°ä¸ä¸€å®šè¿™æ ·å†™ã€‚</em></li>
</ul>
<h3 id="2-2-æ•°æ®è¯»å†™">2.2 æ•°æ®è¯»å†™</h3>
<p>å½“å»ºç«‹ socket è¿æ¥åï¼Œå°±å¯ä»¥ä½¿ç”¨ <code>unistd.h</code> ä¸­çš„ <code>read</code> å’Œ <code>write</code> å‡½æ•°è¿›è¡Œæ•°æ®è¯»å†™ã€‚ï¼ˆä»…é™äº TCP è¿æ¥ã€‚UDP è¿æ¥ä½¿ç”¨ <code>sendto</code> å’Œ <code>recvfrom</code> å‡½æ•°ã€‚ï¼‰</p>
<p>æ¥ä¸‹æ¥åšä¸€ä¸ªé€šä¿¡æƒ…å†µï¼šå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€ä¸€å®šæ•°æ®ï¼Œç„¶åæœåŠ¡ç«¯æ¥æ”¶åè½¬å‘å›å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å°†æ¥æ”¶çš„è½¬å‘æ•°æ®å†è¿›è¡Œæ ‡å‡†è¾“å‡ºã€‚</p>
<p>å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)	<span class="comment">// æŒç»­é€šä¿¡</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">1024</span>];	<span class="comment">// å®šä¹‰ç¼“å†²åŒº</span></span><br><span class="line">	std::cin &gt;&gt; buffer;	<span class="comment">// ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// å‘æœåŠ¡ç«¯å‘é€æ•°æ®</span></span><br><span class="line">	<span class="type">size_t</span> writeLen = <span class="built_in">write</span>(sockfd, buffer, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// å‘é€å¤±è´¥å¤„ç†</span></span><br><span class="line">	<span class="keyword">if</span> (writeLen == <span class="number">-1</span>)</span><br><span class="line">	{</span><br><span class="line">		std::cout &lt;&lt; <span class="string">"Socket already disconnected!\n"</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="built_in">bzero</span>(buffer, <span class="built_in">sizeof</span>(buffer));	<span class="comment">// æ¸…ç©ºç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// è¯»å›æ•°æ®</span></span><br><span class="line">	<span class="type">size_t</span> readLen = <span class="built_in">read</span>(sockfd, buffer, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è¯»æ•°æ®é—®é¢˜åˆ¤æ–­</span></span><br><span class="line">	<span class="keyword">if</span> (readLen &gt; <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">		std::cout &lt;&lt; buffer &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (readLen == <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">		std::cout &lt;&lt; <span class="string">"Server socket disconnected!\n"</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (readLen == <span class="number">-1</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">close</span>(sockfd);</span><br><span class="line">		<span class="built_in">errorif</span>(<span class="literal">true</span>, <span class="string">"socket read error"</span>);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>æœåŠ¡ç«¯ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">// å®šä¹‰å¹¶åˆå§‹åŒ–ç¼“å†²åŒº</span></span><br><span class="line">	<span class="type">char</span> buffer[<span class="number">1024</span>];</span><br><span class="line">	<span class="built_in">bzero</span>(buffer, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®</span></span><br><span class="line">	<span class="type">size_t</span> readLen = <span class="built_in">read</span>(clientfd, buffer, <span class="built_in">sizeof</span>(buffer));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// è¯»å–æ•°æ®é—®é¢˜åˆ¤æ–­</span></span><br><span class="line">	<span class="keyword">if</span> (readLen &gt; <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">		std::cout &lt;&lt; <span class="string">"Message from client:"</span> &lt;&lt; clientfd &lt;&lt; <span class="string">": "</span> &lt;&lt; buffer &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">		<span class="built_in">write</span>(clientfd, buffer, <span class="built_in">sizeof</span>(buffer));	<span class="comment">// è¯»åˆ°åè½¬å›å®¢æˆ·ç«¯</span></span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (readLen == <span class="number">0</span>)</span><br><span class="line">	{</span><br><span class="line">		std::cout &lt;&lt; <span class="string">"Client "</span> &lt;&lt; clientfd &lt;&lt; <span class="string">" disconnected\n"</span>;</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (readLen == <span class="number">-1</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">close</span>(clientfd);</span><br><span class="line">		<span class="built_in">errorif</span>(<span class="literal">true</span>, <span class="string">"socket read error"</span>);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼š</p>
<ul>
<li>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯éƒ½å¯ä»¥ä»å¯¹æ–¹ä¸­è¯»å†™æ•°æ®ã€‚</li>
<li>ä½¿ç”¨å®Œä¸€ä¸ª <code>fd</code>ï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰ åï¼Œè®°å¾—ä½¿ç”¨ <code>close</code> å‡½æ•°è¿›è¡Œå…³é—­ã€‚</li>
</ul>
<h3 id="2-3-è¯¥èŠ‚æ¶‰åŠå‡½æ•°åŠæºä»£ç ">2.3 è¯¥èŠ‚æ¶‰åŠå‡½æ•°åŠæºä»£ç </h3>
<ul>
<li>ç›¸å…³å¤´æ–‡ä»¶ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>	<span class="comment">// è¯»å†™æ•°æ®ç­‰éœ€è¦</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"util.h"</span>  	<span class="comment">// æ”¾ç½®é”™è¯¯å¤„ç†å‡½æ•°</span></span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>write</code> å‡½æ•°ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">write</span> <span class="params">(<span class="type">int</span> __fd, <span class="type">const</span> <span class="type">void</span> *__buf, <span class="type">size_t</span> __n)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* __bufï¼šå†™å…¥ç¼“å†²åŒºã€‚</span></span><br><span class="line"><span class="comment">* __nï¼šå†™å…¥ç¼“å†²åŒºå¤§å°ã€‚</span></span><br><span class="line"><span class="comment">* è¿”å›å†™å…¥çš„å¤§å°ï¼Œæˆ–-1ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>read</code> å‡½æ•°ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">read</span> <span class="params">(<span class="type">int</span> __fd, <span class="type">void</span> *__buf, <span class="type">size_t</span> __nbytes)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* __bufï¼šè¯»å–ç¼“å†²åŒºã€‚</span></span><br><span class="line"><span class="comment">* __nbytesï¼šè¯»å–ç¼“å†²åŒºå¤§å°ã€‚</span></span><br><span class="line"><span class="comment">* è¿”å›è¯»å–çš„å¤§å°ï¼Œ-1è¡¨ç¤ºé”™è¯¯ï¼Œ0è¡¨ç¤ºEOFã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>close</code> å‡½æ•°ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">close</span> <span class="params">(<span class="type">int</span> __fd)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* __fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day2">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day2">Gitee</a></p>
<h2 id="ä¸‰-é«˜å¹¶å‘ä½¿ç”¨epoll">ä¸‰ã€é«˜å¹¶å‘ä½¿ç”¨epoll</h2>
<p>ä¹‹å‰åªå†™äº†ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ï¼Œåªèƒ½åŒæ—¶å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ã€‚äº‹å®ä¸Šï¼Œæ‰€æœ‰çš„æœåŠ¡éƒ½æ˜¯é«˜å¹¶å‘çš„ï¼Œå¯ä»¥åŒæ—¶ä¸ºæˆåƒä¸Šä¸‡ä¸ªå®¢æˆ·ç«¯æä¾›æœåŠ¡â€”â€”IOå¤ç”¨ã€‚</p>
<ul>
<li>IO å¤ç”¨å’Œå¤šçº¿ç¨‹ç›¸ä¼¼ï¼Œä½†ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µã€‚
<ul>
<li>IO å¤ç”¨é’ˆå¯¹ IO æ¥å£ï¼›</li>
<li>å¤šçº¿ç¨‹é’ˆå¯¹ CPUã€‚</li>
</ul>
</li>
</ul>
<p>IO å¤ç”¨çš„åŸºæœ¬æ€æƒ³æ˜¯äº‹ä»¶é©±åŠ¨ï¼ŒæœåŠ¡å™¨åŒæ—¶ä¿æŒå¤šä¸ªå®¢æˆ·ç«¯ IO è¿æ¥ã€‚</p>
<ul>
<li>å½“ IO ä¸Šæœ‰å¯è¯»æˆ–å¯å†™äº‹ä»¶å‘ç”Ÿï¼Œè¡¨ç¤ºè¿™ä¸ª IO å¯¹åº”çš„å®¢æˆ·ç«¯åœ¨è¯·æ±‚æœåŠ¡å™¨çš„æœåŠ¡ï¼ŒæœåŠ¡å™¨åº”å½“å“åº”ã€‚</li>
<li>Linux ä¸­ï¼Œ IO å¤ç”¨ä½¿ç”¨ selectã€poll å’Œ epoll æ¥å®ç°ã€‚
<ul>
<li>epoll ç›¸æ¯” selectã€pollï¼Œè¡¨ç°æ€§èƒ½æ›´å¥½ï¼Œæ›´åŠ é«˜æ•ˆã€‚</li>
</ul>
</li>
</ul>
<h3 id="3-1-ä»select-pollåˆ°epoll">3.1 ä»selectã€pollåˆ°epoll</h3>
<blockquote>
<p>ä»å®ç°åŸç†ä¸Šæ¥è¯´ï¼Œselect å’Œ poll é‡‡ç”¨çš„éƒ½æ˜¯è½®è¯¢çš„æ–¹å¼ï¼Œå³æ¯æ¬¡è°ƒç”¨éƒ½è¦æ‰«ææ•´ä¸ªæ³¨å†Œæ–‡ä»¶æè¿°ç¬¦é›†åˆï¼Œå¹¶å°†å…¶ä¸­å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦è¿”å›ç»™ç”¨æˆ·ç¨‹åºï¼Œå› æ­¤å®ƒä»¬æ£€æµ‹å°±ç»ªäº‹ä»¶çš„ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span></span>ã€‚epoll_wait åˆ™ä¸åŒï¼Œå®ƒé‡‡ç”¨çš„æ˜¯å›è°ƒçš„æ–¹å¼ã€‚å†…æ ¸æ£€æµ‹åˆ°å°±ç»ªçš„æ–‡ä»¶æè¿°ç¬¦æ—¶ï¼Œå°†è§¦å‘å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å°±å°†è¯¥æ–‡ä»¶æè¿°ç¬¦ä¸Šå¯¹åº”çš„äº‹ä»¶æ’äººå†…æ ¸å°±ç»ªäº‹ä»¶é˜Ÿåˆ—ã€‚å†…æ ¸æœ€ååœ¨é€‚å½“çš„æ—¶æœºå°†è¯¥å°±ç»ªäº‹ä»¶é˜Ÿåˆ—ä¸­çš„å†…å®¹æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚å› æ­¤ epoll_wait æ— é¡»è½®è¯¢æ•´ä¸ªæ–‡ä»¶æè¿°ç¬¦é›†åˆæ¥æ£€æµ‹å“ªäº›äº‹ä»¶å·²ç»å°±ç»ªï¼Œå…¶ç®—æ³•æ—¶é—´å¤æ‚åº¦æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathdefault" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span>ã€‚è¯¦è§ã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹-æ¸¸åŒï¼Œç¬¬9ç« ã€‹</p>
</blockquote>
<ul>
<li>å½“æ´»åŠ¨è¿æ¥æ¯”è¾ƒå¤šçš„æ—¶å€™ï¼Œepoll_wait çš„æ•ˆç‡æœªå¿…æ¯” select å’Œ poll é«˜ï¼Œå› ä¸ºæ­¤æ—¶å›è°ƒå‡½æ•°è¢«è§¦å‘å¾—è¿‡äºé¢‘ç¹ã€‚æ‰€ä»¥ epoll_wait é€‚ç”¨äºè¿æ¥æ•°é‡å¤šï¼Œä½†æ´»åŠ¨è¿æ¥è¾ƒå°‘çš„æƒ…å†µã€‚</li>
</ul>
<p>epoll æ˜¯ Linux ç‰¹æœ‰çš„ IO å¤ç”¨å‡½æ•°ã€‚</p>
<ul>
<li>ä½¿ç”¨ä¸€ç»„å‡½æ•°å®Œæˆä»»åŠ¡ã€‚</li>
<li>æŠŠç”¨æˆ·å…³å¿ƒçš„æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶æ”¾åˆ°å†…æ ¸çš„ä¸€ä¸ªäº‹ä»¶è¡¨ä¸­ã€‚
<ul>
<li>è€Œä¸åƒ select å’Œ poll é‚£æ ·æ¯æ¬¡è°ƒç”¨éƒ½é‡å¤ä¼ å…¥æ–‡ä»¶æè¿°ç¬¦æˆ–äº‹ä»¶é›†ã€‚</li>
</ul>
</li>
<li>éœ€è¦é¢å¤–çš„æ–‡ä»¶æè¿°ç¬¦æ¥æ ‡è¯†å†…æ ¸ä¸­çš„äº‹ä»¶è¡¨ã€‚</li>
</ul>
<p>åˆ›å»ºæ–‡ä»¶æè¿°ç¬¦ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_create</span><span class="params">(<span class="type">int</span> size)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* sizeï¼šå†…æ ¸äº‹ä»¶è¡¨å¤§å°ã€‚</span></span><br><span class="line"><span class="comment">* è¿”å›æ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨ä½œå…¶ä»–æ‰€æœ‰ epoll ç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼ŒæŒ‡å®šè®¿é—®çš„å†…æ ¸äº‹ä»¶è¡¨ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ“ä½œ epoll çš„å†…æ ¸äº‹ä»¶è¡¨ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_ctl</span><span class="params">(<span class="type">int</span> epfd, <span class="type">int</span> op, <span class="type">int</span> fd, <span class="keyword">struct</span> epoll_event *event)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* epfdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* opï¼šæ“ä½œç±»å‹ã€‚æœ‰ EPOLL_CTL_ADDï¼ˆå¾€äº‹ä»¶è¡¨ä¸­æ³¨å†Œ fd ä¸Šçš„äº‹ä»¶ï¼‰ã€ </span></span><br><span class="line"><span class="comment">* 				EPOLL_CTL_DELï¼ˆä¿®æ”¹ fd ä¸Šçš„æ³¨å†Œäº‹ä»¶ï¼‰ã€</span></span><br><span class="line"><span class="comment">* 				EPOLL_CTL_MODï¼ˆåˆ é™¤ fd ä¸Šçš„æ³¨å†Œäº‹ä»¶ï¼‰ ä¸‰ç§ã€‚</span></span><br><span class="line"><span class="comment">* fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* eventï¼šæŒ‡å®šäº‹ä»¶ï¼Œæ˜¯ epoll_event ç»“æ„ä½“æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="comment">* è¿”å›å€¼ï¼šæˆåŠŸè¿”å› 0ï¼Œå¤±è´¥è¿”å› -1 å¹¶è®¾ç½®é”™è¯¯ç ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<p>è€Œå…³äº <code>epoll_event</code> ç»“æ„ä½“çš„å®šä¹‰ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">__uint32_t</span> events;	<span class="comment">/*epolläº‹ä»¶*/</span></span><br><span class="line">	<span class="type">epoll_data_t</span> data;	<span class="comment">/*ç”¨æˆ·æ•°æ®*/</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">epoll_data</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">void</span> *ptr;		<span class="comment">// æŒ‡å®šä¸fdç›¸å…³çš„ç”¨æˆ·æ•°æ®</span></span><br><span class="line">	<span class="type">int</span> fd;			<span class="comment">// æŒ‡å®šäº‹ä»¶æ‰€ä»å±çš„ç›®æ ‡æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">	<span class="type">uint32_t</span> u32;</span><br><span class="line">	<span class="type">uint64_t</span> u64;</span><br><span class="line">} <span class="type">epoll_data_t</span>;</span><br></pre></td></tr></tbody></table></figure>
<p>epoll ç³»åˆ—ç³»ç»Ÿè°ƒç”¨çš„ä¸»è¦æ¥å£æ˜¯ <code>epoll_wait</code> å‡½æ•°ï¼Œå®ƒåœ¨ä¸€æ®µè¶…æ—¶æ—¶é—´å†…ç­‰å¾…ä¸€ç»„æ–‡ä»¶æè¿°ç¬¦ä¸Šçš„äº‹ä»¶ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">epoll_wait</span><span class="params">(<span class="type">int</span> epfd, <span class="keyword">struct</span> epoll_event *events, <span class="type">int</span> maxevents, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* è¯¥å‡½æ•°å¦‚æœæ£€æµ‹åˆ°äº‹ä»¶ï¼Œå°±å°†æ‰€æœ‰å°±ç»ªçš„äº‹ä»¶ä»å†…æ ¸äº‹ä»¶è¡¨ï¼ˆepfdæŒ‡å®šï¼‰ä¸­å¤åˆ¶åˆ°eventsä¸­ã€‚</span></span><br><span class="line"><span class="comment">* epfdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚</span></span><br><span class="line"><span class="comment">* eventsï¼šäº‹ä»¶æ•°ç»„ã€‚</span></span><br><span class="line"><span class="comment">* maxeventsï¼šç›‘å¬äº‹ä»¶æ•°ç»„å¤§å°ã€‚</span></span><br><span class="line"><span class="comment">* timeoutï¼šè¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚</span></span><br><span class="line"><span class="comment">* è¿”å›å€¼ï¼šæˆåŠŸè¿”å›å°±ç»ªäº‹ä»¶ä¸ªæ•°ï¼Œå¤±è´¥è¿”å› -1 å¹¶è®¾ç½®é”™è¯¯ç ã€‚</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></tbody></table></figure>
<p>epoll å¯¹æ–‡ä»¶æè¿°ç¬¦çš„æ“ä½œæœ‰ä¸¤ç§ï¼š</p>
<ul>
<li>LTï¼ˆLevel Triggerï¼Œç”µå¹³è§¦å‘ï¼‰æ¨¡å¼
<ul>
<li>é»˜è®¤çš„å·¥ä½œæ¨¡å¼ï¼Œç›¸å½“äºæ•ˆç‡è¾ƒé«˜çš„ pollã€‚</li>
<li>å¯¹äºé‡‡ç”¨ LT å·¥ä½œæ¨¡å¼çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“ epoll_wait æ£€æµ‹åˆ°å…¶ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºåï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä¸ç«‹å³å¤„ç†è¯¥äº‹ä»¶ã€‚è¿™æ ·ï¼Œå½“åº”ç”¨ç¨‹åºä¸‹ä¸€æ¬¡è°ƒç”¨ epoll,_wait æ—¶ï¼Œepoll_wait è¿˜ä¼šå†æ¬¡å‘åº”ç”¨ç¨‹åºé€šå‘Šæ­¤äº‹ä»¶ï¼Œç›´åˆ°è¯¥äº‹ä»¶è¢«å¤„ç†ã€‚</li>
</ul>
</li>
<li>ETï¼ˆEdge Triggerï¼Œè¾¹æ²¿è§¦å‘ï¼‰æ¨¡å¼
<ul>
<li>å¯¹äºé‡‡ç”¨ETå·¥ä½œæ¨¡å¼çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå½“ epoll_wait æ£€æµ‹åˆ°å…¶ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿå¹¶å°†æ­¤äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºåï¼Œåº”ç”¨ç¨‹åºå¿…é¡»ç«‹å³å¤„ç†è¯¥äº‹ä»¶ï¼Œå› ä¸ºåç»­çš„epoll_wait è°ƒç”¨å°†ä¸å†å‘åº”ç”¨ç¨‹åºé€šçŸ¥è¿™ä¸€äº‹ä»¶ã€‚å¯è§ï¼ŒET æ¨¡å¼åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šé™ä½äº†åŒä¸€ä¸ª epoll äº‹ä»¶è¢«é‡å¤è§¦å‘çš„æ¬¡æ•°ï¼Œå› æ­¤æ•ˆç‡è¦æ¯” LT æ¨¡å¼é«˜ã€‚</li>
<li>ET æ¨¡å¼å¿…é¡»æ­é…éé˜»å¡å¼ socket ä½¿ç”¨ã€‚</li>
</ul>
</li>
</ul>
<p>epoll çš„äº‹ä»¶æœ‰ï¼š</p>
<ul>
<li><code>EPOLLIN</code>ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯è¯»ï¼ˆåŒ…æ‹¬å¯¹ç«¯ socket æ­£å¸¸å…³é—­ï¼‰ï¼›</li>
<li><code>EPOLLOUT</code>ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¯å†™ï¼›</li>
<li><code>EPOLLPRI</code>ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦æœ‰ç´§æ€¥çš„æ•°æ®å¯è¯»ï¼ˆè¡¨ç¤ºæœ‰å¸¦å¤–æ•°æ®åˆ°æ¥ï¼‰ï¼›</li>
<li><code>EPOLLERR</code>ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ï¼›</li>
<li><code>EPOLLHUP</code>ï¼šè¡¨ç¤ºå¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ï¼›</li>
<li><code>EPOLLET</code>ï¼šå°† epoll è®¾ä¸ºè¾¹ç¼˜è§¦å‘æ¨¡å¼ã€‚</li>
<li><code>EPOLLONESHOT</code>ï¼šåªç›‘å¬ä¸€æ¬¡äº‹ä»¶ï¼Œå½“ç›‘å¬å®Œäº‹ä»¶åï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç›‘å¬è¿™ä¸ª socket çš„æƒ…å†µä¸‹ï¼Œéœ€è¦å†æ¬¡æŠŠè¿™ä¸ª socket åŠ åˆ° epoll é˜Ÿåˆ—é‡Œã€‚</li>
</ul>
<h3 id="3-2-å°†æœåŠ¡å™¨æ”¹å†™æˆepollç‰ˆæœ¬">3.2 å°†æœåŠ¡å™¨æ”¹å†™æˆepollç‰ˆæœ¬</h3>
<p>åœ¨åˆ›å»ºäº†æœåŠ¡å™¨ socket fd åï¼Œå°†è¿™ä¸ª fd æ·»åŠ åˆ° epollã€‚</p>
<ul>
<li>epoll ç›‘å¬äº‹ä»¶çš„æè¿°ç¬¦ä¼šæ”¾åœ¨ä¸€æ£µçº¢é»‘æ ‘ä¸Šï¼Œå°†è¦ç›‘å¬çš„ IO å£æ”¾å…¥ epoll çº¢é»‘æ ‘ä¸­ï¼Œå°±å¯ä»¥ç›‘å¬è¯¥ IO ä¸Šçš„äº‹ä»¶ã€‚</li>
<li>åªè¦è¿™ä¸ª fd ä¸Šå‘ç”Ÿå¯è¯»äº‹ä»¶ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
<li>ç„¶å accept è¿™ä¸ªå®¢æˆ·ç«¯å¹¶å°†å®¢æˆ·ç«¯çš„ socket fd æ·»åŠ åˆ° epollï¼Œepoll ä¼šç›‘å¬å®¢æˆ·ç«¯ socket fd æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¦‚æœå‘ç”Ÿåˆ™å¤„ç†äº‹ä»¶ã€‚</li>
</ul>
<p>æ‰€ä»¥æœåŠ¡å™¨å¤§æ¦‚çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p>
<ol>
<li>åˆ›å»º epollï¼ŒåŒæ—¶å®šä¹‰äº‹ä»¶æ•°ç»„ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»º epoll</span></span><br><span class="line"><span class="type">int</span> epfd = <span class="built_in">epoll_create1</span>(<span class="number">0</span>);</span><br><span class="line"><span class="built_in">errorif</span>(epfd == <span class="number">-1</span>, <span class="string">"epoll create error"</span>);</span><br><span class="line"><span class="comment">// å®šä¹‰äº‹ä»¶æ•°ç»„</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span> events[MAX_EVENTS], ev;</span><br><span class="line"><span class="built_in">bzero</span>(&amp;events, <span class="built_in">sizeof</span>(events));</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>å°†è¦ç›‘å¬çš„ IO å£æ”¾å…¥ epoll ä¸­ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ev.data.fd = sockfd;			<span class="comment">// è¯¥ IO å£ä¸ºæœåŠ¡å™¨ socket fd</span></span><br><span class="line">ev.events = EPOLLIN;			<span class="comment">// å¯è¯»</span></span><br><span class="line"><span class="built_in">setnonblocking</span>(sockfd);			<span class="comment">// è®¾ç½® sockfd ä¸ºéé˜»å¡</span></span><br><span class="line"><span class="comment">// å°†æœåŠ¡å™¨ socket fd æ³¨å†Œåˆ° epoll</span></span><br><span class="line"><span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, sockfd, &amp;ev);</span><br></pre></td></tr></tbody></table></figure>
<ol start="3">
<li>
<p>ä¸æ–­ç›‘å¬ epoll ä¸Šçš„äº‹ä»¶å¹¶å¤„ç†ã€‚</p>
</li>
<li>
<p>å¦‚æœç›‘å¬å‘ç”Ÿçš„äº‹ä»¶æ˜¯æœåŠ¡å™¨ socket fd ä¸Šçš„äº‹ä»¶ï¼Œè¡¨ç¤ºæœ‰ä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯è¿æ¥ã€‚</p>
</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (events[i].data.fd == sockfd)</span><br><span class="line">{</span><br><span class="line">	<span class="comment">// æ¥æ”¶å®¢æˆ·ç«¯ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ–°å¢ç›‘å¬</span></span><br><span class="line">	<span class="built_in">bzero</span>(&amp;ev, <span class="built_in">sizeof</span>(ev));</span><br><span class="line">	ev.data.fd = clientfd;			<span class="comment">// è¯¥ IO å£ä¸ºå®¢æˆ·ç«¯ socket fd</span></span><br><span class="line">	ev.events = EPOLLIN | EPOLLET;	<span class="comment">// å®¢æˆ·ç«¯è¿æ¥ä½¿ç”¨ ET æ¨¡å¼</span></span><br><span class="line">	<span class="built_in">setnonblocking</span>(clientfd);		<span class="comment">// ET éœ€è¦æ­é…éé˜»å¡å¼ socket ä½¿ç”¨</span></span><br><span class="line">	<span class="comment">// å°†å®¢æˆ·ç«¯ socket fd æ³¨å†Œåˆ° epoll</span></span><br><span class="line">	<span class="built_in">epoll_ctl</span>(epfd, EPOLL_CTL_ADD, clientfd, &amp;ev);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ol start="5">
<li>å¦‚æœç›‘å¬å‘ç”Ÿçš„äº‹ä»¶æ˜¯å®¢æˆ·ç«¯ï¼Œå¹¶ä¸”æ˜¯å¯è¯»äº‹ä»¶ï¼Œè¡¨ç¤ºæœ‰å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (events[i].events &amp; EPOLLIN)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)	<span class="comment">// éé˜»å¡ IOï¼Œéœ€è¦ä¸æ–­è¯»å–ï¼Œç›´è‡³å®Œæ¯•</span></span><br><span class="line">	{</span><br><span class="line">		<span class="type">ssize_t</span> bytesRead = <span class="built_in">read</span>(events[i].data.fd, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// æ­£å¸¸è¯»å–æ•°æ®</span></span><br><span class="line">		<span class="keyword">if</span> (bytesRead &gt; <span class="number">0</span>)</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// å®¢æˆ·ç«¯æ­£å¸¸ä¸­æ–­ï¼Œç»§ç»­è¯»å–</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (bytesRead == <span class="number">-1</span> <span class="keyword">and</span> errno == EINTR)</span><br><span class="line">			<span class="comment">//...</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">// éé˜»å¡ IOï¼Œè¿™ä¸ªæ¡ä»¶è¡¨ç¤ºæ•°æ®å…¨éƒ¨è¯»å–å®Œæ¯•</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (bytesRead == <span class="number">-1</span> <span class="built_in">and</span> ((errno == EAGAIN) <span class="built_in">or</span> (errno == EWOULDBLOCK)))</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// EOF äº‹ä»¶ï¼Œä¸€èˆ¬è¡¨ç¤ºå®¢æˆ·ç«¯æ–­å¼€è¿æ¥</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (bytesRead == <span class="number">0</span>)</span><br><span class="line">			<span class="comment">// ...</span></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day3">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day3">Gitee</a></p>
<h2 id="å››-å°è£…æˆç±»-ç¨‹åºæ¨¡å—åŒ–">å››ã€å°è£…æˆç±»ï¼Œç¨‹åºæ¨¡å—åŒ–</h2>
<h3 id="4-1-å°†socketå’Œinetaddresså°è£…æˆç±»">4.1 å°†socketå’ŒInetAddresså°è£…æˆç±»</h3>
<p>å½“æ–°å»ºæœåŠ¡å™¨ socket æ—¶ï¼Œéœ€è¦å®Œæˆç»‘å®š IP åœ°å€ã€ç›‘å¬ã€æ¥å—å®¢æˆ·ç«¯è¿æ¥ç­‰ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡éƒ½å°è£…æˆ <code>Socket</code> ç±»æ¥å®Œæˆã€‚å¸Œæœ›ç®€åŒ–æˆä»¥ä¸‹æ“ä½œï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ–°å»ºæœåŠ¡å™¨ socket</span></span><br><span class="line">Socket *serverSocket = <span class="keyword">new</span> <span class="built_in">Socket</span>();</span><br><span class="line"><span class="comment">// å®ä¾‹åŒ– IP åœ°å€</span></span><br><span class="line">InetAddress *serverAddr = <span class="keyword">new</span> <span class="built_in">InetAddress</span>(<span class="string">"127.0.0.1"</span>, <span class="number">1234</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç»‘å®š IP åœ°å€</span></span><br><span class="line">serverSocket-&gt;<span class="built_in">bind</span>(serverAddr);</span><br><span class="line"><span class="comment">// ç›‘å¬</span></span><br><span class="line">serverSocket-&gt;<span class="built_in">listen</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªå®¢æˆ·ç«¯åœ°å€</span></span><br><span class="line">InetAddress *clientAddr = <span class="keyword">new</span> <span class="built_in">InetAddress</span>();</span><br><span class="line"><span class="comment">// æ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥</span></span><br><span class="line">Socket *clientSocket = <span class="keyword">new</span> <span class="built_in">Socket</span>(serverSocket-&gt;<span class="built_in">accept</span>(clientAddr));</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-2-å°†epollå°è£…æˆç±»">4.2 å°†epollå°è£…æˆç±»</h3>
<p>å¯¹äº epollï¼Œå¸Œæœ›ç®€åŒ–æ“ä½œï¼Œå°è£…æˆç±»åï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®ä¾‹åŒ– epoll</span></span><br><span class="line">Epoll *ep = <span class="keyword">new</span> <span class="built_in">Epoll</span>();</span><br><span class="line"><span class="comment">// å°†è¦ç›‘å¬çš„ IO å£æ”¾å…¥ epoll</span></span><br><span class="line">ep-&gt;<span class="built_in">epoll_add</span>(serverSocket-&gt;<span class="built_in">getFd</span>(), EPOLLIN | EPOLLET);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">true</span>)</span><br><span class="line">{</span><br><span class="line">	std::vector&lt;epoll_event&gt; events = ep-&gt;<span class="built_in">poll</span>();</span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">auto</span> &amp;ev : events)</span><br><span class="line">		<span class="comment">// å¤„ç†äº‹ä»¶</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="4-3-ç›®å½•ç»“æ„åŠæºä»£ç ">4.3 ç›®å½•ç»“æ„åŠæºä»£ç </h3>
<p>ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">client.cpp</span><br><span class="line">server.cpp</span><br><span class="line">util.h</span><br><span class="line">util.cpp</span><br><span class="line">Socket.h</span><br><span class="line">Socket.cpp</span><br><span class="line">InetAddress.h</span><br><span class="line">InetAddress.cpp</span><br><span class="line">Epoll.h</span><br><span class="line">Epoll.cpp</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day4">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day4">Gitee</a></p>
<h2 id="äº”-å‘ç€reactoræ¨¡å¼è½¬å˜">äº”ã€å‘ç€Reactoræ¨¡å¼è½¬å˜</h2>
<h3 id="5-1-reactorå’Œproactor">5.1 Reactorå’ŒProactor</h3>
<blockquote>
<p>Reactor ç¿»è¯‘è¿‡æ¥çš„æ„æ€æ˜¯ã€Œååº”å †ã€ï¼Œè¿™é‡Œçš„ååº”æŒ‡çš„æ˜¯ã€Œå¯¹äº‹ä»¶ååº”ã€ã€‚</p>
<ul>
<li>å½“æ¥äº†ä¸€ä¸ªäº‹ä»¶ï¼ŒReactor å°±æœ‰ç›¸å¯¹åº”çš„ååº”/å“åº”ã€‚</li>
</ul>
<p>äº‹å®ä¸Šï¼ŒReactor æ¨¡å¼ä¹Ÿå« Dispatcher æ¨¡å¼ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªåå­—æ›´è´´åˆè¯¥æ¨¡å¼çš„å«ä¹‰ï¼Œå³ I/O å¤šè·¯å¤ç”¨ç›‘å¬äº‹ä»¶ã€‚</p>
<ul>
<li>æ”¶åˆ°äº‹ä»¶åï¼Œæ ¹æ®äº‹ä»¶ç±»å‹åˆ†é…ï¼ˆDispatchï¼‰ç»™æŸä¸ªè¿›ç¨‹ / çº¿ç¨‹ã€‚</li>
</ul>
<p>Reactor æ¨¡å¼ä¸»è¦ç”± Reactor å’Œå¤„ç†èµ„æºæ± è¿™ä¸¤ä¸ªæ ¸å¿ƒéƒ¨åˆ†ç»„æˆã€‚</p>
<ul>
<li>Reactor è´Ÿè´£ç›‘å¬å’Œåˆ†å‘äº‹ä»¶ï¼Œäº‹ä»¶ç±»å‹åŒ…å«è¿æ¥äº‹ä»¶ã€è¯»å†™äº‹ä»¶ï¼›</li>
<li>å¤„ç†èµ„æºæ± è´Ÿè´£å¤„ç†äº‹ä»¶ï¼Œå¦‚ read -&gt; ä¸šåŠ¡é€»è¾‘ -&gt; sendï¼›</li>
</ul>
<p>Reactor æ¨¡å¼æ˜¯çµæ´»å¤šå˜çš„ï¼Œå¯ä»¥åº”å¯¹ä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œçµæ´»åœ¨äºï¼š</p>
<ul>
<li>Reactor çš„æ•°é‡å¯ä»¥åªæœ‰ä¸€ä¸ªï¼Œä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼›</li>
<li>å¤„ç†èµ„æºæ± å¯ä»¥æ˜¯å•ä¸ªè¿›ç¨‹ / çº¿ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªè¿›ç¨‹ / çº¿ç¨‹ï¼›</li>
</ul>
<p>æœ‰ 3 ä¸ªæ–¹æ¡ˆéƒ½æ˜¯æ¯”è¾ƒç»å…¸çš„ï¼Œä¸”éƒ½æœ‰åº”ç”¨åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼š</p>
<ul>
<li>å• Reactor å•è¿›ç¨‹ / çº¿ç¨‹ï¼›</li>
<li>å• Reactor å¤šçº¿ç¨‹ / è¿›ç¨‹ï¼›</li>
<li>å¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹ï¼›</li>
</ul>
<p>æ–¹æ¡ˆå…·ä½“ä½¿ç”¨è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œè¦çœ‹ä½¿ç”¨çš„ç¼–ç¨‹è¯­è¨€ä»¥åŠå¹³å°æœ‰å…³ï¼š</p>
<ul>
<li>Java è¯­è¨€ä¸€èˆ¬ä½¿ç”¨çº¿ç¨‹ï¼Œæ¯”å¦‚ Nettyï¼›</li>
<li>C è¯­è¨€ä½¿ç”¨è¿›ç¨‹å’Œçº¿ç¨‹éƒ½å¯ä»¥ï¼Œä¾‹å¦‚ Nginx ä½¿ç”¨çš„æ˜¯è¿›ç¨‹ï¼ŒMemcache ä½¿ç”¨çš„æ˜¯çº¿ç¨‹ã€‚</li>
</ul>
<p>Reactor æ˜¯éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å¼ï¼Œæ„ŸçŸ¥çš„æ˜¯å°±ç»ªå¯è¯»å†™äº‹ä»¶ã€‚åœ¨æ¯æ¬¡æ„ŸçŸ¥åˆ°æœ‰äº‹ä»¶å‘ç”Ÿï¼ˆæ¯”å¦‚å¯è¯»å°±ç»ªäº‹ä»¶ï¼‰åï¼Œå°±éœ€è¦åº”ç”¨è¿›ç¨‹ä¸»åŠ¨è°ƒç”¨ read æ–¹æ³•æ¥å®Œæˆæ•°æ®çš„è¯»å–ï¼Œä¹Ÿå°±æ˜¯è¦åº”ç”¨è¿›ç¨‹ä¸»åŠ¨å°† socket æ¥æ”¶ç¼“å­˜ä¸­çš„æ•°æ®è¯»åˆ°åº”ç”¨è¿›ç¨‹å†…å­˜ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯åŒæ­¥çš„ï¼Œè¯»å–å®Œæ•°æ®ååº”ç”¨è¿›ç¨‹æ‰èƒ½å¤„ç†æ•°æ®ã€‚</p>
<p>Proactor æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å¼ï¼Œ æ„ŸçŸ¥çš„æ˜¯å·²å®Œæˆçš„è¯»å†™äº‹ä»¶ã€‚åœ¨å‘èµ·å¼‚æ­¥è¯»å†™è¯·æ±‚æ—¶ï¼Œéœ€è¦ä¼ å…¥æ•°æ®ç¼“å†²åŒºçš„åœ°å€ï¼ˆç”¨æ¥å­˜æ”¾ç»“æœæ•°æ®ï¼‰ç­‰ä¿¡æ¯ï¼Œè¿™æ ·ç³»ç»Ÿå†…æ ¸æ‰å¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬æŠŠæ•°æ®çš„è¯»å†™å·¥ä½œå®Œæˆï¼Œè¿™é‡Œçš„è¯»å†™å·¥ä½œå…¨ç¨‹ç”±æ“ä½œç³»ç»Ÿæ¥åšï¼Œå¹¶ä¸éœ€è¦åƒ Reactor é‚£æ ·è¿˜éœ€è¦åº”ç”¨è¿›ç¨‹ä¸»åŠ¨å‘èµ· read/write æ¥è¯»å†™æ•°æ®ï¼Œæ“ä½œç³»ç»Ÿå®Œæˆè¯»å†™å·¥ä½œåï¼Œå°±ä¼šé€šçŸ¥åº”ç”¨è¿›ç¨‹ç›´æ¥å¤„ç†æ•°æ®ã€‚</p>
<p>å› æ­¤ï¼ŒReactor å¯ä»¥ç†è§£ä¸ºã€Œæ¥äº†äº‹ä»¶æ“ä½œç³»ç»Ÿé€šçŸ¥åº”ç”¨è¿›ç¨‹ï¼Œè®©åº”ç”¨è¿›ç¨‹æ¥å¤„ç†ã€ï¼Œè€Œ Proactor å¯ä»¥ç†è§£ä¸ºã€Œæ¥äº†äº‹ä»¶æ“ä½œç³»ç»Ÿæ¥å¤„ç†ï¼Œå¤„ç†å®Œå†é€šçŸ¥åº”ç”¨è¿›ç¨‹ã€ã€‚è¿™é‡Œçš„ã€Œäº‹ä»¶ã€å°±æ˜¯æœ‰æ–°è¿æ¥ã€æœ‰æ•°æ®å¯è¯»ã€æœ‰æ•°æ®å¯å†™çš„è¿™äº› I/O äº‹ä»¶è¿™é‡Œçš„ã€Œå¤„ç†ã€åŒ…å«ä»é©±åŠ¨è¯»å–åˆ°å†…æ ¸ä»¥åŠä»å†…æ ¸è¯»å–åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>
<p>ä½œè€…ï¼šå°æ—coding<br>
é“¾æ¥ï¼š<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/26943938/answer/1856426252">https://www.zhihu.com/question/26943938/answer/1856426252</a><br>
æ¥æºï¼šçŸ¥ä¹è‘—ä½œæƒå½’ä½œè€…æ‰€æœ‰ã€‚</p>
</blockquote>
<p><em>è¯¦ç»†è¯·å‚è€ƒæ¸¸åŒã€ŠLinuxé«˜æ€§èƒ½æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬å…«ç« ç¬¬å››èŠ‚ã€é™ˆç¡•ã€ŠLinuxå¤šçº¿ç¨‹æœåŠ¡å™¨ç¼–ç¨‹ã€‹ç¬¬å…­ç« ç¬¬å…­èŠ‚ã€‚</em></p>
<p>æ¥ä¸‹æ¥è¦å°†æœåŠ¡å™¨å‘ç€ Reactor æ¨¡å¼è½¬å˜ï¼š</p>
<ol>
<li>é¦–å…ˆå°†æ•´ä¸ªæœåŠ¡å™¨æŠ½è±¡æˆä¸€ä¸ª Server ç±»ï¼Œè¿™ä¸ªç±»ä¸­æœ‰ä¸€ä¸ª main-Reactorï¼Œé‡Œé¢çš„æ ¸å¿ƒæ˜¯ä¸€ä¸ª EventLoopï¼Œè¿™æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼›</li>
<li>æ·»åŠ éœ€è¦ç›‘å¬çš„äº‹åŠ¡åˆ°è¿™ä¸ªäº‹ä»¶å¾ªç¯å†…ï¼Œæ¯æ¬¡æœ‰äº‹ä»¶å‘ç”Ÿæ—¶å°±ä¼šé€šçŸ¥ï¼Œåœ¨ç¨‹åºä¸­è¿”å›ç»™ Channelï¼ˆè‡ªå°è£…çš„ç±»ï¼‰ï¼Œç„¶åæ ¹æ®ä¸åŒçš„æè¿°ç¬¦ã€äº‹ä»¶ç±»å‹ä»¥å›è°ƒå‡½æ•°çš„æ–¹å¼è¿›è¡Œå¤„ç†ã€‚</li>
</ol>
<h3 id="5-2-åŠ å…¥channelç±»">5.2 åŠ å…¥Channelç±»</h3>
<p>é¢å¯¹æœåŠ¡å™¨è®¸å¤šæœåŠ¡æ—¶ï¼Œä¸åŒçš„è¿æ¥ç±»å‹ä¹Ÿå°†å†³å®šä¸åŒçš„å¤„ç†é€»è¾‘ï¼Œä»…ä»…é€šè¿‡ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦æ¥åŒºåˆ†æ˜¾ç„¶ä¼šå¾ˆéº»çƒ¦ã€‚å¸Œæœ›å¾—åˆ°æ–‡ä»¶æè¿°ç¬¦çš„æ›´å¤šæ¶ˆæ¯ã€‚</p>
<ul>
<li>epoll çš„ <code>epoll_event</code> ç»“æ„ä½“ä¸­ï¼Œ<code>data</code> å­—æ®µå¯ä»¥æ”¾ä¸€ä¸ª <code>void *</code> ç±»å‹çš„æŒ‡é’ˆï¼Œç”¨æ¥ä¿å­˜æ›´å¤šä¿¡æ¯ã€‚</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> <span class="title class_">epoll_data</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">void</span> *ptr;</span><br><span class="line">  <span class="type">int</span> fd;</span><br><span class="line">  <span class="type">uint32_t</span> u32;</span><br><span class="line">  <span class="type">uint64_t</span> u64;</span><br><span class="line">} <span class="type">epoll_data_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">epoll_event</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">uint32_t</span> events;		<span class="comment">/* Epoll events */</span></span><br><span class="line">  <span class="type">epoll_data_t</span> data;	<span class="comment">/* User data variable */</span></span><br><span class="line">} __EPOLL_PACKED;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>epoll ä¸­çš„ <code>data</code> æ˜¯ä¸€ä¸ªè”åˆç±»å‹ï¼š
<ul>
<li>å¯ä»¥å­˜å‚¨ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä»»ä½•ä¸€ä¸ªåœ°å€å—çš„å†…å®¹ï¼›</li>
<li>å¯ä»¥æ˜¯ä¸€ä¸ªç±»çš„å¯¹è±¡ï¼Œå°±æ­¤å°†ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦å°è£…æˆä¸€ä¸ª <code>Channel</code> ç±»ï¼Œä¸€ä¸ª <code>Channel</code> ç±»å§‹ç»ˆè´Ÿè´£ä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å¯¹ä¸åŒçš„æœåŠ¡ã€ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼Œéƒ½å¯ä»¥åœ¨ç±»ä¸­è¿›è¡Œå¤„ç†ã€‚</li>
</ul>
</li>
</ul>
<p>è®¾è®¡ <code>Channel</code> ç±»ï¼Œæ ¸å¿ƒæˆå‘˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Channel</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	EventLoop *loop;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">uint32_t</span> events;</span><br><span class="line">	<span class="type">uint32_t</span> revents;</span><br><span class="line">	<span class="type">bool</span> isEpoll;</span><br><span class="line">	std::function&lt;<span class="type">void</span>()&gt; callback;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>loop</code>ï¼šæŒ‡å‘ä¸ä¹‹å…³è”çš„äº‹ä»¶å¾ªç¯çš„æŒ‡é’ˆã€‚</li>
<li><code>fd</code>ï¼šChannel è´Ÿè´£çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
<li><code>events</code>ï¼šè¡¨ç¤ºå¸Œæœ›ç›‘å¬è¿™ä¸ªæ–‡ä»¶æè¿°ç¬¦çš„å“ªäº›äº‹ä»¶ã€‚</li>
<li><code>revents</code>ï¼šè¡¨ç¤ºåœ¨ <code>epoll</code> è¿”å›è¯¥ <code>Channel</code> æ—¶æ–‡ä»¶æè¿°ç¬¦æ­£åœ¨å‘ç”Ÿçš„äº‹ä»¶ã€‚</li>
<li><code>isEpoll</code>ï¼šè¡¨ç¤ºå½“å‰ <code>Channel</code> æ˜¯å¦å·²ç»æ·»åŠ åˆ° <code>epoll</code> çº¢é»‘æ ‘ä¸­ï¼ŒåŒºåˆ†ä½¿ç”¨ <code>EPOLL_CTL_ADD</code> è¿˜æ˜¯ <code>EPOLL_CTL_MOD</code>ã€‚</li>
<li><code>callback</code>ï¼šå‘ç”Ÿäº‹ä»¶æ—¶æ‰§è¡Œçš„å›è°ƒå‡½æ•°ã€‚</li>
</ul>
<p>æ·»åŠ  Channel ç±»å¯ä»¥æ›´åŠ æ–¹ä¾¿ç®€å•ã€å¤šæ ·åŒ–åœ°å¤„ç† epoll ä¸­å‘ç”Ÿçš„äº‹ä»¶ã€‚åŒæ—¶è„±ç¦»äº†åº•å±‚ï¼Œå°† epollã€æ–‡ä»¶æè¿°ç¬¦å’Œäº‹ä»¶è¿›è¡Œäº†æŠ½è±¡ï¼Œå½¢æˆäº†äº‹ä»¶åˆ†å‘çš„æ¨¡å‹ï¼Œè¿™ä¹Ÿæ˜¯ Reactor æ¨¡å¼çš„æ ¸å¿ƒã€‚</p>
<h3 id="5-3-åŠ å…¥eventloopç±»">5.3 åŠ å…¥EventLoopç±»</h3>
<p>EventLoop ç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventLoop</span> {</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Epoll *ep;</span><br><span class="line">    <span class="type">bool</span> quit;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">EventLoop</span>();</span><br><span class="line">    ~<span class="built_in">EventLoop</span>();</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">updateChannel</span><span class="params">(Channel*)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>ep</code>ï¼šæŒ‡å‘Epollç±»å®ä¾‹çš„æŒ‡é’ˆï¼›</li>
<li><code>quit</code>ï¼šæŒ‡ç¤ºç¨‹åºæ˜¯å¦åº”è¯¥é€€å‡ºï¼›</li>
<li><code>loop()</code>ï¼šäº‹ä»¶å¾ªç¯å‡½æ•°ï¼Œè°ƒç”¨å¼€å§‹äº‹ä»¶é©±åŠ¨ï¼Œå³åŸæ¥è°ƒç”¨ <code>epoll_wait</code> å‡½æ•°çš„æ­»å¾ªç¯ï¼›</li>
<li><code>updateChannel()</code>ï¼šæ›´æ–° Channelã€‚</li>
</ul>
<p>å°†éœ€è¦ç›‘å¬çš„äº‹åŠ¡åŠ å…¥åˆ°äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯æ¬¡æœ‰äº‹ä»¶å‘ç”Ÿå°±ä¼šé€šçŸ¥ï¼Œè¿”å›åˆ° Channelï¼Œç„¶åæ ¹æ®ä¸åŒçš„æè¿°ç¬¦ã€äº‹ä»¶ç±»å‹ä»¥å›è°ƒå‡½æ•°æ–¹å¼è¿›è¡Œå¤„ç†ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="keyword">while</span> (!quit)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">// ä½¿ç”¨epollå®ä¾‹è½®è¯¢äº‹ä»¶</span></span><br><span class="line">		std::vector&lt;Channel *&gt; channels = ep-&gt;<span class="built_in">poll</span>();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// å¤„ç†æ¯ä¸ªChannelçš„äº‹ä»¶</span></span><br><span class="line">		<span class="keyword">for</span> (Channel *channel : channels)</span><br><span class="line">			channel-&gt;<span class="built_in">handleEvent</span>();</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="5-4-åŠ å…¥serverç±»">5.4 åŠ å…¥Serverç±»</h3>
<p>æœåŠ¡å™¨ç±» <code>Server</code> çš„æ ¸å¿ƒæˆå‘˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    EventLoop *loop;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Server</span>(EventLoop*);</span><br><span class="line">    ~<span class="built_in">Server</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">handleReadEvent</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">newConnection</span><span class="params">(Socket *serv_sock)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>loop</code>ï¼šäº‹ä»¶å¾ªç¯å¯¹è±¡ã€‚</li>
<li><code>handleReadEvent()</code>ï¼šå¤„ç†è¯»äº‹ä»¶ã€‚</li>
<li><code>newConnection()</code>ï¼šå¤„ç†æ–°è¿æ¥ã€‚</li>
</ul>
<p>ä¹‹åå¯åŠ¨æœåŠ¡å™¨çš„æ“ä½œæŠ½è±¡ä¸ºï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EventLoop *loop = <span class="keyword">new</span> <span class="built_in">EventLoop</span>();</span><br><span class="line">Server *server = <span class="keyword">new</span> <span class="built_in">Server</span>(loop);</span><br><span class="line">loop-&gt;<span class="built_in">loop</span>();</span><br></pre></td></tr></tbody></table></figure>
<p>è¿™ä¸ªç‰ˆæœ¬æœåŠ¡å™¨å†…åªæœ‰ä¸€ä¸ª <code>EventLoop</code>ï¼Œå½“å…¶ä¸­æœ‰å¯è¯»äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¯ä»¥æ‹¿åˆ°è¯¥æè¿°ç¬¦å¯¹åº”çš„ <code>Channel</code>ã€‚</p>
<p>åœ¨æ–°å»º Channel æ—¶ï¼Œæ ¹æ® Channel æè¿°ç¬¦çš„ä¸åŒåˆ†åˆ«ç»‘å®šäº†ä¸¤ä¸ªå›è°ƒå‡½æ•°ï¼š</p>
<ul>
<li><code>newConnection()</code> å‡½æ•°è¢«ç»‘å®šåˆ°æœåŠ¡å™¨socketä¸Šï¼›
<ul>
<li>å¦‚æœæœåŠ¡å™¨ socket æœ‰å¯è¯»äº‹ä»¶ï¼ŒChannel é‡Œçš„ <code>handleEvent()</code> å‡½æ•°å®é™…ä¸Šä¼šè°ƒç”¨ Server ç±»çš„ <code>newConnection()</code> æ–°å»ºè¿æ¥ã€‚</li>
</ul>
</li>
<li><code>handlrReadEvent()</code> è¢«ç»‘å®šåˆ°æ–°æ¥å—çš„å®¢æˆ·ç«¯socketä¸Šã€‚
<ul>
<li>å¦‚æœå®¢æˆ·ç«¯ socket æœ‰å¯è¯»äº‹ä»¶ï¼ŒChannel é‡Œçš„ <code>handleEvent()</code> å‡½æ•°å®é™…ä¸Šä¼šè°ƒç”¨ Server ç±»çš„ <code>handleReadEvent()</code> å“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li>
</ul>
</li>
</ul>
<p>è‡³æ­¤ï¼Œæ ¹æ®æŠ½è±¡å‡ºçš„ <code>EventLoop</code> å’Œ <code>Channel</code>ï¼Œæ„æˆäº†äº‹ä»¶é©±åŠ¨æ¨¡å‹ã€‚è¿™ä¸¤ä¸ªç±»å’ŒæœåŠ¡å™¨æ ¸å¿ƒ <code>Server</code> å·²ç»æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œç»è¿‡å®Œå–„åå¯ä»¥è¢«ä»»ä½•ç¨‹åºå¤ç”¨ï¼Œè¾¾åˆ°äº†äº‹ä»¶é©±åŠ¨çš„è®¾è®¡æ€æƒ³ï¼Œç°åœ¨çš„æœåŠ¡å™¨ä¹Ÿå¯ä»¥çœ‹æˆä¸€ä¸ªæœ€ç®€æ˜“çš„ Reactor æ¨¡å¼æœåŠ¡å™¨ã€‚</p>
<p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç›®å‰è¯¥æœåŠ¡å™¨çš„å†…å­˜ç®¡ç†ä¸€å¡Œç³Šæ¶‚ã€‚</em></p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day5">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day5">Gitee</a></p>
<h2 id="å…­-æŠŠæœåŠ¡å™¨çš„æ¥å—æŠ½è±¡åŒ–">å…­ã€æŠŠæœåŠ¡å™¨çš„æ¥å—æŠ½è±¡åŒ–</h2>
<h3 id="6-1-æŠ½è±¡åŒ–æ¥å—">6.1 æŠ½è±¡åŒ–æ¥å—</h3>
<p>æœåŠ¡å™¨ä¸­ï¼Œå¯¹äºæ¯ä¸€ä¸ªäº‹ä»¶ï¼Œé¦–å…ˆéƒ½æ˜¯è°ƒç”¨ <code>accept()</code> å‡½æ•°å»æ¥å—ä¸€ä¸ª TCP è¿æ¥ï¼Œç„¶åæŠŠ Socket æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ° epollã€‚å½“è¿™ä¸ª IO å£æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå¯¹è¯¥è¿æ¥æä¾›ç›¸åº”çš„æœåŠ¡ã€‚</p>
<p>åˆ†ç¦»æ¥å—è¿æ¥è¿™ä¸ªåŠŸèƒ½ï¼Œæ·»åŠ  <code>Acceptor</code> ç±»ã€‚</p>
<h3 id="6-2-acceptor-ç±»">6.2 Acceptor ç±»</h3>
<p>Acceptor ç±»åº”è¯¥æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç±»ä¸­æœ‰ä¸€ä¸ª Socket fdï¼Œå°±æ˜¯æœåŠ¡å™¨ç›‘å¬çš„ Socket fdï¼Œæ¯ä¸€ä¸ª<br>
Acceptor å¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ª Socket fdã€‚</li>
<li>ç±»å­˜åœ¨äºäº‹ä»¶é©±åŠ¨ <code>EventLoop</code> ç±»ä¸­ã€‚</li>
<li>ç±»ä¹Ÿé€šè¿‡ä¸€ä¸ª <code>Channel</code> è´Ÿè´£åˆ†å‘åˆ° epollï¼Œè¯¥ <code>Channel</code> çš„äº‹ä»¶å¤„ç†å‡½æ•° <code>handleEvent()</code> ä¼šè°ƒç”¨ <code>Acceptor</code> ç±»ä¸­çš„è¿æ¥å‡½æ•°è¿›è¡Œæ–°å»ºä¸€ä¸ª TCP è¿æ¥ã€‚</li>
</ul>
<p>å°†æ–°å»ºè¿æ¥çš„é€»è¾‘å°±åœ¨ Acceptor ç±»ä¸­ã€‚ä½†é€»è¾‘ä¸Šæ–° Socket å»ºç«‹åå°±å’Œä¹‹å‰çš„ç›‘å¬çš„æœåŠ¡å™¨ Socket æ²¡æœ‰ä»»ä½•å…³ç³»äº†ã€‚</p>
<p>æ–°çš„ TCP è¿æ¥åº”è¯¥ç”± Server ç±»æ¥åˆ›å»ºå¹¶ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸æ˜¯ Acceptorã€‚å¹¶ä¸”å°†ä¸€éƒ¨åˆ†ä»£ç æ”¾åœ¨ Server ç±»é‡Œä¹Ÿå¹¶æ²¡æœ‰æ‰“ç ´æœåŠ¡å™¨çš„é€šç”¨æ€§ï¼Œå› ä¸ºå¯¹äºæ‰€æœ‰çš„æœåŠ¡ï¼Œéƒ½è¦ä½¿ç”¨ Acceptor æ¥å»ºç«‹è¿æ¥ã€‚</p>
<ul>
<li><code>Acceptor</code> ç±»çš„æ–°å»ºè¿æ¥åŠŸèƒ½æ˜¯åœ¨ <code>Server</code> ç±»ä¸­å®ç°çš„ã€‚</li>
</ul>
<p>å¯ä»¥ä½¿ç”¨ <code>std::function</code>ã€<code>std::bind</code>ã€å³å€¼å¼•ç”¨ã€<code>std::move</code> ç­‰å®ç°å‡½æ•°å›è°ƒã€‚</p>
<p>å®šä¹‰è¯¥ç±»ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Acceptor</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// ç”¨äºäº‹ä»¶å¤„ç†çš„EventLoopæŒ‡é’ˆ</span></span><br><span class="line">	EventLoop *loop;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”¨äºå¤„ç†å¥—æ¥å­—æ“ä½œçš„å¥—æ¥å­—æŒ‡é’ˆ</span></span><br><span class="line">	Socket *sock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”¨äºå­˜å‚¨åœ°å€ä¿¡æ¯çš„æŒ‡é’ˆ</span></span><br><span class="line">	InetAddress *addr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”¨äºæ¥å—è¿æ¥çš„ Channel æŒ‡é’ˆ</span></span><br><span class="line">	Channel *acceptChannel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// å®šä¹‰ä¸€ä¸ªæ–°å»ºè¿æ¥çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(Socket *)&gt; newConnectionCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Acceptor</span>(EventLoop *_loop);</span><br><span class="line">	~<span class="built_in">Acceptor</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @brief æ¥å—æ–°è¿æ¥</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">acceptConnection</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @brief è®¾ç½®æ–°è¿æ¥çš„å›è°ƒå‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">	 * @param _callback ä¸ºæ–°è¿æ¥è®¾ç½®çš„å›è°ƒå‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setNewConnectionCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(Socket *)&gt; _callback)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>æŠ½è±¡åï¼ŒServerç±»çš„å˜åŒ–å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¹‹å‰</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// æŒ‡å‘EventLoopå¯¹è±¡çš„æŒ‡é’ˆ</span></span><br><span class="line">	EventLoop *loop;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æœåŠ¡å™¨å¥—æ¥å­—</span></span><br><span class="line">	Socket *serverSock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æœåŠ¡å™¨åœ°å€</span></span><br><span class="line">	InetAddress *serverAddr;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æœåŠ¡å™¨é€šé“</span></span><br><span class="line">	Channel *serverChannel;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä¿å­˜å®¢æˆ·ç«¯çš„å¥—æ¥å­—</span></span><br><span class="line">	std::vector&lt;std::pair&lt;Socket *, InetAddress *&gt;&gt; clients;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¹‹å</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// æŒ‡å‘EventLoopå¯¹è±¡çš„æŒ‡é’ˆ</span></span><br><span class="line">	EventLoop *loop;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æŒ‡å‘Acceptorå¯¹è±¡çš„æŒ‡é’ˆ</span></span><br><span class="line">	Acceptor *acceptor;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day6">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day6">Gitee</a></p>
<h2 id="ä¸ƒ-æŠŠtcpè¿æ¥æŠ½è±¡åŒ–">ä¸ƒã€æŠŠTCPè¿æ¥æŠ½è±¡åŒ–</h2>
<h3 id="7-1-æŠ½è±¡åŒ–è¿æ¥">7.1 æŠ½è±¡åŒ–è¿æ¥</h3>
<p>å¯¹äº TCP åè®®ï¼Œåœ¨ä¸‰æ¬¡æ¡æ‰‹æ–°å»ºè¿æ¥åï¼Œè¯¥è¿æ¥å›ä¸€ç›´å­˜åœ¨ç›´è‡³å››æ¬¡æŒ¥æ‰‹æ–­å¼€è¿æ¥ã€‚</p>
<p>é‚£ä¹ˆæŠŠè¿™ä¸ªè¿æ¥ä¹ŸæŠ½è±¡åŒ–ï¼ŒæŠ½è±¡æˆ <code>Connection</code> ç±»ã€‚</p>
<h3 id="7-2-connection-ç±»">7.2 Connection ç±»</h3>
<p>Connection ç±»åº”è¯¥æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p>
<ul>
<li>ç±»å­˜åœ¨äºäº‹ä»¶é©±åŠ¨ç±»ä¸­ï¼›</li>
<li>ç±»çš„ Socket fd å°±æ˜¯å®¢æˆ·ç«¯çš„ Socket fdï¼Œæ¯ä¸€ä¸ª<br>
Connection å¯¹è±¡éƒ½å¯¹åº”ä¸€ä¸ª Socket fdã€‚</li>
<li>ç±»ä¹Ÿé€šè¿‡ä¸€ä¸ª <code>Channel</code> è´Ÿè´£åˆ†å‘åˆ° epollï¼Œè¯¥ <code>Channel</code> çš„äº‹ä»¶å¤„ç†å‡½æ•° <code>handleEvent()</code> ä¼šè°ƒç”¨ <code>Connection</code> ç±»ä¸­çš„äº‹ä»¶å¤„ç†å‡½æ•°è¿›è¡Œå“åº”å®¢æˆ·ç«¯è¯·æ±‚ã€‚</li>
</ul>
<p><code>Connection</code> ç±»ä¸ <code>Acceptor</code> ç±»ååˆ†ç›¸ä¼¼ï¼Œå®ƒä»¬éƒ½ç”± <code>Server</code> ç®¡ç†ï¼Œç”±ä¸€ä¸ª <code>Channel</code> åˆ†å‘åˆ° epollï¼Œé€šè¿‡å›è°ƒå‡½æ•°å¤„ç†å“åº”äº‹ä»¶ã€‚</p>
<p>ä¸€ä¸ªé«˜å¹¶å‘æœåŠ¡å™¨ä¸€èˆ¬åªæœ‰ä¸€ä¸ª <code>Acceptor</code>ï¼ˆå¯ä»¥æœ‰å¤šä¸ªï¼‰ï¼Œä½†ä¼šåŒæ—¶æœ‰æˆåƒä¸Šä¸‡ä¸ª TCP è¿æ¥ï¼Œä¹Ÿå°±æ˜¯ <code>Connection</code> çš„å®ä¾‹ã€‚</p>
<p>å¯¹ <code>Connection</code> ç±»çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	EventLoop *loop;</span><br><span class="line">	Socket *sock;</span><br><span class="line">	Channel *channel;</span><br><span class="line">	std::function&lt;<span class="type">void</span>(Socket *)&gt; deleteConnectionCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Connection</span>(EventLoop *_loop, Socket *_sock);</span><br><span class="line">	~<span class="built_in">Connection</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief å›æ˜¾sockfdå‘æ¥çš„æ•°æ®</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">echo</span><span class="params">(<span class="type">int</span> sockfd)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief è®¾ç½®åˆ é™¤è¿æ¥æ—¶è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setDeleteConnectionCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(Socket *)&gt; _callback)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h3 id="7-3-æ”¹å†™-server-ç±»">7.3 æ”¹å†™ Server ç±»</h3>
<p><code>Server</code> ç±»çš„æ ¸å¿ƒå˜æˆï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// æŒ‡å‘EventLoopå¯¹è±¡çš„æŒ‡é’ˆ</span></span><br><span class="line">	EventLoop *loop;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æŒ‡å‘Acceptorå¯¹è±¡çš„æŒ‡é’ˆ</span></span><br><span class="line">	Acceptor *acceptor;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// å­˜å‚¨è¿æ¥åŠå…¶ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">	std::map&lt;<span class="type">int</span>, Connection *&gt; connections;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Server</span>(EventLoop *_loop);</span><br><span class="line">	~<span class="built_in">Server</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚ï¼Œæš‚æ—¶æ²¡æœ‰</span></span><br><span class="line">	<span class="comment">// void handleReadEvent(int fd);</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief å¤„ç†ä¸æ‰€æä¾›å¥—æ¥å­—çš„æ–°è¿æ¥</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">newConnection</span><span class="params">(Socket *_socket)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief æ–­å¼€ä¸æä¾›çš„å¥—æ¥å­—å…³è”çš„è¿æ¥</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">deleteConnection</span><span class="params">(Socket *_socket)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>é€šè¿‡ <code>Map</code> æ˜ å°„å°†ä¼—å¤šè¿æ¥ä¿å­˜èµ·æ¥ï¼Œé”®ä¸ºè¯¥è¿æ¥å®¢æˆ·ç«¯çš„ <code>socket fd</code>ï¼Œå€¼ä¸ºæŒ‡å‘è¯¥è¿æ¥çš„æŒ‡é’ˆã€‚</li>
<li>è¯¥è¿æ¥å®¢æˆ·ç«¯çš„ <code>socket fd</code> é€šè¿‡ä¸€ä¸ª <code>Channel</code> ç±»åˆ†å‘åˆ° <code>epoll</code>ï¼Œè¯¥ <code>Channel</code> çš„äº‹ä»¶å¤„ç†å›è°ƒå‡½æ•° <code>handleEvent()</code> ç»‘å®šä¸º <code>Connection</code> çš„å¤„ç†å‡½æ•°ï¼Œè¿™æ ·æ¯å½“è¯¥è¿æ¥çš„ <code>socket fd</code> ä¸Šå‘ç”Ÿäº‹ä»¶ï¼Œå°±ä¼šé€šè¿‡ <code>Channel</code> è°ƒç”¨å…·ä½“è¿æ¥ç±»çš„å¤„ç†å‡½æ•°ã€‚</li>
</ul>
<p>æ­¤å¤„å°†æ–°å»ºè¿æ¥çš„åŠŸèƒ½æ”¾å›åˆ° <code>Acceptor</code> ç±»ä¸­ç®¡ç†ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Acceptor::acceptConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// åˆ›å»ºä¸€ä¸ªæ–°çš„InetAddresså¯¹è±¡æ¥å­˜å‚¨å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯</span></span><br><span class="line">	InetAddress *clientAddr = <span class="keyword">new</span> <span class="built_in">InetAddress</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//é€šè¿‡ä½¿ç”¨å®¢æˆ·ç«¯åœ°å€æ¥å—æ¥è‡ªæœåŠ¡å™¨å¥—æ¥å­—çš„è¿æ¥ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„Socketå¯¹è±¡</span></span><br><span class="line">	Socket *clientSock = <span class="keyword">new</span> <span class="built_in">Socket</span>(sock-&gt;<span class="built_in">accept</span>(clientAddr));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// æ‰“å°æœ‰å…³æ–°å®¢æˆ·ç«¯è¿æ¥çš„ä¿¡æ¯</span></span><br><span class="line">	std::cout &lt;&lt; <span class="string">"New client "</span> &lt;&lt; clientSock-&gt;<span class="built_in">getFd</span>() &lt;&lt; <span class="string">": "</span> &lt;&lt;</span><br><span class="line">		<span class="built_in">inet_ntoa</span>(clientAddr-&gt;addr.sin_addr) &lt;&lt; <span class="string">" : "</span> &lt;&lt; <span class="built_in">ntohs</span>(clientAddr-&gt;addr.sin_port) &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">	clientSock-&gt;<span class="built_in">setNonBlocking</span>();</span><br><span class="line"></span><br><span class="line">	<span class="built_in">newConnectionCallback</span>(clientSock);</span><br><span class="line">	<span class="keyword">delete</span> clientAddr;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>Server</code> ç±»å˜å¾—åªè´Ÿè´£ç®¡ç† <code>Acceptor</code> å’Œ <code>Connection</code> ç±»ï¼Œå…¶æˆå‘˜å‡½æ•°ä¹Ÿé›†ä¸­åœ¨ç®¡ç† <code>Acceptor</code> å’Œ <code>Connection</code> ç±»ä¸­ã€‚æ”¹å†™åçš„ <code>Server</code> ç±»ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Server::newConnection</span><span class="params">(Socket *_socket)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	Connection *conn = <span class="keyword">new</span> <span class="built_in">Connection</span>(loop, _socket);</span><br><span class="line">	std::function&lt;<span class="type">void</span>(Socket *)&gt; cb = std::<span class="built_in">bind</span>(&amp;Server::deleteConnection, <span class="keyword">this</span>, std::placeholders::_1);</span><br><span class="line">	conn-&gt;<span class="built_in">setDeleteConnectionCallback</span>(cb);</span><br><span class="line">	connections[_socket-&gt;<span class="built_in">getFd</span>()] = conn;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Server::deleteConnection</span><span class="params">(Socket *_socket)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	Connection *conn = connections[_socket-&gt;<span class="built_in">getFd</span>()];</span><br><span class="line">	connections.<span class="built_in">erase</span>(_socket-&gt;<span class="built_in">getFd</span>());</span><br><span class="line">	<span class="keyword">delete</span> conn;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>å½“æœ‰æ–°çš„ TCP è¿æ¥æ—¶ï¼Œå®ä¾‹åŒ–ä¸€ä¸ª <code>Connection</code> å¯¹è±¡ï¼Œè®¾ç½®å…¶åˆ é™¤æ—¶çš„å›è°ƒå‡½æ•°ï¼Œå¹¶æ”¾ç½®åœ¨ <code>connections</code> ä¸­ç®¡ç†ã€‚
<ul>
<li>ç›®å‰è¯¥æœåŠ¡å™¨çš„å”¯ä¸€åŠŸèƒ½â€”â€”æ¥å—å®¢æˆ·ç«¯çš„ä¿¡æ¯å¹¶å‘å›ï¼Œå°è£…æˆ <code>Connection</code> ç±»çš„ <code>echo</code> å‡½æ•°ï¼Œåœ¨ <code>Connection</code> æ„é€ æ—¶ç»‘å®šç»™ <code>Channel</code> ç±»çš„äº‹ä»¶å›è°ƒå‡½æ•°ï¼Œç”± <code>Channel</code> å®ä¾‹é‡åˆ°äº‹ä»¶æ—¶è§¦å‘ã€‚</li>
</ul>
</li>
<li>å½“æœ‰ TCP è¿æ¥æ–­å¼€æ—¶ï¼Œä» <code>connections</code> ä¸­åˆ é™¤è¯¥è¿æ¥ï¼Œå¹¶é‡Šæ”¾å¯¹è±¡ã€‚
<ul>
<li>ç”±äº <code>Connection</code> çš„ç”Ÿå‘½å‘¨æœŸç”± <code>Server</code> è¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥ä¹Ÿåº”è¯¥ç”± <code>Server</code> æ¥åˆ é™¤è¿æ¥</li>
</ul>
</li>
</ul>
<p>è‡³æ­¤ï¼ŒæœåŠ¡å™¨åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„é˜¶æ®µï¼ŒæœåŠ¡å™¨æœ€æ ¸å¿ƒçš„å‡ ä¸ªæ¨¡å—éƒ½å·²ç»æŠ½è±¡å‡ºæ¥ï¼Œä¸€ä¸ªå®Œæ•´çš„å•çº¿ç¨‹æœåŠ¡å™¨è®¾è®¡åŸºæœ¬å®Œæˆã€‚</p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day7">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day7">Gitee</a></p>
<h2 id="å…«-é—²æ¥æ— äº‹-æ•´ä¸ªç¼“å†²åŒº">å…«ã€é—²æ¥æ— äº‹ï¼Œæ•´ä¸ªç¼“å†²åŒº</h2>
<h3 id="8-1-å¼•å…¥ç¼“å†²åŒº">8.1 å¼•å…¥ç¼“å†²åŒº</h3>
<p>æ­¤èŠ‚å¼•å…¥ä¸€ä¸ªæœ€ç®€å•ã€æœ€åŸºæœ¬çš„ç¼“å†²åŒºï¼Œå®Œå–„æ”¹è¿›ä¹‹å‰çš„æœåŠ¡å™¨ã€‚</p>
<p>æ²¡æœ‰ä½¿ç”¨ç¼“å†²åŒºæ—¶ï¼ŒæœåŠ¡å™¨å›é€ä¿¡æ¯çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Connection::echo</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="type">char</span> buf[READ_BUFFER];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">bzero</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">		<span class="type">ssize_t</span> readLen = <span class="built_in">read</span>(sockfd, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (readLen &gt; <span class="number">0</span>)</span><br><span class="line">		{</span><br><span class="line">			std::cout &lt;&lt; buf &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">			<span class="built_in">write</span>(sockfd, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™æ˜¯éé˜»å¡å¼ socket IO çš„è¯»å–ï¼Œç¼“å†²åŒºå¤§å°ä¸º 1024ï¼Œè¡¨ç¤ºæ¯æ¬¡ TCP ç¼“å†²åŒºè¯»å– 1024 å¤§å°çš„æ•°æ®åˆ°ç¼“å†²åŒºï¼Œç„¶åå‘é€åˆ°å®¢æˆ·ç«¯ã€‚</li>
<li>åªèƒ½ä»¥ 1024 åœ°è¯»ï¼Œå½“æ•°æ®æ²¡æœ‰ 1024ï¼Œç”¨ç©ºå€¼è¡¥æ»¡ã€‚</li>
</ul>
<p>æ‰€ä»¥ï¼Œå°è£…ä¸€ä¸ªç¼“å†²åŒºï¼Œä¸ºæ¯ä¸€ä¸ª <code>Connection</code> ç±»åˆ†é…ä¸€ä¸ªè¯»ç¼“å†²åŒºå’Œå†™ç¼“å†²åŒºï¼š</p>
<ul>
<li>ä»å®¢æˆ·ç«¯è¯»æ¥çš„æ•°æ®å­˜æ”¾åœ¨éƒ½ç¼“å†²åŒºã€‚</li>
</ul>
<h3 id="8-2-bufferç±»">8.2 Bufferç±»</h3>
<p><code>Buffer</code> ç±»çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Buffer</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	std::string buf;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Buffer</span>() = <span class="keyword">default</span>;</span><br><span class="line">	~<span class="built_in">Buffer</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief å‘å½“å‰å­—ç¬¦ä¸²è¿½åŠ ä¸€ä¸ªå­—ç¬¦ä¸²</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">append</span><span class="params">(<span class="type">char</span> <span class="type">const</span> *str, <span class="type">int</span> _size)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief è¿”å›å½“å‰ç¼“å†²åŒºå­—ç¬¦ä¸²å¤§å°</span></span><br><span class="line">	<span class="function"><span class="type">ssize_t</span> <span class="title">size</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @briefè¿”å›æŒ‡å‘åº•å±‚å­—ç¬¦ä¸²æ•°æ®çš„æŒ‡é’ˆ</span></span><br><span class="line">	<span class="function"><span class="type">char</span> <span class="type">const</span> *<span class="title">c_str</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief æ¸…ç©ºå½“å‰ç¼“å†²åŒºå­—ç¬¦ä¸²</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">clear</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief ä»æ§åˆ¶å°è·å–è¾“å…¥</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">getline</span><span class="params">()</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>ä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* src/Connection.cpp */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Connection::echo</span><span class="params">(<span class="type">int</span> sockfd)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="type">char</span> buf[<span class="number">1024</span>];</span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">	{</span><br><span class="line">		<span class="built_in">bzero</span>(buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">		<span class="type">ssize_t</span> readLen = <span class="built_in">read</span>(sockfd, buf, <span class="built_in">sizeof</span>(buf));</span><br><span class="line">		<span class="keyword">if</span> (readLen &gt; <span class="number">0</span>)</span><br><span class="line">		{</span><br><span class="line">			readBuffer-&gt;<span class="built_in">append</span>(buf, readLen);	<span class="comment">// ç¼“å†²åŒºè¿½åŠ </span></span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (readLen == <span class="number">-1</span> <span class="keyword">and</span> errno == EINTR)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (readLen == <span class="number">-1</span> <span class="built_in">and</span> ((errno == EAGAIN) <span class="built_in">or</span> (errno == EWOULDBLOCK)))</span><br><span class="line">		{	<span class="comment">// ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®ï¼ŒåŒæ—¶è¿›è¡Œå›å†™</span></span><br><span class="line">			std::cout &lt;&lt; readBuffer-&gt;<span class="built_in">c_str</span>() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">			<span class="built_in">errorif</span>(<span class="built_in">write</span>(sockfd, readBuffer-&gt;<span class="built_in">c_str</span>(), readBuffer-&gt;<span class="built_in">size</span>()) == <span class="number">-1</span>, <span class="string">"***"</span>);</span><br><span class="line">			readBuffer-&gt;<span class="built_in">clear</span>();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		}</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (readLen == <span class="number">0</span>)</span><br><span class="line">		{</span><br><span class="line">			<span class="built_in">deleteConnectionCallback</span>(sock);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è™½ç„¶ä»æœ‰ <code>char buf[1024]</code> è¿™æ ·çš„ä½çº§ç¼“å†²åŒºï¼Œç”¨äºç³»ç»Ÿè°ƒç”¨ <code>read()</code> çš„è¯»å–ï¼Œä½†è¿™ä¸ªç¼“å†²åŒºå¤§å°æ— æ‰€è°“ï¼Œè®¾ç½®ä¸º1åˆ°è®¾å¤‡TCPç¼“å†²åŒºçš„å¤§å°éƒ½å¯ä»¥ã€‚</p>
<ul>
<li>å¤ªå¤§å¯¼è‡´èµ„æºæµªè´¹ï¼Œå•è¯è¯»å–é€Ÿåº¦ä½ï¼›</li>
<li>å¤ªå°å¯¼è‡´è¯»å–æ¬¡æ•°å¢å¤šã€‚</li>
</ul>
<p>ä»¥ä¸Šä»£ç ä¼šæŠŠ socket IO ä¸Šçš„å¯è¯»æ•°æ®å…¨éƒ¨è¯»å–åˆ°ç¼“å†²åŒºï¼Œç¼“å†²åŒºå¤§å°å°±ç­‰äºå®¢æˆ·ç«¯å‘é€çš„æ•°æ®å¤§å°ã€‚å…¨éƒ¨è¯»å–å®Œæˆä¹‹åï¼Œå¯ä»¥æ„é€ ä¸€ä¸ªå†™ç¼“å†²åŒºã€å¡«å¥½æ•°æ®å‘é€ç»™å®¢æˆ·ç«¯ã€‚</p>
<ul>
<li>ç”±äºæ˜¯echoæœåŠ¡å™¨ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†ç›¸åŒçš„ç¼“å†²åŒºã€‚</li>
</ul>
<h3 id="8-3-å…¶ä»–æ–¹é¢çš„æ”¹è¿›">8.3 å…¶ä»–æ–¹é¢çš„æ”¹è¿›</h3>
<ul>
<li>
<p>ä¼˜åŒ– InetAddress ç±»ï¼Œå°†æˆå‘˜ç§æœ‰åŒ–ï¼Œæä¾›è®¿é—®æ–¹æ³•ã€‚ï¼ˆâ€”â€” <code>src/InetAddress.h</code> å’Œ <code>src/InetAddress.cpp</code>ï¼‰</p>
</li>
<li>
<p>Socket ç±»æ·»åŠ  <code>connect</code> æ–¹æ³•ï¼Œæ–¹ä¾¿ <code>client.cpp</code> è°ƒç”¨ã€‚ï¼ˆâ€”â€” <code>src/Socket.h</code> å’Œ <code>src/Socket.cpp</code>ï¼‰</p>
</li>
<li>
<p>ç»“åˆç°æœ‰çš„æ¨¡å—ï¼Œæ”¹è¿› client æ–‡ä»¶ã€‚ï¼ˆâ€”â€” <code>client.cpp</code>ï¼‰</p>
</li>
<li>
<p>æ•´ä½“æ”¹è¿›äº†äº†è¾“å‡ºä¿¡æ¯æç¤ºã€‚</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day8-1.jpg" title="æœåŠ¡å™¨ç«¯" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day8-1.jpg" alt="æœåŠ¡å™¨ç«¯"></a></p>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day8-2.jpg" title="å®¢æˆ·ç«¯" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day8-2.jpg" alt="å®¢æˆ·ç«¯"></a></p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day8">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day8">Gitee</a></p>
<h2 id="ä¹-çº¿ç¨‹æ± å•Šçº¿ç¨‹æ± ">ä¹ã€çº¿ç¨‹æ± å•Šçº¿ç¨‹æ± </h2>
<h3 id="9-1-ä¸ºä»€ä¹ˆåŠ å…¥çº¿ç¨‹æ± ">9.1 ä¸ºä»€ä¹ˆåŠ å…¥çº¿ç¨‹æ± </h3>
<p>å½“å‰çš„ä»£ç æ˜¯å•çº¿ç¨‹æ¨¡å¼ï¼Œæ‰€æœ‰ fd ä¸Šçš„äº‹ä»¶éƒ½ç”±ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼ŒEventLoopçº¿ç¨‹ï¼‰å¤„ç†ã€‚</p>
<ul>
<li>å‡è®¾å“åº”ä¸€ä¸ªäº‹ä»¶éœ€è¦ 1sï¼Œé‚£ä¹ˆå¦‚æœæœ‰ 1000 ä¸ªäº‹ä»¶ï¼Œé‚£ä¹ˆä¸»çº¿ç¨‹å°±è¦ç­‰å¾…å¾ˆä¹…ã€‚</li>
<li>è¿™ä¸ç°å®ã€‚</li>
</ul>
<p>å¼•å…¥å¤šçº¿ç¨‹ï¼Œå½“å‘ç° socket fd æœ‰äº‹ä»¶æ—¶ï¼Œåº”è¯¥åˆ†å‘ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚</p>
<ul>
<li>ç”±è¿™ä¸ªå·¥ä½œçº¿ç¨‹å¤„ç† fd ä¸Šçš„äº‹ä»¶ã€‚</li>
</ul>
<p>å†è€…ï¼Œæ¯ä¸€ä¸ª Reactor åªåº”è¯¥è´Ÿè´£äº‹ä»¶åˆ†å‘è€Œä¸è´Ÿè´£äº‹ä»¶å¤„ç†ã€‚</p>
<h3 id="9-2-å¦‚ä½•è®¾è®¡çº¿ç¨‹æ± ">9.2 å¦‚ä½•è®¾è®¡çº¿ç¨‹æ± </h3>
<p>æœ€ç®€å•çš„æƒ³æ³•å°±æ˜¯ï¼Œæ¯æ¬¡é‡åˆ°ä¸€ä¸ªæ–°çš„ä»»åŠ¡ï¼Œå°±å¼€ä¸€ä¸ªæ–°çº¿ç¨‹å»æ‰§è¡Œã€‚</p>
<ul>
<li>è¿™ç§æ–¹å¼è™½ç„¶ç®€å•ï¼Œä½†æ˜¯å¤ªç²—æš´äº†ã€‚</li>
<li>æˆ‘ä»¬çš„æœºå™¨æ˜¯æœ‰ä¸Šé™çš„ï¼Œä¸å¯èƒ½æ— é™å¼€æ–°çº¿ç¨‹ã€‚</li>
</ul>
<p>é‚£ä¹ˆï¼Œå¯ä»¥å›ºå®šä¸€ä¸ªçº¿ç¨‹çš„æ•°é‡ã€‚å¯åŠ¨å›ºå®šæ•°é‡çš„å·¥ä½œçº¿ç¨‹ï¼Œç„¶åå°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œå·¥ä½œçº¿ç¨‹ä¸æ–­å–å‡ºä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡æ‰§è¡Œã€‚</p>
<p>è®¾è®¡çº¿ç¨‹æ± è¿˜éœ€è¦æ³¨æ„ï¼š</p>
<ol>
<li>å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä»»åŠ¡é˜Ÿåˆ—çš„è¯»å†™åº”è¯¥è€ƒè™‘äº’æ–¥é”ã€‚</li>
<li>å½“ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼ŒCPU ä¸åº”è¯¥ä¸€ç›´è½®è¯¢è€—è´¹ CPU èµ„æºã€‚</li>
</ol>
<p>æ­¤å¤„è§£å†³æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ol>
<li><code>std::mutex</code> å¯¹ä»»åŠ¡é˜Ÿåˆ—è¿›è¡ŒåŠ é”è§£é”ã€‚</li>
<li><code>std::condition_variable</code> ä½¿ç”¨æ¡ä»¶å˜é‡ã€‚</li>
</ol>
<h3 id="9-3-çº¿ç¨‹æ± ç”¨åˆ°çš„è¯­æ³•çŸ¥è¯†">9.3 çº¿ç¨‹æ± ç”¨åˆ°çš„è¯­æ³•çŸ¥è¯†</h3>
<p><strong>å…³äºäº’æ–¥é”ï¼š<a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/header/mutex">mutexå¤´æ–‡ä»¶ - cppreference</a></strong></p>
<ul>
<li><code>mutex</code> ç±»æ˜¯èƒ½ç”¨äºä¿æŠ¤å…±äº«æ•°æ®å…å—ä»å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®çš„åŒæ­¥åŸè¯­ã€‚</li>
<li><code>lock()</code>ï¼šæˆå‘˜å‡½æ•°ï¼Œé”å®šäº’æ–¥ä½“ï¼Œè‹¥äº’æ–¥ä½“ä¸å¯ç”¨åˆ™é˜»å¡ã€‚ä½äºå¤´æ–‡ä»¶ <code>&lt;mutex&gt;</code>ã€‚
<ul>
<li>é€šå¸¸ä¸ç›´æ¥è°ƒç”¨ <code>lock()</code>ã€‚</li>
<li>ç”¨ <code>std::unique_lock</code> ä¸ <code>std::lock_guard</code> ç®¡ç†æ’ä»–æ€§é”å®šã€‚</li>
<li><code>unique_lock</code> ç±»æ˜¯ä¸€ç§é€šç”¨äº’æ–¥åŒ…è£…å™¨ï¼Œå…è®¸å»¶è¿Ÿé”å®šã€æœ‰æ—¶é™çš„é”å®šå°è¯•ã€é€’å½’é”å®šã€æ‰€æœ‰æƒè½¬ç§»å’Œä¸æ¡ä»¶å˜é‡ä¸€åŒä½¿ç”¨ã€‚</li>
<li>æ„é€ å‡½æ•°ï¼š<code>explicit unique_lock( mutex_type&amp; m );</code>ï¼Œé€šè¿‡è°ƒç”¨ <code>m.lock()</code> é”å®šå…³è”äº’æ–¥ä½“ã€‚</li>
<li>ææ„å‡½æ•°ï¼šè‹¥æ‹¥æœ‰å…³è”äº’æ–¥ä½“ä¸”è·å¾—äº†å…¶æ‰€æœ‰æƒï¼Œåˆ™è§£é”äº’æ–¥ä½“ã€‚</li>
</ul>
</li>
<li><code>try_lock()</code>ï¼šæˆå‘˜å‡½æ•°ï¼Œå°è¯•é”å®šäº’æ–¥ä½“ï¼Œè‹¥äº’æ–¥ä½“ä¸å¯ç”¨åˆ™è¿”å› <code>false</code>ã€‚ä½äºå¤´æ–‡ä»¶ <code>&lt;mutex&gt;</code>ã€‚</li>
<li><code>unlock()</code>ï¼šæˆå‘˜å‡½æ•°ï¼Œè§£é”äº’æ–¥ä½“ã€‚ä½äºå¤´æ–‡ä»¶ <code>&lt;mutex&gt;</code>ã€‚</li>
</ul>
<p><strong>å…³äºçº¿ç¨‹ç­‰å¾…æ¡ä»¶ï¼š<a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/header/condition_variable">condition_variableå¤´æ–‡ä»¶ - cppreference</a></strong></p>
<ul>
<li><code>std::condition_variable</code>ï¼ˆçº¿ç¨‹ç­‰å¾…æ¡ä»¶ï¼‰ æ˜¯ä¸ <code>std::mutex</code> ä¸€èµ·ä½¿ç”¨çš„åŒæ­¥åŸè¯­ã€‚</li>
<li>å®ƒèƒ½ç”¨äºé˜»å¡ä¸€ä¸ªçº¿ç¨‹ï¼Œæˆ–åŒæ—¶é˜»å¡å¤šä¸ªçº¿ç¨‹ï¼Œç›´è‡³å¦ä¸€çº¿ç¨‹ä¿®æ”¹å…±äº«å˜é‡ï¼ˆæ¡ä»¶ï¼‰å¹¶é€šçŸ¥ <code>std::condition_variable</code>ã€‚</li>
<li>æœ‰æ„ä¿®æ”¹å˜é‡çš„çº¿ç¨‹å¿…é¡»ï¼š
<ol>
<li>è·å¾— <code>std::mutex</code>ï¼ˆå¸¸é€šè¿‡ <code>std::lock_guard</code>ï¼‰</li>
<li>åœ¨ä¿æœ‰é”æ—¶è¿›è¡Œä¿®æ”¹</li>
<li>åœ¨ <code>std::condition_variable</code> ä¸Šæ‰§è¡Œ <code>notify_one</code> æˆ– <code>notify_all</code>ï¼ˆå¯ä»¥é‡Šæ”¾é”åå†é€šçŸ¥ï¼‰</li>
</ol>
</li>
<li>ä»»ä½•æœ‰æ„åœ¨ <code>std::condition_variable</code> ä¸Šç­‰å¾…çš„çº¿ç¨‹å¿…é¡»ï¼š
<ol>
<li>åœ¨ç”¨äºä¿æŠ¤å…±äº«å˜é‡çš„äº’æ–¥ä½“ä¸Šè·å¾— <code>std::unique_lock&lt;std::mutex&gt;</code>ã€‚</li>
<li>æ‰§è¡Œä¸‹åˆ—ä¹‹ä¸€ï¼š
<ul>
<li>æ£€æŸ¥æ¡ä»¶ï¼Œæ˜¯å¦ä¸ºå·²æ›´æ–°ä¸”å·²æé†’çš„æƒ…å†µã€‚</li>
<li>è°ƒç”¨ <code>std::condition_variable</code> çš„ <code>wait</code>ã€<code>wait_for</code> æˆ– <code>wait_until</code>ï¼ˆåŸå­åœ°é‡Šæ”¾äº’æ–¥ä½“å¹¶æš‚åœçº¿ç¨‹çš„æ‰§è¡Œï¼Œç›´åˆ°æ¡ä»¶å˜é‡è¢«é€šçŸ¥ï¼Œæ—¶é™è¿‡æœŸï¼Œæˆ–å‘ç”Ÿè™šå‡å”¤é†’ï¼Œç„¶ååœ¨è¿”å›å‰è‡ªåŠ¨è·å¾—äº’æ–¥ä½“ï¼‰ã€‚</li>
<li>æ£€æŸ¥æ¡ä»¶ï¼Œå¹¶åœ¨æœªæ»¡è¶³çš„æƒ…å†µä¸‹ç»§ç»­ç­‰å¾…ã€‚</li>
</ul>
</li>
</ol>
</li>
<li><code>wait()</code>ï¼šæˆå‘˜å‡½æ•°ï¼Œé˜»å¡å½“å‰è¿›ç¨‹ï¼Œç›´è‡³æ¡ä»¶å˜é‡è¢«å”¤é†’ã€‚ä½äºå¤´æ–‡ä»¶ <code>&lt;condition_variable&gt;</code>ã€‚
<ul>
<li>ç±»ä¼¼è¿˜æœ‰<code>wait_for</code>ã€<code>wait_until</code>ã€‚ä¸å¤šè¯´ï¼Œè‡ªè¡ŒæŸ¥é˜…ã€‚</li>
</ul>
</li>
<li><code>notify_one()</code>ï¼šæˆå‘˜å‡½æ•°ï¼Œé€šçŸ¥ä¸€ä¸ªç­‰å¾…çš„çº¿ç¨‹ã€‚ä½äºå¤´æ–‡ä»¶ <code>&lt;condition_variable&gt;</code>ã€‚</li>
<li><code>notify_all()</code>ï¼šæˆå‘˜å‡½æ•°ï¼Œé€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ã€‚ä½äºå¤´æ–‡ä»¶ <code>&lt;condition_variable&gt;</code>ã€‚</li>
</ul>
<h3 id="9-4-çº¿ç¨‹æ± ç±»">9.4 çº¿ç¨‹æ± ç±»</h3>
<p>çº¿ç¨‹æ± ç±»ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadPool</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">	std::vector&lt;std::thread&gt; threads;</span><br><span class="line">	<span class="comment">// è¦æ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line">	std::queue&lt;std::function&lt;<span class="type">void</span>()&gt;&gt; tasks;</span><br><span class="line">	<span class="comment">// å£°æ˜äº’æ–¥é”ä»¥åŒæ­¥å¯¹ä»»åŠ¡é˜Ÿåˆ—çš„è®¿é—®</span></span><br><span class="line">	std::mutex tasksMtx;</span><br><span class="line">	<span class="comment">// å£°æ˜åœ¨çº¿ç¨‹ä¹‹é—´è¿›è¡Œåè°ƒçš„æ¡ä»¶å˜é‡</span></span><br><span class="line">	std::condition_variable cv;</span><br><span class="line">	<span class="comment">// æŒ‡ç¤ºçº¿ç¨‹åœæ­¢çš„æ ‡å¿—</span></span><br><span class="line">	<span class="type">bool</span> stop;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">ThreadPool</span>(<span class="type">int</span> size = <span class="number">10</span>);</span><br><span class="line">	~<span class="built_in">ThreadPool</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// @brief åŠ å…¥ä»»åŠ¡åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">add</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; task)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>çº¿ç¨‹æ± çš„æ„é€ å‡½æ•°è®¾è®¡ä¸ºï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ThreadPool::<span class="built_in">ThreadPool</span>(<span class="type">int</span> size) : <span class="built_in">stop</span>(<span class="literal">false</span>)</span><br><span class="line">{</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; size; ++ i)</span><br><span class="line">	{</span><br><span class="line">		threads.<span class="built_in">emplace_back</span>(std::<span class="built_in">thread</span>([<span class="keyword">this</span>] ()</span><br><span class="line">			{</span><br><span class="line">				<span class="keyword">while</span> (<span class="literal">true</span>)</span><br><span class="line">				{</span><br><span class="line">					std::function&lt;<span class="built_in">void</span>()&gt; task;</span><br><span class="line">					{<span class="comment">// ä½¿ç”¨ä½œç”¨åŸŸç”Ÿå‘½æœŸè§£é” std::mutexï¼Œè€Œä¸è°ƒç”¨unlock()</span></span><br><span class="line">						std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(tasksMtx);</span><br><span class="line">						<span class="comment">// å½“ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©ºæˆ–çº¿ç¨‹æ± åœæ­¢æ—¶åœæ­¢ç­‰å¾…ï¼ˆé˜»å¡ï¼‰</span></span><br><span class="line">						cv.<span class="built_in">wait</span>(lock, [<span class="keyword">this</span>] (){</span><br><span class="line">								<span class="keyword">return</span> stop <span class="keyword">or</span> !tasks.<span class="built_in">empty</span>();</span><br><span class="line">							});</span><br><span class="line">						<span class="keyword">if</span> (stop <span class="keyword">and</span> tasks.<span class="built_in">empty</span>())	<span class="comment">// ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºä¸”çº¿ç¨‹æ± åœæ­¢ï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">							<span class="keyword">return</span>;</span><br><span class="line">						task = tasks.<span class="built_in">front</span>();</span><br><span class="line">						tasks.<span class="built_in">pop</span>();</span><br><span class="line">					}</span><br><span class="line">					<span class="built_in">task</span>();	<span class="comment">// æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">				}</span><br><span class="line">			}));</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ol>
<li>åˆå§‹çº¿ç¨‹æ± å¤§å°ä¸º <code>size</code>ï¼Œåˆ›å»ºçº¿ç¨‹å¹¶è®©æ¯ä¸ªçº¿ç¨‹ç­‰å¾…å°†ä»»åŠ¡æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚</li>
<li>ä½¿ç”¨ <code>std::unique_lock</code> é”å®šä»»åŠ¡äº’æ–¥é”ä»¥é˜²æ­¢å¹¶å‘è®¿é—®ï¼Œå¹¶å°†å…¶ç½®äºå±€éƒ¨ä½œç”¨åŸŸï¼Œå½“ç¦»å¼€ä½œç”¨åŸŸæ—¶ï¼Œå®ƒå°†è‡ªåŠ¨è§£é”äº’æ–¥é”ã€‚</li>
<li>å½“æ·»åŠ ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡å¹¶æ‰§è¡Œå®ƒã€‚çº¿ç¨‹å°†ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼Œç›´åˆ°çº¿ç¨‹æ± åœæ­¢ã€‚</li>
</ol>
<p>ææ„å‡½æ•°è®¾è®¡ä¸ºï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ThreadPool::~<span class="built_in">ThreadPool</span>()</span><br><span class="line">{</span><br><span class="line">	{</span><br><span class="line">		<span class="function">std::unique_lock&lt;std::mutex&gt; <span class="title">lock</span><span class="params">(tasksMtx)</span></span>;</span><br><span class="line">		stop = <span class="literal">true</span>;</span><br><span class="line">	}</span><br><span class="line">	</span><br><span class="line">	cv.<span class="built_in">notify_all</span>();	<span class="comment">// é€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹çº¿ç¨‹æ± æ­£åœ¨åœæ­¢</span></span><br><span class="line">	<span class="keyword">for</span> (std::thread &amp;th : threads)</span><br><span class="line">	{	<span class="comment">// æ£€æŸ¥çº¿ç¨‹æ˜¯å¦å¯æ¥åˆ</span></span><br><span class="line">		<span class="keyword">if</span> (th.<span class="built_in">joinable</span>())</span><br><span class="line">			th.<span class="built_in">join</span>();	<span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°æŒ‡å®šçº¿ç¨‹å®Œæˆå…¶æ‰§è¡Œ</span></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>åœ¨çº¿ç¨‹æ± ææ„æ—¶ï¼Œéœ€è¦æ³¨æ„å°†å·²ç»æ·»åŠ çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œï¼Œæœ€å¥½ä¸é‡‡ç”¨å¤–éƒ¨çš„æš´åŠ›killã€è€Œæ˜¯è®©æ¯ä¸ªçº¿ç¨‹ä»å†…éƒ¨è‡ªåŠ¨é€€å‡ºï¼Œå…·ä½“å®ç°å‚è€ƒæºä»£ç ã€‚</li>
</ul>
<ol>
<li>åœ¨ä¸Šé”çš„æƒ…å†µä¸‹ï¼ŒæŠŠçº¿ç¨‹æ± çš„åœæ­¢çŠ¶æ€è®¾ç½®ä¸º<code>true</code>ï¼Œç„¶åé€šçŸ¥æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹çº¿ç¨‹æ± æ­£åœ¨åœæ­¢ã€‚</li>
<li>ç„¶åï¼Œç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆå…¶æ‰§è¡Œã€‚</li>
</ol>
<p>åŠ å…¥çº¿ç¨‹æ± åï¼Œå½“ <code>Channel</code> ç±»æœ‰äº‹ä»¶éœ€è¦å¤„ç†æ—¶ï¼Œå°†è¿™ä¸ªäº‹ä»¶å¤„ç†æ·»åŠ åˆ°çº¿ç¨‹æ± ï¼Œä¸»çº¿ç¨‹ <code>EventLoop</code> å°±å¯ä»¥ç»§ç»­è¿›è¡Œäº‹ä»¶å¾ªç¯ï¼Œè€Œä¸åœ¨ä¹æŸä¸ª <code>socket fd</code> ä¸Šçš„äº‹ä»¶å¤„ç†ã€‚</p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day9">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day9">Gitee</a></p>
<h2 id="å-æœ‰äº†çº¿ç¨‹æ± ä¹‹åçš„è€ƒè™‘">åã€æœ‰äº†çº¿ç¨‹æ± ä¹‹åçš„è€ƒè™‘</h2>
<h3 id="10-1-å®Œå–„çº¿ç¨‹æ± ">10.1 å®Œå–„çº¿ç¨‹æ± </h3>
<p>ä¸Šä¸€èŠ‚æ·»åŠ çš„çº¿ç¨‹æ± æ˜¯æœ€ç®€å•çš„çº¿ç¨‹æ± ï¼Œè¿˜å­˜åœ¨è®¸å¤šé—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>ä»»åŠ¡é˜Ÿåˆ—çš„æ·»åŠ ã€å–å‡ºéƒ½ä¼šæœ‰ä¸å¿…è¦çš„æ‹·è´æ“ä½œï¼›</li>
<li>çº¿ç¨‹æ± åªæ¥å— <code>std::function&lt;void&gt;</code> ç±»å‹çš„å‚æ•°ï¼Œæ‰€æœ‰å‡½æ•°å‚æ•°éƒ½è¦äº‹å…ˆä½¿ç”¨ <code>std::bind()</code>ï¼Œå¹¶ä¸”æ— æ³•å¾—åˆ°è¿”å›å€¼ã€‚</li>
</ul>
<p>è§£å†³æ–¹æ³•ä¸€ä¸€å¯¹åº”ï¼š</p>
<ul>
<li>ä½¿ç”¨å³å€¼ç§»åŠ¨å»é¿å…æ‹·è´æ“ä½œã€‚</li>
<li>æ”¹å†™ <code>add()</code> å‡½æ•°ï¼Œå¸Œæœ›ä½¿ç”¨å‰ä¸éœ€è¦æ‰‹åŠ¨ç»‘å®šå‚æ•°ï¼Œç›´æ¥ä¼ é€’å¹¶ä¸”å¯ä»¥å¾—åˆ°ä»»åŠ¡çš„è¿”å›å€¼ã€‚</li>
</ul>
<h3 id="10-2-å®Œå–„çº¿ç¨‹æ± ç”¨åˆ°çš„è¯­æ³•çŸ¥è¯†">10.2 å®Œå–„çº¿ç¨‹æ± ç”¨åˆ°çš„è¯­æ³•çŸ¥è¯†</h3>
<p><strong>å…³äºæ¨¡æ¿ç¼–ç¨‹ï¼š<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/cpp/cpp/templates-cpp?view=msvc-170">æ¨¡æ¿ - MSLearn</a>ã€<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/655902377">ç†è§£C++æ¨¡æ¿ - çŸ¥ä¹</a></strong></p>
<ul>
<li>ç®€å•æ¥è¯´ï¼Œæ¨¡æ¿ç¼–ç¨‹å°±æ˜¯æä¾›äº†ä¸€å¥—æ¨¡å…·ï¼Œå¯¹äºä¸åŒçš„æ•°æ®ç±»å‹éƒ½å¯ä»¥é€‚ç”¨äºè¿™å¥—æ¨¡å…·ã€‚</li>
<li>å‡½æ•°æ¨¡æ¿çš„ç»“æ„ä¸€èˆ¬å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt; è¿”å›ç±»å‹ å‡½æ•°å(å‚æ•°åˆ—è¡¨){ <span class="comment">/*å‡½æ•°çš„ä¸»ä½“*/</span> }</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç±»æ¨¡æ¿ç»“æ„ä¸€èˆ¬å¦‚ä¸‹ï¼š</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; <span class="keyword">class</span> ç±»å {}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/394184676">å˜é•¿å‚æ•°æ¨¡æ¿</a>ï¼šå‚æ•°ä¸ªæ•°å’Œç±»å‹éƒ½å¯èƒ½å‘ç”Ÿå˜åŒ–çš„æ¨¡æ¿ã€‚
<ul>
<li>ä½¿ç”¨æ¨¡æ¿å½¢å‚åŒ…å®ç°ã€‚</li>
<li>æ¨¡æ¿å½¢å‚åŒ…æ˜¯å¯ä»¥æ¥å— 0 ä¸ªæˆ–è€… n ä¸ªæ¨¡æ¿å®å‚çš„æ¨¡æ¿å½¢å‚ï¼Œè‡³å°‘æœ‰ä¸€ä¸ªæ¨¡æ¿å½¢å‚åŒ…çš„æ¨¡æ¿å°±å¯ä»¥ç§°ä½œå˜å‚æ•°æ¨¡æ¿ã€‚</li>
<li>æ¨¡æ¿å½¢å‚åŒ…æœ‰ï¼šéç±»å‹æ¨¡æ¿å½¢å‚åŒ…ã€ç±»å‹æ¨¡æ¿å½¢å‚åŒ…ã€æ¨¡æ¿æ¨¡æ¿å½¢å‚åŒ…ä¸‰ç§ã€‚</li>
<li>æ­¤èŠ‚ä½¿ç”¨ç±»å‹æ¨¡æ¿å½¢å‚åŒ…ï¼šè¡¨ç¤ºè¯¥å¯å˜å½¢å‚åŒ…å¯ä»¥æ¥å—æ— é™ä¸ªä¸åŒçš„å®å‚ç±»å‹ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typename</span>... Args æˆ– <span class="keyword">class</span> ... Args</span><br></pre></td></tr></tbody></table></figure>
<p><strong>å…³äºå³å€¼å’Œç§»åŠ¨ <code>std::move</code>ï¼š<a target="_blank" rel="noopener" href="https://blog.csdn.net/reyas/article/details/137735522">C++å¼•ç”¨å’Œå³å€¼å¼•ç”¨ - CSDN</a>ã€<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/2341672">ã€C++ã€‘C++11â€”â€”å·¦å³å€¼|å³å€¼å¼•ç”¨|ç§»åŠ¨è¯­ä¹‰|å®Œç¾è½¬å‘</a>ã€<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/335994370">ä¸€æ–‡è¯»æ‡‚C++å³å€¼å¼•ç”¨å’Œstd::move - çŸ¥ä¹</a></strong></p>
<ul>
<li>C++11 åå¢åŠ äº†ç§»åŠ¨è¯­ä¹‰ï¼Œå‡ºç°äº†ç§»åŠ¨æ„é€ ã€ç§»åŠ¨èµ‹å€¼ç­‰ã€‚</li>
<li>ç®€å•æ¥è¯´ï¼Œç§»åŠ¨è¯­ä¹‰çš„å‡ºç°ï¼Œå¯ä»¥æŠŠæ—§å¯¹è±¡æ‰€æ‹¥æœ‰çš„èµ„æºäº¤ç»™æ–°å¯¹è±¡ï¼Œè€Œæ—§å¯¹è±¡ä»€ä¹ˆéƒ½æ²¡æœ‰äº†ã€‚</li>
<li>å³å€¼å¼•ç”¨çš„å‡ºç°ä¹Ÿæ˜¯ä¸ºäº†ç§»åŠ¨è¯­ä¹‰ã€‚</li>
</ul>
<p><strong>å…³äºå®Œç¾è½¬å‘ <code>std::forward</code>ï¼š</strong></p>
<ul>
<li>å’Œ <code>std::move</code> ç±»ä¼¼ï¼Œä¸ <code>std::move</code>ç›¸æ¯”ï¼Œå®ƒæ›´å¼ºå¤§ï¼Œ<code>move</code> åªèƒ½è½¬å‡ºæ¥å³å€¼ï¼Œ<code>forward</code> éƒ½å¯ä»¥ã€‚</li>
<li><code>std::forward&lt;T&gt;(u)</code> æœ‰ä¸¤ä¸ªå‚æ•°ï¼š<code>T</code> ä¸ <code>u</code>ã€‚
<ul>
<li>å½“ <code>T</code> ä¸ºå·¦å€¼å¼•ç”¨ç±»å‹æ—¶ï¼Œ<code>u</code> å°†è¢«è½¬æ¢ä¸º <code>T</code> ç±»å‹çš„å·¦å€¼ï¼›</li>
<li>å¦åˆ™ <code>u</code> å°†è¢«è½¬æ¢ä¸º <code>T</code> ç±»å‹å³å€¼ã€‚</li>
</ul>
</li>
</ul>
<p><strong>å…³äº <code>std::future</code>ï¼š<a target="_blank" rel="noopener" href="https://zh.cppreference.com/w/cpp/header/future">future - cppreference</a></strong></p>
<ul>
<li>ç±»æ¨¡æ¿ <code>std::packaged_task</code> å¯ä»¥åŒ…è£…ä»»ä½•å¯è°ƒç”¨ (Callable) ç›®æ ‡ï¼ˆå‡½æ•°ã€lambda è¡¨è¾¾å¼ã€bind è¡¨è¾¾å¼æˆ–å…¶ä»–å‡½æ•°å¯¹è±¡ï¼‰ï¼Œä½¿å¾—èƒ½å¼‚æ­¥è°ƒç”¨å®ƒã€‚å…¶è¿”å›å€¼æˆ–æ‰€æŠ›å¼‚å¸¸è¢«å­˜å‚¨äºèƒ½é€šè¿‡ std::future å¯¹è±¡è®¿é—®çš„å…±äº«çŠ¶æ€ä¸­ã€‚
<ul>
<li>æˆå‘˜å‡½æ•° <code>get_future()</code>ï¼Œè¿”å›ä¸ <code>*this</code> å…±äº«åŒä¸€å…±äº«çŠ¶æ€çš„ <code>future</code>ï¼Œæ¯ä¸ª <code>packaged_task</code> å¯¹è±¡åªèƒ½è°ƒç”¨ä¸€æ¬¡ã€‚</li>
</ul>
</li>
<li>ç±»æ¨¡æ¿ <code>std::future</code>ï¼š<code>future</code> å¯¹è±¡æä¾›è®¿é—®å¼‚æ­¥æ“ä½œç»“æœçš„æœºåˆ¶ï¼Œä»å¼‚æ­¥ä»»åŠ¡ä¸­è¿”å›ç»“æœã€‚</li>
<li>ç±»æ¨¡æ¿ <code>std::future</code> æä¾›è®¿é—®å¼‚æ­¥æ“ä½œç»“æœçš„æœºåˆ¶ï¼š
<ul>
<li>ï¼ˆé€šè¿‡ <code>std::async</code>ã€<code>std::packaged_task</code> æˆ– <code>std::promise</code> åˆ›å»ºçš„ï¼‰å¼‚æ­¥æ“ä½œèƒ½æä¾›ä¸€ä¸ª <code>std::future</code> å¯¹è±¡ç»™è¯¥å¼‚æ­¥æ“ä½œçš„åˆ›å»ºè€…ã€‚</li>
<li>ç„¶åï¼Œå¼‚æ­¥æ“ä½œçš„åˆ›å»ºè€…å¯ä»¥ä½¿ç”¨å¤šä¸ªæ–¹æ³•æŸ¥è¯¢ã€ç­‰å¾…æˆ–ä» <code>std::future</code> æå–å€¼ã€‚è‹¥å¼‚æ­¥æ“ä½œå°šæœªæä¾›å€¼ï¼Œåˆ™è¿™äº›æ–¹æ³•å¯èƒ½é˜»å¡ã€‚</li>
<li>å½“å¼‚æ­¥æ“ä½œå‡†å¤‡å¥½å‘é€ç»“æœç»™åˆ›å»ºè€…æ—¶ï¼Œå®ƒå¯ä»¥ä¿®æ”¹ä¸åˆ›å»ºè€…çš„ <code>std::future</code> ç›¸é“¾æ¥çš„å…±äº«çŠ¶æ€ï¼ˆä¾‹å¦‚ <code>std::promise::set_value</code>ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h3 id="10-3-å†ä¿®ä¿®è¡¥è¡¥">10.3 å†ä¿®ä¿®è¡¥è¡¥</h3>
<p>é™¤äº†ä¸Šé¢çº¿ç¨‹æ± çš„éƒ¨åˆ†æœ‰ä¿®æ”¹ï¼Œä»¥ä¸‹éƒ¨åˆ†ä¹Ÿæœ‰ä¿®æ”¹ï¼š</p>
<p>Channel éƒ¨åˆ†ï¼š</p>
<ul>
<li>æ–°å¢æ ‡è®°ä½å’Œæ˜¯å¦ä½¿ç”¨çº¿ç¨‹æ± çš„å‡½æ•°ï¼›</li>
<li>å¯¹äºå¤„ç†äº‹ä»¶åŒºåˆ†äº†è¯»äº‹ä»¶å’Œå†™äº‹ä»¶åˆ†åˆ«çš„å›è°ƒå‡½æ•°ï¼›</li>
<li>æ–°å¢å¯é€‰æ‹©æ€§ epoll ET æ¨¡å¼æˆ– epoll LT æ¨¡å¼ï¼›</li>
</ul>
<p>Acceptor éƒ¨åˆ†ï¼šå› ä¸ºæ¥å—è¿æ¥å¤„ç†æ—¶é—´çŸ­ã€æŠ¥æ–‡æ•°æ®å°ï¼Œä¹Ÿä¸ä¼šæœ‰åŒæ—¶åˆ°è¾¾çš„æ–°è¿æ¥ï¼Œæ‰€ä»¥</p>
<ul>
<li>Acceptor çš„ socket fd ï¼ˆæœåŠ¡å™¨ç›‘å¬ socketï¼‰ä½¿ç”¨é˜»å¡å¼ï¼š</li>
<li>Acceptor ä» epoll ET æ¨¡å¼æ”¹ä¸º epoll LT æ¨¡å¼ï¼Œå»ºç«‹å¥½è¿æ¥åå¤„ç†äº‹ä»¶ fd è¯»å†™ç”¨ ET æ¨¡å¼ã€‚</li>
<li>Acceptor çš„è¿æ¥å»ºç«‹ä¸é€‚ç”¨çº¿ç¨‹æ± ï¼Œå»ºç«‹å¥½è¿æ¥åå¤„ç†äº‹ä»¶ä½¿ç”¨çº¿ç¨‹æ± ã€‚</li>
</ul>
<p>Connection éƒ¨åˆ†ï¼š</p>
<ul>
<li>æ–°å¢ <code>send()</code> å‡½æ•°ï¼Œç‹¬ç«‹å‘é€æ•°æ®ã€‚</li>
<li>ä¿®æ”¹ <code>deleteConnectionCallback()</code> å‡½æ•°ï¼Œå‚æ•°ç±»å‹æ”¹ä¸º <code>int</code>ã€‚</li>
</ul>
<p>Epoll éƒ¨åˆ†ï¼š</p>
<ul>
<li>æ–°å¢ <code>deleteChannel()</code> å‡½æ•°ï¼Œç”¨äºåˆ é™¤ Channelã€‚</li>
</ul>
<p>Server éƒ¨åˆ†ï¼š</p>
<ul>
<li>æ–°å¢ <code>deleteConnection()</code> å‡½æ•°ã€‚</li>
</ul>
<p>æ›´å¤šç»†èŠ‚ä¸Šçš„å˜åŒ–ï¼ˆå¯èƒ½æœ‰éƒ¨åˆ†é”™è¯¯å¤„ç†ã€å˜é‡å˜åŒ–ï¼‰å¯æ¯”è¾ƒå‰ä¸€å¤©çš„æ–‡ä»¶ã€‚</p>
<p><em>æœåŠ¡å™¨ä¸­è¿˜å¯èƒ½æœ‰æ½œåœ¨çš„bugã€‚</em></p>
<p>æœ€åï¼Œæ·»åŠ æµ‹è¯•è¿æ¥çš„ç¨‹åº <code>test.cpp</code>ï¼Œä½¿ç”¨å‘½ä»¤ <code>make t</code> ç¼–è¯‘ï¼Œä½¿ç”¨å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./test -t 1000 -m 10 -w 100</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><code>-t</code> è¡¨ç¤ºçº¿ç¨‹æ•°é‡ï¼Œæ­¤å¤„ä¸º 1000 ä¸ªçº¿ç¨‹è¿›è¡ŒæœåŠ¡å™¨è¿æ¥ï¼›</li>
<li><code>-m</code> è¡¨ç¤ºæ¯ä¸ªçº¿ç¨‹çš„å›æ˜¾æ¬¡æ•°ï¼Œæ­¤å¤„ä¸ºæ¯ä¸ªçº¿ç¨‹å›æ˜¾ 10 æ¬¡ï¼›</li>
<li><code>-w</code> è¡¨ç¤ºæ¯ä¸ªçº¿ç¨‹çš„ç­‰å¾…æ—¶é—´ï¼Œå¯ä»¥æµ‹è¯•æœ€å¤§è¿æ¥æ•°ï¼Œå¯ä»¥ä¸è®¾ç½®ã€‚</li>
</ul>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day10">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day10">Gitee</a></p>
<h2 id="åä¸€-æ”¹å†™æˆä¸»ä»reactorå¤šçº¿ç¨‹æ¨¡å¼">åä¸€ã€æ”¹å†™æˆä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å¼</h2>
<h3 id="11-1-ä»€ä¹ˆæ˜¯ä¸»ä»reactorå¤šçº¿ç¨‹æ¨¡å¼">11.1 ä»€ä¹ˆæ˜¯ä¸»ä»Reactorå¤šçº¿ç¨‹æ¨¡å¼</h3>
<p>ç°åœ¨å®ç°çš„æœåŠ¡å™¨å¤šçº¿ç¨‹ Reactor æ¨¡å¼ï¼Œæ˜¯ç»™æ¯ä¸€ä¸ª Channel çš„ä»»åŠ¡åˆ†é…ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œã€‚ä½†ç›®å‰çš„çº¿ç¨‹æ± å¯¹è±¡ç½®äº EventLoop ä¸­ï¼Œè€Œä¸æ˜¯ç”±æœåŠ¡å™¨ç±» Server ç±»ç®¡ç†ã€‚</p>
<p>ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å¼æ˜¯å¤§å¤šæ•°é«˜æ€§èƒ½æœåŠ¡å™¨é‡‡ç”¨çš„æ¨¡å¼ã€‚</p>
<blockquote>
<p>é™ˆç¡•ã€ŠLinuxå¤šçº¿ç¨‹æœåŠ¡å™¨ç¼–ç¨‹ã€‹ä¹¦ä¸­çš„ one loop per thread æ¨¡å¼ã€‚</p>
</blockquote>
<p>è¯¥æ¨¡å¼çš„ç‰¹ç‚¹æœ‰ï¼š</p>
<ul>
<li>æœåŠ¡å™¨ä¸€èˆ¬åªæœ‰ä¸€ä¸ª main Reactorï¼Œæœ‰å¤šä¸ª sub Reactorã€‚</li>
<li>æœåŠ¡å™¨ç®¡ç†ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ¯ä¸€ä¸ª sub Reactor ç”±ä¸€ä¸ªçº¿ç¨‹æ¥è´Ÿè´£ Connection ä¸Šçš„äº‹ä»¶å¾ªç¯ï¼Œäº‹ä»¶æ‰§è¡Œä¹Ÿåœ¨è¿™ä¸ªçº¿ç¨‹ä¸­å®Œæˆã€‚</li>
<li>main Reactor åªè´Ÿè´£ Acceptor å»ºç«‹æ–°è¿æ¥ï¼Œç„¶åå°†è¿™ä¸ªè¿æ¥åˆ†é…ç»™ä¸€ä¸ª sub Reactorã€‚</li>
</ul>
<h3 id="11-2-ä»£ç ä¸Šçš„å˜åŒ–">11.2 ä»£ç ä¸Šçš„å˜åŒ–</h3>
<p>æ ¹æ®ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å¼çš„ç‰¹ç‚¹ï¼Œå°†æœåŠ¡å™¨ç±»é‡å†™å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	EventLoop *mainReactor;						<span class="comment">// åªè´Ÿè´£æ¥å—è¿æ¥ï¼Œç„¶ååˆ†å‘ç»™ä¸€ä¸ªsubReactor</span></span><br><span class="line">	Acceptor *acceptor;							<span class="comment">// è¿æ¥æ¥å—å™¨</span></span><br><span class="line">	std::vector&lt;EventLoop *&gt; subReactors;		<span class="comment">// è´Ÿè´£å¤„ç†äº‹ä»¶å¾ªç¯</span></span><br><span class="line">	std::map&lt;<span class="type">int</span>, Connection *&gt; connections;	<span class="comment">// å­˜å‚¨è¿æ¥åŠå…¶ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">	ThreadPool *threadPool;						<span class="comment">// çº¿ç¨‹æ± </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨æœ‰ä¸€ä¸ªæ–°è¿æ¥åˆ°æ¥æ—¶ï¼Œé‡‡ç”¨éšæœºè°ƒåº¦ç­–ç•¥åˆ†é…ç»™ä¸€ä¸ª subReactorï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> random = _socket-&gt;<span class="built_in">getFd</span>() % subReactors.<span class="built_in">size</span>();</span><br><span class="line">Connection *conn = <span class="keyword">new</span> <span class="built_in">Connection</span>(subReactors[random], _socket);</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>è¿™ç§è°ƒåº¦ç®—æ³•é€‚ç”¨äºæ¯ä¸ªsocketä¸Šçš„ä»»åŠ¡å¤„ç†æ—¶é—´åŸºæœ¬ç›¸åŒï¼Œå¯ä»¥è®©æ¯ä¸ªçº¿ç¨‹å‡åŒ€è´Ÿè½½ã€‚ä½†äº‹å®ä¸Šï¼Œä¸åŒçš„ä¸šåŠ¡ä¼ è¾“çš„æ•°æ®ææœ‰å¯èƒ½ä¸ä¸€æ ·ï¼Œä¹Ÿå¯èƒ½å—åˆ°ç½‘ç»œæ¡ä»¶ç­‰å› ç´ çš„å½±å“ï¼Œææœ‰å¯èƒ½ä¼šé€ æˆä¸€äº› subReactor çº¿ç¨‹ååˆ†ç¹å¿™ï¼Œè€Œå¦ä¸€äº› subReactor çº¿ç¨‹ç©ºç©ºå¦‚ä¹Ÿã€‚æ­¤æ—¶éœ€è¦ä½¿ç”¨æ›´é«˜çº§çš„è°ƒåº¦ç®—æ³•ï¼Œå¦‚æ ¹æ®ç¹å¿™åº¦åˆ†é…ï¼Œæˆ–æ”¯æŒåŠ¨æ€è½¬ç§»è¿æ¥åˆ°å¦ä¸€ä¸ªç©ºé—² subReactor ç­‰ã€‚</li>
</ul>
<p><em>è°ƒåº¦é—®é¢˜æ˜¯ä¸ªå¾ˆæœ‰è¶£çš„é—®é¢˜ï¼Œä¼šç›´æ¥å½±å“æœåŠ¡å™¨çš„æ•ˆç‡å’Œæ€§èƒ½ã€‚</em></p>
<p>ä»£ç ä¸Šï¼Œè¿˜å°†åŸæ¥åœ¨ EventLoop çš„çº¿ç¨‹æ± å»æ‰ï¼ŒChannel ä¹Ÿä¸å†åŒºåˆ†æ˜¯å¦ä½¿ç”¨çº¿ç¨‹æ± ã€‚</p>
<p>ç°åœ¨ï¼ŒæœåŠ¡å™¨ä»¥äº‹ä»¶é©±åŠ¨ä¸ºæ ¸å¿ƒï¼ŒæœåŠ¡å™¨çº¿ç¨‹åªè´Ÿè´£ mainReactor çš„æ–°å»ºè¿æ¥ä»»åŠ¡ï¼ŒåŒæ—¶ç»´æŠ¤ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸€ä¸ªäº‹ä»¶å¾ªç¯ï¼Œæ–°è¿æ¥å»ºç«‹ååˆ†å‘ç»™ä¸€ä¸ª subReactor å¼€å§‹äº‹ä»¶ç›‘å¬ï¼Œæœ‰äº‹ä»¶å‘ç”Ÿåˆ™åœ¨å½“å‰çº¿ç¨‹å¤„ç†ã€‚</p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day11">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day11">Gitee</a></p>
<h2 id="åäºŒ-é¡¹ç›®å·¥ç¨‹åŒ–">åäºŒã€é¡¹ç›®å·¥ç¨‹åŒ–</h2>
<p>ç›®å‰æœåŠ¡å™¨çš„ç»“æ„æ˜¯ä¸»ä» Reactor å¤šçº¿ç¨‹æ¨¡å¼ï¼Œæ˜¯æ¯”è¾ƒä¸»æµçš„æ¨¡å¼ã€‚æ‰€ä»¥å¤§ä½“ä¸Šçš„æ–¹å‘å·²ç»ç¡®å®šï¼Œæ¥ä¸‹æ¥å¯¹ç»†èŠ‚è¿›è¡Œä¼˜åŒ–ï¼ŒæŠŠé¡¹ç›®å·¥ç¨‹åŒ–ã€‚</p>
<h3 id="12-1-è®¤è¯†cmake">12.1 è®¤è¯†Cmake</h3>
<p>é¦–å…ˆï¼ŒCMakeæ˜¯ä¸€ä¸ªè·¨å¹³å°çš„ç¼–è¯‘å·¥å…·ï¼Œå¯ä»¥ç”¨ç®€å•çš„è¯­å¥è¿›è¡Œç¼–è¯‘ã€‚</p>
<p>ä¸€ä¸ªé¡¹ç›®ä½¿ç”¨ CMake ç»´æŠ¤ä¸€ä¸ª <code>CMakeLists.txt</code> é…ç½®æ–‡ä»¶æ¥æè¿°ä¸€ä¸ªé¡¹ç›®çš„ç¼–è¯‘è¿‡ç¨‹ã€‚åˆ©ç”¨è¿™ä¸ªæ–‡ä»¶ï¼Œå°±å¯ä»¥æ­å»ºèµ·æ¥è¿™ä¸ªé¡¹ç›®ã€‚</p>
<p>ç›®å‰å°†æ‰€æœ‰æ–‡ä»¶éƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶å¤¹ï¼Œå¹¶ä¸”æ²¡æœ‰åˆ†ç±»ã€‚éšç€é¡¹ç›®è¶Šæ¥è¶Šå¤æ‚ã€æ¨¡å—è¶Šæ¥è¶Šå¤šï¼Œå¼€å‘è€…éœ€è¦è€ƒè™‘è¿™åº§å±å±±çš„å¯è¯»æ€§ï¼Œå¦‚å°†æ¨¡å—æ‹†åˆ†åˆ°ä¸åŒæ–‡ä»¶å¤¹ï¼Œå°†å¤´æ–‡ä»¶ç»Ÿä¸€æ”¾åœ¨ä¸€èµ·ç­‰ã€‚</p>
<p>å¯¹äºè¿™æ ·å¤æ‚çš„é¡¹ç›®ï¼Œå¦‚æœæ‰‹å†™å¤æ‚çš„Makefileæ¥ç¼–è¯‘é“¾æ¥ï¼Œé‚£ä¹ˆå°†ä¼šç›¸å½“è´Ÿè´£ç¹çã€‚æˆ‘ä»¬åº”å½“ä½¿ç”¨ CMake æ¥ç®¡ç†æˆ‘ä»¬çš„é¡¹ç›®ï¼ŒCMake çš„ä½¿ç”¨éå¸¸ç®€å•ã€åŠŸèƒ½å¼ºå¤§ï¼Œä¼šå¸®æˆ‘ä»¬è‡ªåŠ¨ç”Ÿæˆ Makefile æ–‡ä»¶ï¼Œä½¿é¡¹ç›®çš„ç¼–è¯‘é“¾æ¥æ›´åŠ å®¹æ˜“ï¼Œç¨‹åºå‘˜å¯ä»¥å°†æ›´å¤šçš„ç²¾åŠ›æ”¾åœ¨å†™ä»£ç ä¸Šã€‚</p>
<p>è¿™æ˜¯ <code>CmakeLists.txt</code> åŸºæœ¬ç»“æ„ï¼š</p>
<figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># xxxï¼šæœ¬ CMakeLists.txt çš„ project åç§°</span></span><br><span class="line"><span class="comment"># ä¼šè‡ªåŠ¨åˆ›å»ºä¸¤ä¸ªå˜é‡ï¼ŒPROJECT_SOURCE_DIR å’Œ PROJECT_NAME</span></span><br><span class="line"><span class="comment"># ${PROJECT_SOURCE_DIR}ï¼šæœ¬ CMakeLists.txt æ‰€åœ¨çš„æ–‡ä»¶å¤¹è·¯å¾„</span></span><br><span class="line"><span class="comment"># ${PROJECT_NAME}ï¼šæœ¬CMakeLists.txt çš„ project åç§°</span></span><br><span class="line"><span class="keyword">project</span>(xxx)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–è·¯å¾„ä¸‹æ‰€æœ‰çš„.cpp/.c/.ccæ–‡ä»¶ï¼Œå¹¶èµ‹å€¼ç»™å˜é‡ä¸­</span></span><br><span class="line"><span class="keyword">aux_source_directory</span>(è·¯å¾„ å˜é‡)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™æ–‡ä»¶å/è·¯å¾„åæˆ–å…¶ä»–å­—ç¬¦ä¸²èµ·åˆ«åï¼Œç”¨${å˜é‡}è·å–å˜é‡å†…å®¹</span></span><br><span class="line"><span class="keyword">set</span>(å˜é‡ æ–‡ä»¶å/è·¯å¾„/...)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç¼–è¯‘é€‰é¡¹</span></span><br><span class="line"><span class="keyword">add_definitions</span>(ç¼–è¯‘é€‰é¡¹)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">message</span>(æ¶ˆæ¯)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘å­æ–‡ä»¶å¤¹çš„CMakeLists.txt</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(å­æ–‡ä»¶å¤¹åç§°)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†.cpp/.c/.ccæ–‡ä»¶ç”Ÿæˆ.aé™æ€åº“</span></span><br><span class="line"><span class="comment"># æ³¨æ„ï¼Œåº“æ–‡ä»¶åç§°é€šå¸¸ä¸ºlibxxx.soï¼Œåœ¨è¿™é‡Œåªè¦å†™xxxå³å¯</span></span><br><span class="line"><span class="keyword">add_library</span>(åº“æ–‡ä»¶åç§° STATIC æ–‡ä»¶)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†.cpp/.c/.ccæ–‡ä»¶ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">add_executable</span>(å¯æ‰§è¡Œæ–‡ä»¶åç§° æ–‡ä»¶)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§„å®š.hå¤´æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="keyword">include_directories</span>(è·¯å¾„)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§„å®š.so/.aåº“æ–‡ä»¶è·¯å¾„</span></span><br><span class="line"><span class="keyword">link_directories</span>(è·¯å¾„)</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹add_libraryæˆ–add_executableç”Ÿæˆçš„æ–‡ä»¶è¿›è¡Œé“¾æ¥æ“ä½œ</span></span><br><span class="line"><span class="comment"># æ³¨æ„ï¼Œåº“æ–‡ä»¶åç§°é€šå¸¸ä¸ºlibxxx.soï¼Œåœ¨è¿™é‡Œåªè¦å†™xxxå³å¯</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(åº“æ–‡ä»¶åç§°/å¯æ‰§è¡Œæ–‡ä»¶åç§° é“¾æ¥çš„åº“æ–‡ä»¶åç§°)</span><br></pre></td></tr></tbody></table></figure>
<h3 id="12-2-å·¥ç¨‹åŒ–çš„å®é™…æ“ä½œ">12.2 å·¥ç¨‹åŒ–çš„å®é™…æ“ä½œ</h3>
<p>é¦–å…ˆè§„èŒƒåŒ–ç›®å½•çš„æ„ä¹‰ï¼š</p>
<ul>
<li><code>src</code> ç›®å½•ï¼ˆå³sourceï¼‰ï¼Œç”¨äºå­˜æ”¾æ ¸å¿ƒçš„ä»£ç ï¼›
<ul>
<li><code>include</code> ç›®å½•ï¼Œç”¨äºå­˜æ”¾æºä»£ç ä¸­çš„å¤´æ–‡ä»¶ï¼›</li>
</ul>
</li>
<li><code>test</code> ç›®å½•ï¼Œç”¨äºå­˜æ”¾æµ‹è¯•çš„ä»£ç ï¼›</li>
</ul>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">projiect/</span><br><span class="line">â”œâ”€src/</span><br><span class="line">â”‚ â”œâ”€include/</span><br><span class="line">â”‚ â”‚ â”œâ”€*.h</span><br><span class="line">â”‚ â”œâ”€*.cpp</span><br><span class="line">â”œâ”€test/</span><br><span class="line">â”‚ â”œâ”€*.cpp</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨è¿™ä¸€ç« ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ä¸€ä¸ª CMake å·¥ç¨‹ï¼Œæ‰€ä»¥ Visual Studio åˆ›å»ºçš„æ˜¯ CMake é¡¹ç›®ã€‚æ¥ä¸‹æ¥å°±æ˜¯ CMake çš„é…ç½®å·¥ä½œã€‚ï¼ˆ<em>æœ‰å…³ CMake çš„å®‰è£…ä½¿ç”¨å¯å‚è€ƒé™„ 2</em>ï¼‰</p>
<p>æ„å»ºä¸Šè¿°æ–‡ä»¶ç›®å½•ï¼Œå°†å¯¹åº”çš„æ–‡ä»¶åˆ†ç±»è¿›å»ã€‚</p>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-1.jpg" title="æ–‡ä»¶ç»“æ„" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-1.jpg" alt="æ–‡ä»¶ç»“æ„"></a></p>
<p>æ¥ç€ï¼Œå¼€å§‹ç¼–å†™é¡¹ç›®çš„æ ¹ <code>CMakeLists.txt</code> æ–‡ä»¶ï¼ˆå³æ ¹ç›®å½•ä¸‹çš„ <code>CMakeLists.txt</code> ï¼‰ï¼š</p>
<figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.10</span>)    <span class="comment"># CMakeè¿è¡Œçš„æœ€å°ç‰ˆæœ¬</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_EXPORT_COMPILE_COMMANDS <span class="keyword">ON</span>)   <span class="comment"># å¯ç”¨ç¼–è¯‘å‘½ä»¤çš„å¯¼å‡ºï¼Œå¸¸ä¸ä»£ç åˆ†æå·¥å…·é…åˆä½¿ç”¨</span></span><br><span class="line"><span class="keyword">set</span>(BUILD_SHARED_LIBS <span class="keyword">ON</span>)               <span class="comment"># æ„å»ºå…±äº«ï¼ˆåŠ¨æ€ï¼‰åº“</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">17</span>)              <span class="comment"># è®¾ç½®C++æ ‡å‡†ä¸º17</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD_REQUIRED <span class="keyword">ON</span>)     <span class="comment"># è¦æ±‚ç¼–è¯‘å™¨æ”¯æŒC++17</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–è¯‘å™¨</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_C_COMPILER <span class="string">"clang"</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_COMPILER <span class="string">"clang++"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é¡¹ç›®ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">project</span>(Day12           <span class="comment"># é¡¹ç›®åç§°</span></span><br><span class="line">        LANGUAGES CXX   <span class="comment"># é¡¹ç›®è¯­è¨€</span></span><br><span class="line">       )</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ºæºä»£ç å’Œæµ‹è¯•æ·»åŠ å­ç›®å½•</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(src)</span><br><span class="line"><span class="keyword">add_subdirectory</span>(<span class="keyword">test</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®åŒ…å«ç›®å½•</span></span><br><span class="line"><span class="keyword">set</span>(SRC_INCLUDE_DIR <span class="variable">${PROJECT_SOURCE_DIR}</span>/src/<span class="keyword">include</span>)</span><br><span class="line"><span class="comment"># set(TEST_INCLUDE_DIR ${PROJECT_SOURCE_DIR}/test/include)</span></span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">${SRC_INCLUDE_DIR}</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è¾“å‡ºç›®å½•</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_ARCHIVE_OUTPUT_DIRECTORY <span class="variable">${CMAKE_BINARY_DIR}</span>/lib)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_LIBRARY_OUTPUT_DIRECTORY <span class="variable">${CMAKE_BINARY_DIR}</span>/lib)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY <span class="variable">${CMAKE_BINARY_DIR}</span>/bin)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç¼–è¯‘å’Œé“¾æ¥é€‰é¡¹</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS <span class="string">"${CMAKE_CXX_FLAGS} -fPIC -Wall -Wextra -std=c++17 -pthread"</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_FLAGS_DEBUG <span class="string">"${CMAKE_CXX_FLAGS_DEBUG} -O0 -ggdb -fsanitize=address -fno-omit-frame-pointer -fno-optimize-sibling-calls"</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_EXE_LINKER_FLAGS  <span class="string">"${CMAKE_EXE_LINKER_FLAGS} -fPIC"</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_SHARED_LINKER_FLAGS <span class="string">"${CMAKE_SHARED_LINKER_FLAGS} -fPIC"</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_STATIC_LINKER_FLAGS <span class="string">"${CMAKE_STATIC_LINKER_FLAGS} -fPIC"</span>)</span><br><span class="line"><span class="keyword">set</span>(GCC_COVERAGE_LINK_FLAGS <span class="string">"-fPIC"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ˜¾ç¤ºç¼–è¯‘å™¨å’Œé“¾æ¥å™¨æ ‡å¿—</span></span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">"CMAKE_CXX_FLAGS: ${CMAKE_CXX_FLAGS}"</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">"CMAKE_CXX_FLAGS_DEBUG: ${CMAKE_CXX_FLAGS_DEBUG}"</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">"CMAKE_EXE_LINKER_FLAGS: ${CMAKE_EXE_LINKER_FLAGS}"</span>)</span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">"CMAKE_SHARED_LINKER_FLAGS: ${CMAKE_SHARED_LINKER_FLAGS}"</span>)</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li>ç¬¬ä¸€æ¬¡æ¥è§¦ CMake å‘½ä»¤å¯ä»¥å‚è€ƒæ³¨é‡Šç†è§£ã€‚</li>
</ul>
<p>æ¥ç€ï¼Œå°è¯•æŠŠæˆ‘ä»¬å…³äºæœåŠ¡å™¨çš„è®¾è®¡æ‰“åŒ…æˆä¸€ä¸ªåº“ï¼Œå³ç¼–å†™ <code>src/CMakeLists.txt</code>ï¼š</p>
<figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®åŒ…å«ç›®å½•</span></span><br><span class="line"><span class="keyword">set</span>(SRC_INCLUDE_DIR <span class="variable">${PROJECT_SOURCE_DIR}</span>/src/<span class="keyword">include</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">${SRC_INCLUDE_DIR}</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># é€’å½’æœç´¢/srcç›®å½•ä¸­çš„æ‰€æœ‰.cppæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">file</span>(GLOB_RECURSE day12_sources <span class="variable">${PROJECT_SOURCE_DIR}</span>/src/*.cpp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å…±äº«åº“é“¾æ¥é€‰é¡¹</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_SHARED_LINKER_FLAGS <span class="string">"${CMAKE_SHARED_LINKER_FLAGS}  -fPIC -pthread"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨æºæ–‡ä»¶åˆ›å»ºä¸€ä¸ªåä¸ºday12_sharedçš„å…±äº«åº“</span></span><br><span class="line"><span class="keyword">add_library</span>(day12_shared SHARED <span class="variable">${day12_sources}</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>ç„¶åï¼ŒæŠŠæµ‹è¯•æ–‡ä»¶çš„ <code>CMakeLists.txt</code>ï¼ˆå³ <code>test/CMakeLists.txt</code>ï¼‰ä¹Ÿç¼–å†™ä¸€ä¸‹ï¼Œç”¨äºç®¡ç†æµ‹è¯•æ–‡ä»¶çš„ç¼–è¯‘ï¼š</p>
<figure class="highlight cmake"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®åŒ…å«ç›®å½•</span></span><br><span class="line"><span class="keyword">set</span>(SRC_INCLUDE_DIR <span class="variable">${PROJECT_SOURCE_DIR}</span>/src/<span class="keyword">include</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">${SRC_INCLUDE_DIR}</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®å˜é‡TEST_SOURCESï¼Œå°†æ‰€æœ‰.cppæ–‡ä»¶å­˜å‚¨åœ¨æµ‹è¯•ç›®å½•ä¸­</span></span><br><span class="line"><span class="keyword">file</span>(GLOB TEST_SOURCES <span class="string">"${PROJECT_SOURCE_DIR}/test/*.cpp"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºåä¸ºâ€œbuild-testsâ€çš„è‡ªå®šä¹‰ç›®æ ‡ä»¥ä»…æ˜¾ç¤ºæµ‹è¯•</span></span><br><span class="line"><span class="keyword">add_custom_target</span>(build-tests <span class="keyword">COMMAND</span> <span class="variable">${CMAKE_CTEST_COMMAND}</span> --show-only)</span><br><span class="line"><span class="comment"># åˆ›å»ºåä¸ºâ€œcheck-testsâ€çš„è‡ªå®šä¹‰ç›®æ ‡ä»¥åœ¨è¯¦ç»†æ¨¡å¼ä¸‹è¿è¡Œæµ‹è¯•</span></span><br><span class="line"><span class="keyword">add_custom_target</span>(check-tests <span class="keyword">COMMAND</span> <span class="variable">${CMAKE_CTEST_COMMAND}</span> --verbose)</span><br><span class="line"></span><br><span class="line"><span class="comment"># éå†TEST_SOURCESä¸­çš„æ¯ä¸ªæµ‹è¯•æºæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">foreach</span> (test_source <span class="variable">${TEST_SOURCES}</span>)</span><br><span class="line">    <span class="comment"># ç»„åˆä¸ºå¯è¯»çš„åç§°ï¼Œä½¿å¾—æ¯ä¸ªCppéƒ½å¯ä»¥make</span></span><br><span class="line">    <span class="keyword">get_filename_component</span>(test_filename <span class="variable">${test_source}</span> NAME)</span><br><span class="line">    <span class="keyword">string</span>(REPLACE <span class="string">".cpp"</span> <span class="string">""</span> test_name <span class="variable">${test_filename}</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ä¸ºæµ‹è¯•æ·»åŠ å¯æ‰§è¡Œç›®æ ‡ï¼Œé»˜è®¤æƒ…å†µä¸‹å°†å…¶ä»æ‰€æœ‰ç”Ÿæˆä¸­æ’é™¤</span></span><br><span class="line">    <span class="keyword">add_executable</span>(<span class="variable">${test_name}</span> EXCLUDE_FROM_ALL <span class="variable">${test_source}</span>)</span><br><span class="line">    <span class="comment"># æ·»åŠ å¯¹ç”Ÿæˆæµ‹è¯•å’Œæ£€æŸ¥æµ‹è¯•çš„ä¾èµ–é¡¹</span></span><br><span class="line">    <span class="keyword">add_dependencies</span>(build-tests <span class="variable">${test_name}</span>)</span><br><span class="line">    <span class="keyword">add_dependencies</span>(check-tests <span class="variable">${test_name}</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># å°†â€œday12_sharedâ€åº“é“¾æ¥åˆ°å¯æ‰§è¡Œæµ‹è¯•æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">target_link_libraries</span>(<span class="variable">${test_name}</span> day12_shared)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># è®¾ç½®æµ‹è¯•ç›®æ ‡çš„å±æ€§ï¼ŒæŒ‡å®šè¾“å‡ºç›®å½•å’Œè¿è¡Œæµ‹è¯•çš„å‘½ä»¤</span></span><br><span class="line">    <span class="keyword">set_target_properties</span>(<span class="variable">${test_name}</span></span><br><span class="line">        PROPERTIES</span><br><span class="line">        RUNTIME_OUTPUT_DIRECTORY <span class="string">"${CMAKE_BINARY_DIR}/bin"</span></span><br><span class="line">        <span class="keyword">COMMAND</span> <span class="variable">${test_name}</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endforeach</span>(test_source <span class="variable">${TEST_SOURCES}</span>)</span><br></pre></td></tr></tbody></table></figure>
<p>å½“ç„¶ï¼Œè¿™ç« åœ¨ä»£ç ä¸Šä¹Ÿæœ‰äº›è®¸ä¿®æ”¹ï¼Œæ¯”å¦‚å‡½æ•°å‚æ•°åšäº† <code>const &amp;</code>ï¼Œç±»ä¹Ÿç¦æ­¢äº†æ‹·è´å’Œç§»åŠ¨æ“ä½œã€‚</p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day12">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day12">Gitee</a></p>
<p>æ¥ç€åªéœ€è¦æŠŠé¡¹ç›®éƒ¨ç½²åˆ°è¿œç¨‹ Linux æœåŠ¡å™¨ï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç¼–è¯‘å³å¯ï¼š</p>
<ul>
<li><code>make server</code>ï¼šç¼–è¯‘æœåŠ¡ç«¯ä»£ç </li>
<li><code>make SingleClient</code>ï¼šç¼–è¯‘å•ä¸ªå®¢æˆ·ç«¯è¿æ¥ä»£ç </li>
<li><code>make MultipleClients</code>ï¼šç¼–è¯‘å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥ä»£ç </li>
<li><code>make clean</code>ï¼šæ¸…ç†ç”Ÿæˆ</li>
</ul>
<p>è¿è¡Œåªéœ€è¦ï¼š</p>
<ul>
<li><code>./bin/server</code>ï¼šå¯åŠ¨æœåŠ¡ç«¯</li>
<li><code>./bin/SingleClient</code>ï¼šå¯åŠ¨å•ä¸ªå®¢æˆ·ç«¯è¿æ¥</li>
<li><code>./bin/MultipleClients -t çº¿ç¨‹æ•° -m å›æ˜¾æ¶ˆæ¯æ•° -w å»¶æ—¶å‘é€ä¿¡æ¯</code>ï¼šå¯åŠ¨å¤šä¸ªå®¢æˆ·ç«¯è¿æ¥</li>
</ul>
<blockquote>
<p>åŸä½œè€…è¿˜è¿›è¡Œäº†ä»£ç é™æ€åˆ†æå’Œä»£ç æ ¼å¼åŒ–ï¼Œè¯¦è§åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://github.com/yuesong-feng/30dayMakeCppServer/blob/main/day13-C%2B%2B%E5%B7%A5%E7%A8%8B%E5%8C%96%E3%80%81%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90%E3%80%81%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.md">Github</a></p>
</blockquote>
<h2 id="åä¸‰-ä¸šåŠ¡é€»è¾‘è‡ªå®šä¹‰åŒ–">åä¸‰ã€ä¸šåŠ¡é€»è¾‘è‡ªå®šä¹‰åŒ–</h2>
<h3 id="13-1-ä¸šåŠ¡é€»è¾‘æ€æƒ³">13.1 ä¸šåŠ¡é€»è¾‘æ€æƒ³</h3>
<p>é¦–å…ˆå›é¡¾ä¹‹å‰çš„æ€æƒ³ï¼Œæˆ‘ä»¬ç›®å‰æœåŠ¡å™¨åªæœ‰ä¸€ä¸ªåŠŸèƒ½ï¼Œå°±æ˜¯è¿›è¡Œå›å£°ï¼ˆEchoï¼‰ï¼šæŠŠå®¢æˆ·ç«¯å‘æ¥çš„æ¶ˆæ¯å†å‘é€å›å»ã€‚è€Œè¿™ä¸ªåŠŸèƒ½ï¼Œæˆ–è€…è¯´ä¸šåŠ¡é€»è¾‘ï¼Œå°±å›ºå®šåœ¨ <code>Connection</code> ç±»ã€‚</p>
<p>è€Œé€šè¿‡ç¬¬åäºŒç« çš„è®¾è®¡ï¼Œæˆ‘ä»¬æŠŠç½‘ç»œæ–¹é¢çš„ä»£ç æ•´åˆä¸ºä¸€ä¸ªé“¾æ¥åº“ã€‚å¾ˆæ˜æ˜¾ï¼Œä½œä¸ºä¸€ä¸ªåº“ï¼Œå¹¶ä¸èƒ½å°±è¿™æ ·æŠŠä¸šåŠ¡é€»è¾‘å›ºå®šäº†ï¼Œåº”è¯¥æ”¯æŒä¸šåŠ¡é€»è¾‘è‡ªå®šä¹‰ã€‚</p>
<p>ä¸šåŠ¡é€»è¾‘ç”±ç”¨æˆ·è‡ªå®šä¹‰ï¼Œç„¶åä½¿ç”¨ç½‘ç»œåº“è¿›è¡ŒæœåŠ¡å™¨ä¸å®¢æˆ·ç«¯é—´çš„äº¤äº’ã€‚</p>
<blockquote>
<p>æ€æ ·äº‹ä»¶è§¦å‘ã€è¯»å–æ•°æ®ã€å¼‚å¸¸å¤„ç†ç­‰æµç¨‹åº”è¯¥æ˜¯ç½‘ç»œåº“æä¾›çš„åŸºæœ¬åŠŸèƒ½ï¼Œç”¨æˆ·åªåº”å½“å…³æ³¨æ€æ ·å¤„ç†ä¸šåŠ¡å³å¯ï¼Œæ‰€ä»¥ä¸šåŠ¡é€»è¾‘çš„è¿›å…¥ç‚¹åº”è¯¥æ˜¯æœåŠ¡å™¨è¯»å–å®Œå®¢æˆ·ç«¯çš„æ‰€æœ‰æ•°æ®ä¹‹åã€‚è¿™æ—¶ï¼Œå®¢æˆ·ç«¯ä¼ æ¥çš„è¯·æ±‚åœ¨ <code>Connection</code> ç±»çš„è¯»ç¼“å†²åŒºé‡Œï¼Œåªéœ€è¦æ ¹æ®è¯·æ±‚æ¥åˆ†å‘ã€å¤„ç†ä¸šåŠ¡å³å¯ã€‚</p>
</blockquote>
<p>æ€»ä½“ä¸Šï¼ŒæœåŠ¡å™¨ç«¯æå‡ºè¿™æ ·çš„è®¾è®¡ï¼š</p>
<ul>
<li>å…·æœ‰ä¸€ä¸ª <code>Server</code> ç±»å’Œä¸€ä¸ªäº‹ä»¶å¾ªç¯ç±»ã€‚</li>
<li>é€šè¿‡å›è°ƒå‡½æ•°çš„æ–¹å¼ç¼–å†™ä¸šåŠ¡é€»è¾‘ï¼Œä¼ ç»™ <code>Server</code> ç±»çš„å®ä¾‹ã€‚
<ul>
<li>åªéœ€å…³å¿ƒæœåŠ¡å™¨çš„å¤„ç†æ–¹æ³•ï¼Œæ¯”å¦‚ä¸€ä¸ª Echo æœåŠ¡å™¨åªéœ€è¦æŠŠå¯¹æ–¹å‘æ¥çš„ä¿¡æ¯å‘å›å»ã€‚é€šè¿‡è®¾ç½® <code>onMessage</code> å›è°ƒå‡½æ•°æ¥è‡ªå®šä¹‰è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œåœ¨æœåŠ¡å™¨å®Œå…¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ä¹‹åï¼Œè¯¥å‡½æ•°è§¦å‘ã€‚</li>
<li>å¯ä»¥è®¾ç½®è¿æ¥æ—¶çš„ä¸šåŠ¡é€»è¾‘å’Œæ•´ä¸ªæœåŠ¡ç«¯çš„ä¸šåŠ¡é€»è¾‘ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Server *server = <span class="keyword">new</span> <span class="built_in">Server</span>(loop);</span><br><span class="line"></span><br><span class="line">server-&gt;<span class="built_in">newConnect</span>([] (Connection *conn) </span><br><span class="line">	{</span><br><span class="line">		<span class="comment">// æœåŠ¡å™¨å¯¹æœ‰æ–°è¿æ¥æ—¶çš„æ“ä½œå‡½æ•°</span></span><br><span class="line">	});</span><br><span class="line"></span><br><span class="line">server-&gt;<span class="built_in">onMessage</span>([] (Connection *conn)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">// æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯æ¶ˆæ¯çš„æ“ä½œå‡½æ•°</span></span><br><span class="line">	});</span><br></pre></td></tr></tbody></table></figure>
<p>å¦å¤–ï¼Œå¸Œæœ›å®¢æˆ·ç«¯çš„ä»£ç ä¹Ÿå¯ä»¥é€šè¿‡æˆ‘ä»¬çš„ç½‘ç»œåº“è¿›è¡Œå®ç°ï¼šå°† <code>Connection</code> ç±»è¿›è¡Œå®Œå–„ï¼Œä½¿å¾—å…¶æ»¡è¶³æœåŠ¡ç«¯ï¼ˆServer â†’ Clientï¼‰å’Œå®¢æˆ·ç«¯ï¼ˆClient â†’ Serverï¼‰çš„ä½¿ç”¨ï¼š</p>
<ul>
<li>æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„ä¼ è¾“æ•°æ®æ–¹å‘æ˜¯ç›¸åçš„ï¼šå¯¹äºæœåŠ¡ç«¯ï¼Œå®ƒä»å®¢æˆ·ç«¯ä¸­è¯»å–æ•°æ®ï¼Œæˆ–è€…å†™å…¥æ•°æ®åˆ°å®¢æˆ·ç«¯ï¼›å¯¹äºå®¢æˆ·ç«¯ï¼Œå®ƒä»æœåŠ¡ç«¯ä¸­è¯»å–æ•°æ®ï¼Œæˆ–è€…å†™å…¥æ•°æ®åˆ°æœåŠ¡ç«¯ã€‚</li>
<li>åœ¨å‘å›æ•°æ®æ—¶ï¼Œåº”è¯¥è€ƒè™‘å¯¹æ–¹æ˜¯å¦å·²ç»å…³é—­äº†é“¾æ¥ã€‚æ‰€ä»¥è¿˜éœ€è¦è®¾è®¡ <code>Connection</code> çš„çŠ¶æ€ã€‚</li>
</ul>
<p>æ€»ä½“ä¸Šï¼Œå®¢æˆ·ç«¯è¦ä½¿ç”¨ Connection ç±»ï¼Œæå‡ºè¿™æ ·çš„è®¾è®¡ï¼š</p>
<ul>
<li>æä¾› <code>write()</code> å’Œ <code>read()</code> å‡½æ•°ã€‚
<ul>
<li><code>write()</code> å‡½æ•°è¡¨ç¤ºå°†å†™ç¼“å†²åŒºé‡Œçš„å†…å®¹å‘é€åˆ°è¯¥ <code>Connection</code> çš„ socketï¼Œå‘é€åä¼šæ¸…ç©ºå†™ç¼“å†²åŒºï¼›</li>
<li><code>read()</code> å‡½æ•°è¡¨ç¤ºæ¸…ç©ºè¯»ç¼“å†²åŒºï¼Œç„¶åå°† TCP ç¼“å†²åŒºå†…çš„æ•°æ®è¯»å–åˆ°è¯»ç¼“å†²åŒºã€‚</li>
</ul>
</li>
<li>è€ƒè™‘ <code>Connection</code> çš„çŠ¶æ€ <code>State</code>ã€‚</li>
</ul>
<h3 id="13-2-æ“åˆ€åŠ¨ä»£ç ">13.2 æ“åˆ€åŠ¨ä»£ç </h3>
<p>æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œ<code>Server</code> è¿›è¡Œæ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>å°† <code>Server</code> ç±»è¿›è¡Œæ”¹å†™ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">// ......</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(Connection *)&gt; onConnectionCallback;	<span class="comment">// è¿æ¥çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(Connection *)&gt; onMessageCallback;	<span class="comment">// æ¶ˆæ¯çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(Connection *)&gt; newConnectCallback;	<span class="comment">// æ–°è¿æ¥çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @brief è®¾ç½®æœåŠ¡å™¨çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">	 * @param fn ä¸šåŠ¡é€»è¾‘å‡½æ•°</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">onConnect</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; fn)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @brief è®¾ç½®æ¥æ”¶æ¶ˆæ¯æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">	 * @param fn å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; fn)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * @brief è®¾ç½®åœ¨å»ºç«‹æ–°è¿æ¥æ—¶è°ƒç”¨çš„å›è°ƒå‡½æ•°ã€‚</span></span><br><span class="line"><span class="comment">	 * @param fn å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">newConnect</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; fn)</span></span>;</span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ä½†æ˜¯æˆ‘ä»¬ä¸èƒ½æ€¥ï¼Œä¿®æ”¹ <code>Server</code> å¿…é¡»è¿˜å¾—å¯¹ <code>Connection</code> ç±»çš„å®Œå–„ã€‚å› ä¸ºæœåŠ¡å™¨çš„ä¸€äº›æ“ä½œæ˜¯é€šè¿‡è¿æ¥ç±»å®Œæˆï¼Œæ”¹åŠ¨å¦‚ä¸‹ï¼š</p>
<ol>
<li>æ·»åŠ è¿æ¥çŠ¶æ€ï¼ˆæ­¤å¤„å…¶å®åªå…³æ³¨æ˜¯å¦è¿æ¥å»ºç«‹å³å¯ï¼‰ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">State</span></span><br><span class="line">{</span><br><span class="line">	Invalid = <span class="number">1</span>, <span class="comment">// åˆå§‹æ— æ•ˆçŠ¶æ€</span></span><br><span class="line">	Handshaking, <span class="comment">// æ¡æ‰‹è¿‡ç¨‹ä¸­çš„çŠ¶æ€</span></span><br><span class="line">	Connected,   <span class="comment">// è¿æ¥å»ºç«‹</span></span><br><span class="line">	Closed,      <span class="comment">// è¿æ¥å…³é—­</span></span><br><span class="line">	Failed,      <span class="comment">// è¿æ¥å¤±è´¥</span></span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>æä¾›è¯»å†™å‡½æ•°ï¼ˆè¯¦ç»†è§ç« æœ« Gitee æˆ– Github é“¾æ¥ï¼‰ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Connection::read</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// åˆ¤æ–­è¿æ¥çŠ¶æ€</span></span><br><span class="line">	<span class="comment">// æ¸…ç©ºè¯»ç¼“å†²åŒº</span></span><br><span class="line">	<span class="comment">// è¯»æ“ä½œ</span></span><br><span class="line">}</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Connection::write</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// åˆ¤æ–­è¿æ¥çŠ¶æ€</span></span><br><span class="line">	<span class="comment">// å†™æ“ä½œ</span></span><br><span class="line">	<span class="comment">// æ¸…ç©ºå†™ç¼“å†²åŒº</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äºæœåŠ¡å™¨ç¨‹åºå›å‘æ¶ˆæ¯</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">send</span><span class="params">(std::string msg)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<p><em>è¯»æ“ä½œå’Œå†™æ“ä½œåŒºåˆ†æ˜¯å¦é˜»å¡ï¼šå¯¹äºå®¢æˆ·ç«¯ï¼Œä½¿ç”¨é˜»å¡è¯»å†™ï¼›å¯¹äºæœåŠ¡ç«¯ï¼Œä½¿ç”¨éé˜»å¡è¯»å†™ã€‚åœ¨åˆ¤æ–­ Socket æ˜¯å¦é˜»å¡æ—¶ï¼Œéœ€è¦æ·»åŠ ä¸ªå‡½æ•°ï¼ˆä¹‹å‰æ²¡æœ‰ï¼‰ã€‚</em></p>
<ol start="3">
<li>
<p>å°†åŸæ¥æˆå‘˜å±æ€§ <code>int fd</code> å˜æˆ <code>Socket *mSocket</code>ã€‚</p>
</li>
<li>
<p>æ·»åŠ ä¸Šå¯¹åº”çš„å›è°ƒå‡½æ•°åŠå…¶ <code>Set</code> å‡½æ•°ï¼š</p>
</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">std::function&lt;<span class="type">void</span>(Socket *)&gt; mDeleteConnectionCallback;	<span class="comment">// åˆ é™¤è¿æ¥çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">std::function&lt;<span class="type">void</span>(Connection *)&gt; mOnConnectCallback;		<span class="comment">// è¿æ¥å»ºç«‹æ—¶çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">std::function&lt;<span class="type">void</span>(Connection *)&gt; mOnMessageCallback;		<span class="comment">// ä¸šåŠ¡é€»è¾‘å›è°ƒå‡½æ•°</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief è®¾ç½®è¿æ¥æ—¶çš„ä¸šåŠ¡é€»è¾‘å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param callback å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setOnConnectionCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief å°†å›è°ƒå‡½æ•°è®¾ç½®ä¸ºåœ¨æ”¶åˆ°æ¶ˆæ¯æ—¶è°ƒç”¨</span></span><br><span class="line"><span class="comment"> * @param callback æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è°ƒç”¨çš„å‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setOnMessageCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief è®¾ç½®åˆ é™¤è¿æ¥æ—¶è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> * @param _callback åˆ é™¤è¿æ¥æ—¶è¦è°ƒç”¨çš„å›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setDeleteConnectionCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(Socket *)&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ol start="5">
<li>ç¼–å†™ä¸šåŠ¡å‡½æ•°ã€‚åœ¨æ„å»ºæœåŠ¡å™¨æ—¶æŒ‡å®šå¯¹å®¢æˆ·ç«¯æ¶ˆæ¯çš„å“åº”ï¼Œç„¶åé€šè¿‡å¯¹ <code>Server</code> ç±»çš„è®¾ç½®ï¼Œä¼ é€’åˆ° <code>Connection</code> ç±»ï¼Œæœ€åä¼ é€’åˆ° <code>Channel</code> ç±»çš„ <code>handleEvent()</code> è¿›è¡Œè°ƒç”¨ã€‚</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief è¯¥å‡½æ•°è¡¨ç¤ºä¸šåŠ¡é€»è¾‘ã€‚</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">business</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// å¤§æ¦‚æ“ä½œæœ‰ï¼š</span></span><br><span class="line">	<span class="comment">// - æ¥å—å®¢æˆ·ç«¯ä¿¡æ¯</span></span><br><span class="line">	<span class="comment">// - åšå‡ºå“åº”ï¼Œå³ mOnMessageCallback()</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>ç°åœ¨ä¹Ÿå·®ä¸å¤šäº†ï¼Œä½†æ˜¯å¯ä»¥å®Œå–„ï¼ˆé‡æ„ï¼‰ä¸€ä¸‹ <code>Channel</code> ç±»ï¼Œè®©å…¶æ„ä¹‰æ›´æ˜ç¡®ï¼Œæ›´è§„èŒƒä¸€äº›ï¼š</p>
<ol>
<li>è§„èŒƒç§æœ‰æˆå‘˜å˜é‡ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	EventLoop *mLoop;					<span class="comment">// æŒ‡å‘ä¸ä¹‹å…³è”çš„äº‹ä»¶å¾ªç¯</span></span><br><span class="line">	Socket *mSocket;					<span class="comment">// ä¸ä¹‹å…³è”çš„Socket</span></span><br><span class="line">	<span class="type">uint32_t</span> mListenEvents{ <span class="number">0</span> };		<span class="comment">// ç›‘å¬çš„äº‹ä»¶</span></span><br><span class="line">	<span class="type">uint32_t</span> mReadyEvents{ <span class="number">0</span> };			<span class="comment">// å°±ç»ªäº‹ä»¶</span></span><br><span class="line">	<span class="type">bool</span> exist{ <span class="literal">false</span> };				<span class="comment">// æŒ‡ç¤ºè¯¥Channelæ˜¯å¦å­˜åœ¨æœ‰æ•ˆ</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>()&gt; readCallback;	<span class="comment">// è¯»å›è°ƒ</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>()&gt; writeCallback;<span class="comment">// å†™å›è°ƒ</span></span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>ç¼–å†™ç›¸å…³æˆå‘˜å‡½æ•°ï¼ˆå‡½æ•°åä¿®æ”¹åè®°å¾—åœ¨å¯¹åº”è°ƒç”¨å¤„ä¿®æ”¹ï¼‰ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handleEvent</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// å¼€å¯è¯»æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">enableRead</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// å¼€å¯å†™æ“ä½œ</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">enableWrite</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ET</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">useET</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// è·å–Socket</span></span><br><span class="line"><span class="function">Socket *<span class="title">getSocket</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="comment">// è·å–ç›‘å¬äº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">getListenEvents</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// è·å–å°±ç»ªäº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="type">uint32_t</span> <span class="title">getReadyEvents</span><span class="params">()</span></span>;</span><br><span class="line"><span class="comment">// è®¾ç½®å°±ç»ªäº‹ä»¶</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setReadyEvents</span><span class="params">(<span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line"><span class="comment">// æ£€æŸ¥æœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">getExist</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line"><span class="comment">// è®¾ç½®æœ‰æ•ˆæ€§</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setExist</span><span class="params">(<span class="type">bool</span> _exist)</span></span>;</span><br><span class="line"><span class="comment">// è®¾ç½®å›è°ƒå‡½æ•°ã€‚</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">setReadCallback</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ol start="3">
<li>ä¿®æ”¹ <code>Channel</code> ç±»çš„ææ„å‡½æ•°ï¼Œå…¶ææ„ä¸º <code>loop</code> è°ƒç”¨ <code>deleteChannel()</code>ï¼ˆéœ€è¦æ·»åŠ å‡½æ•°ï¼‰ï¼ˆå®é™…ä¸Šè¿˜æ˜¯ç›¸å…³è”çš„ <code>Epoll</code> å°è£…ç±»å» <code>deleteChannel()</code>ï¼‰ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Channel::~<span class="built_in">Channel</span>()</span><br><span class="line">{</span><br><span class="line">	mLoop-&gt;<span class="built_in">deleteChannel</span>(<span class="keyword">this</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">EventLoop::deleteChannel</span><span class="params">(Channel *channel)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	ep-&gt;<span class="built_in">deleteChannel</span>(channel);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>åœ¨ä¿®æ”¹äº† Channel ç±»åï¼Œå…¶ç›¸å…³è”çš„ <code>Epoll</code> å°è£…ç±»ä¹Ÿéœ€è¦ä¿®æ”¹ï¼š</p>
<ol>
<li>ä¿®æ”¹ <code>Epoll::deleteChannel(Channel *channel)</code>ï¼Œéœ€è¦æŠŠå½“å‰çš„ <code>Channel</code> å¯¹è±¡ä» epoll ä¸­åˆ é™¤ï¼Œç„¶åè®¾ç½®æœ‰æ•ˆæ€§ä¸º <code>false</code>ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Epoll::deleteChannel</span><span class="params">(Channel *channel)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="type">int</span> fd = channel-&gt;<span class="built_in">getSocket</span>()-&gt;<span class="built_in">getFd</span>();</span><br><span class="line">	<span class="built_in">errorif</span>(<span class="built_in">epoll_ctl</span>(mEpFd, EPOLL_CTL_DEL, fd, <span class="literal">nullptr</span>) == <span class="number">-1</span>, <span class="string">"epoll delete error"</span>);</span><br><span class="line">	channel-&gt;<span class="built_in">setExist</span>(<span class="literal">false</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>å®Œå–„ <code>Epoll::updateChannel(Channel *channel)</code>ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Epoll::updateChannel</span><span class="params">(Channel *channel)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// æ›´æ–°äº‹ä»¶eventï¼Œè¯»å†™äº‹ä»¶åŒºåˆ†å¼€</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!channel-&gt;<span class="built_in">getExist</span>())	<span class="comment">// å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ </span></span><br><span class="line">		<span class="comment">// æ·»åŠ åˆ°epoll</span></span><br><span class="line">	<span class="keyword">else</span>	<span class="comment">// å­˜åœ¨ï¼Œåªéœ€è¦ä¿®æ”¹</span></span><br><span class="line">		<span class="comment">// ä¿®æ”¹epoll</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ol start="3">
<li>å®Œå–„ <code>Epoll::poll(int timeout)</code>ï¼š</li>
</ol>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">vector&lt;Channel *&gt; <span class="title">Epoll::poll</span><span class="params">(<span class="type">int</span> timeout)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// epoll_wait</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nfds; ++i)</span><br><span class="line">	{</span><br><span class="line">		<span class="comment">// éå†äº‹ä»¶ events</span></span><br><span class="line">		<span class="keyword">if</span>(events &amp; EPOLLIN)</span><br><span class="line">			<span class="comment">// è¯»</span></span><br><span class="line">		<span class="keyword">if</span> (events &amp; EPOLLOUT)</span><br><span class="line">			<span class="comment">// å†™</span></span><br><span class="line">		<span class="keyword">if</span>(events &amp; EPOLLET)</span><br><span class="line">			<span class="comment">// ET æ¨¡å¼</span></span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// è¿”å›äº‹ä»¶ï¼ˆChannelæ•°ç»„ï¼‰</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><em>æœ€åæ£€æŸ¥å„ä¸ªæ–‡ä»¶æ— æŠ¥é”™åï¼Œæ ¹æ®éœ€è¦ä¿®æ”¹ CMakeLists.txt æ–‡ä»¶ã€‚</em></p>
<p><em>ä¹‹åï¼Œå¦‚æœæƒ³åˆ›å»ºä¸ä¸€æ ·åŠŸèƒ½çš„æœåŠ¡å™¨ï¼Œå¯ä»¥é€šç”¨æˆ‘ä»¬è¿™æ ·çš„ä¸€ä¸ªç½‘ç»œåº“ã€‚</em></p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day13">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day13">Gitee</a></p>
<h2 id="åå››-å†æ¬¡é‡æ„-å‘Šä¸€æ®µè½">åå››ã€å†æ¬¡é‡æ„ï¼Œå‘Šä¸€æ®µè½</h2>
<h3 id="14-1-é‡æ„æ€æƒ³">14.1 é‡æ„æ€æƒ³</h3>
<ol>
<li>
<p>ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆè¿›è¡Œå†…å­˜ç®¡ç†ã€‚åœ¨ä¹‹å‰çš„å¼€å‘ä¸­ï¼Œä½¿ç”¨çš„éƒ½æ˜¯åŸå§‹çš„æŒ‡é’ˆï¼Œä½†æ˜¯åŸå§‹çš„æŒ‡é’ˆå¯¹å†…å­˜ç®¡ç†è€Œè¨€æ˜¯å›°éš¾çš„ï¼Œææ˜“äº§ç”Ÿå†…å­˜æ³„æ¼ã€æ‚¬å‚å¼•ç”¨ã€é‡æŒ‡é’ˆç­‰é—®é¢˜ã€‚ä» C++11 æ ‡å‡†åï¼Œå¯ä»¥ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆæ¥ç®¡ç†å†…å­˜ï¼Œè®©ç¨‹åºå‘˜æ— éœ€è¿‡å¤šè€ƒè™‘å†…å­˜èµ„æºçš„ä½¿ç”¨ã€‚</p>
<ul>
<li><code>std::unique_ptr</code></li>
<li><code>std::shared_ptr</code></li>
<li><code>std::weak_ptr</code></li>
</ul>
</li>
<li>
<p>é¿å…èµ„æºçš„å¤åˆ¶æ“ä½œï¼Œå°½é‡ä½¿ç”¨ç§»åŠ¨è¯­ä¹‰æ¥è¿›è¡Œæ‰€æœ‰æƒçš„è½¬ç§»ï¼Œè¿™å¯¹æå‡ç¨‹åºçš„æ€§èƒ½æœ‰ååˆ†æ˜¾è‘—çš„å¸®åŠ©ã€‚</p>
</li>
<li>
<p>å¯¹é”™è¯¯ã€å¼‚å¸¸çš„å¤„ç†ã€‚åœ¨é¡¹ç›®ä¸Šçº¿åï¼Œæˆ‘ä»¬ä¸èƒ½å› ä¸ºæŸäº›é”™è¯¯å°±ç›´æ¥è®©ç¨‹åºå´©æºƒæˆ–è€…ç»ˆæ­¢ã€‚è€Œä¸”ï¼Œç»å¤§éƒ¨åˆ†é”™è¯¯éƒ½æ˜¯å¯æ¢å¤çš„ï¼š</p>
<ul>
<li>å¦‚åˆ›å»º socket å¤±è´¥å¯èƒ½æ˜¯æ–‡ä»¶æè¿°ç¬¦è¶…è¿‡æ“ä½œç³»ç»Ÿé™åˆ¶ï¼Œç¨åå†æ¬¡å°è¯•å³å¯ã€‚</li>
<li>ç›‘å¬ socket å¤±è´¥å¯èƒ½æ˜¯ç«¯å£è¢«å ç”¨ï¼Œåˆ‡æ¢ç«¯å£æˆ–æç¤ºå¹¶ç­‰å¾…ç”¨æˆ·å¤„ç†å³å¯ã€‚</li>
<li>æ‰“å¼€æ–‡ä»¶å¤±è´¥å¯èƒ½æ˜¯æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ²¡æœ‰æƒé™ï¼Œæ­¤æ—¶åªéœ€åˆ›å»ºæ–‡ä»¶æˆ–èµ‹äºˆæƒé™å³å¯ã€‚</li>
<li>æ‰€ä»¥åœ¨åº•å±‚çš„ç¼–ç ä¸Šï¼Œå¯¹äºéƒ¨åˆ†é”™è¯¯éœ€è¦è¿›è¡Œå¯æ¢å¤å¤„ç†ï¼Œé¿å…ä¸€ä¸ªæ¨¡å—æˆ–èµ„æºå‘ç”Ÿçš„å°é”™è¯¯å½±å“æ•´ä¸ªæœåŠ¡å™¨çš„è¿è¡Œã€‚</li>
</ul>
</li>
</ol>
<h3 id="14-2-è®¾è®¡å®å®šä¹‰-common-h">14.2 è®¾è®¡å®å®šä¹‰ï¼ˆCommon.hï¼‰</h3>
<p>æ˜¾å¼å°†æ‹·è´å’Œç§»åŠ¨å‡½æ•°åˆ é™¤ï¼Œé¿å…æ‹·è´å’Œç§»åŠ¨æ“ä½œï¼š</p>
<figure class="highlight h"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DISALLOW_COPY(className) \</span></span><br><span class="line"><span class="meta">	className(const className &amp;) = delete; \</span></span><br><span class="line"><span class="meta">	className &amp;operator = (const className &amp;) = delete;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISALLOW_MOVE(className) \</span></span><br><span class="line"><span class="meta">	className(className &amp;&amp;) = delete; \</span></span><br><span class="line"><span class="meta">	className &amp;operator = (className &amp;&amp;) = delete;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DISALLOW_COPY_AND_MOVE(className) \</span></span><br><span class="line"><span class="meta">	DISALLOW_COPY(className);             \</span></span><br><span class="line"><span class="meta">	DISALLOW_MOVE(className);</span></span><br></pre></td></tr></tbody></table></figure>
<p>æ–°å¢ <code>FLAG</code> æ ‡è®°ï¼Œç»Ÿä¸€æ ‡è®°å‡½æ•°çš„è¿”å›ï¼š</p>
<figure class="highlight h"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">FLAG</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">	FL_UNDIFINED,</span><br><span class="line">	FL_SUCCESS,</span><br><span class="line">	FL_SOCKET_ERROR,</span><br><span class="line">	FL_EPOLL_ERROR,</span><br><span class="line">	FL_CONNECTION_ERROR,</span><br><span class="line">	FL_ACCEPTOR_ERROR,</span><br><span class="line">	FL_UNIMPLEMENTED</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p><em>è®°å¾—ä¿®æ”¹åŒ…å«çš„å¤´æ–‡ä»¶ã€‚</em></p>
<h3 id="14-3-é‡æ„socketç±»">14.3 é‡æ„Socketç±»</h3>
<p>å¯¹ Socket ç±»çš„å‡½æ•°è¿›è¡Œé‡æ„ï¼ŒåŒæ—¶åˆ å» InetAddress ç±»ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Socket</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">int</span> mFd{ <span class="number">-1</span> };	<span class="comment">// socket æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// ç¦æ­¢æ‹·è´å’Œç§»åŠ¨</span></span><br><span class="line">	<span class="built_in">DISALLOW_COPY_AND_MOVE</span>(Socket);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">Socket</span>();</span><br><span class="line">	~<span class="built_in">Socket</span>();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setFd</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">getFd</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">std::string <span class="title">getAddr</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">socketCreate</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">socketBind</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ip, <span class="type">uint16_t</span> port)</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">socketListen</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">socketAccept</span><span class="params">(<span class="type">int</span> &amp;clientFd)</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">socketConnect</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ip, <span class="type">uint16_t</span> port)</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">setNonBlocking</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">isNonBlocking</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">size_t</span> <span class="title">recvBufSize</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äº Socket çš„åˆ›å»ºã€ç»‘å®šã€ç›‘å¬ã€æ¥å—ç­‰æ“ä½œè¿›è¡Œé”™è¯¯ã€å¼‚å¸¸çš„å¤„ç†ï¼Œåœ¨å‡½æ•°ä¸­å¤§æ¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FLAG <span class="title">xxx</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// æ–­è¨€ fd æ˜¯å¦åˆæ³•</span></span><br><span class="line">	<span class="comment">// è¿›è¡Œåˆ›å»ºã€ç»‘å®šã€ç›‘å¬ã€æ¥å—ç­‰æ“ä½œ</span></span><br><span class="line">	<span class="comment">// åˆ¤æ–­ä¸Šè¿°æ“ä½œæ˜¯å¦å‡ºç°å¼‚å¸¸</span></span><br><span class="line">	<span class="comment">// å‡ºç°å¼‚å¸¸åˆ™è¾“å‡ºå¹¶è¿”å›é”™è¯¯æ ‡è®°ï¼Œæ— å¼‚å¸¸åˆ™è¿”å›æˆåŠŸæ ‡è®°</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>å¯¹äº Socket çš„è¿æ¥æ“ä½œï¼Œæ˜¯å°† Socket è¿æ¥åˆ°æŸä¸ª IP åœ°å€ï¼Œåœ¨å‡½æ•°ä¸­å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FLAG <span class="title">Socket::socketConnect</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *ip, <span class="type">uint16_t</span> port)</span> <span class="type">const</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	<span class="comment">// æ„å»ºåœ°å€ç»“æ„ä½“</span></span><br><span class="line">	<span class="comment">// è¿æ¥</span></span><br><span class="line">	<span class="comment">// åˆ¤æ–­ä¸Šè¿°æ“ä½œæ˜¯å¦å‡ºç°å¼‚å¸¸</span></span><br><span class="line">	<span class="comment">// å‡ºç°å¼‚å¸¸åˆ™è¾“å‡ºå¹¶è¿”å›é”™è¯¯æ ‡è®°ï¼Œæ— å¼‚å¸¸åˆ™è¿”å›æˆåŠŸæ ‡è®°</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>è¿˜æœ‰å…¶ä»–çš„ Getã€Set å‡½æ•°å¯è¯¦è§ä»£ç ã€‚</p>
<h3 id="14-4-å°æ”¹channelç±»å’Œepollç±»">14.4 å°æ”¹Channelç±»å’ŒEpollç±»</h3>
<p>ä¿®æ”¹å®Œ Socket ç±»åï¼Œæ¯”è¾ƒåº•å±‚çš„è¿˜æœ‰ Channel ç±»ã€‚å¯¹äº Channel ç±»çš„æ”¹åŠ¨å¹¶ä¸å¤šï¼Œç±»å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Channel</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	EventLoop *mLoop;					<span class="comment">// æŒ‡å‘ä¸ä¹‹å…³è”çš„äº‹ä»¶å¾ªç¯</span></span><br><span class="line">	<span class="type">int</span> mFd;							<span class="comment">// ä¸ä¹‹å…³è”çš„Socket fd</span></span><br><span class="line">	<span class="type">uint32_t</span> mListenEvents{ <span class="number">0</span> };		<span class="comment">// ç›‘å¬çš„äº‹ä»¶</span></span><br><span class="line">	<span class="type">uint32_t</span> mReadyEvents{ <span class="number">0</span> };			<span class="comment">// å°±ç»ªäº‹ä»¶</span></span><br><span class="line">	<span class="type">bool</span> exist{ <span class="literal">false</span> };				<span class="comment">// æŒ‡ç¤ºè¯¥Channelæ˜¯å¦å­˜åœ¨æœ‰æ•ˆ</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>()&gt; readCallback;	<span class="comment">// è¯»å›è°ƒ</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>()&gt; writeCallback;<span class="comment">// å†™å›è°ƒ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// ç¦æ­¢æ‹·è´å’Œç§»åŠ¨</span></span><br><span class="line">	<span class="built_in">DISALLOW_COPY_AND_MOVE</span>(Channel);</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">Channel</span><span class="params">(<span class="type">int</span> fd, EventLoop *loop)</span></span>;</span><br><span class="line">	~<span class="built_in">Channel</span>();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">handleEvent</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">enableRead</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">enableWrite</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">useET</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">int</span> <span class="title">getFd</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">uint32_t</span> <span class="title">getListenEvents</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">uint32_t</span> <span class="title">getReadyEvents</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setReadyEvents</span><span class="params">(<span class="type">uint32_t</span> events)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">bool</span> <span class="title">getExist</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setExist</span><span class="params">(<span class="type">bool</span> _exist = <span class="literal">true</span>)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setReadCallback</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setWriteCallback</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>å¤§éƒ¨åˆ†ä»£ç æ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œå¯ä»¥è§ä»£ç ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè®¾ç½®å›è°ƒå‡½æ•°æ—¶ï¼Œä½¿ç”¨ <code>std::move()</code> ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Channel::setxxxCallback</span><span class="params">(std::function&lt;<span class="type">void</span>()&gt; <span class="type">const</span> &amp;callback)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">	xxxCallback = std::<span class="built_in">move</span>(callback);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Epoll ç±»å£°æ˜æ”¹ä¸ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Epoll</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">int</span> mEpFd{ <span class="number">-1</span> };					<span class="comment">// epollæ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">epoll_event</span> mEpEvent;		<span class="comment">// epolläº‹ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="comment">// ç¦ç”¨æ‹·è´å’Œç§»åŠ¨</span></span><br><span class="line">	<span class="built_in">DISALLOW_COPY_AND_MOVE</span>(Epoll);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">Epoll</span>();</span><br><span class="line">	~<span class="built_in">Epoll</span>();</span><br><span class="line">	<span class="function">FLAG <span class="title">updateChannel</span><span class="params">(Channel *channel)</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">deleteChannel</span><span class="params">(Channel *channel)</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function">std::vector&lt;Channel *&gt; <span class="title">poll</span><span class="params">(<span class="type">int</span> timeout = <span class="number">-1</span>)</span> <span class="type">const</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>å‡½æ•°æ–¹é¢ä¹Ÿæ˜¯å°æ”¹ã€‚</p>
<h3 id="14-5-å°æ”¹eventloopç±»">14.5 å°æ”¹EventLoopç±»</h3>
<p>åŸæœ¬çš„ <code>EventLoop</code> ç±»ä¸­æœ‰ä¸€ä¸ªæ™®é€šçš„æŒ‡é’ˆ <code>Epoll*</code>ï¼Œç°æ”¹ä¸º <code>std::unique_ptr</code>ã€‚é¡ºä¾¿å†æŠŠå‡½æ•°å£°æ˜ä¸º <code>const</code>ï¼Œä½¿å…¶æ›´å®‰å…¨ã€‚</p>
<p>EventLoop ç±»å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">EventLoop</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	std::unique_ptr&lt;Epoll&gt; ep;	<span class="comment">// æŒ‡å‘Epollç±»å®ä¾‹çš„æŒ‡é’ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">EventLoop</span>();</span><br><span class="line">	~<span class="built_in">EventLoop</span>();</span><br><span class="line">	<span class="built_in">DISALLOW_COPY_AND_MOVE</span>(EventLoop);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">updateChannel</span><span class="params">(Channel *channel)</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">deleteChannel</span><span class="params">(Channel *channel)</span> <span class="type">const</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>ç”±äºä½¿ç”¨äº†æ™ºèƒ½æŒ‡é’ˆï¼Œæ‰€ä»¥å…¶æ„é€ å‡½æ•°å’Œææ„å‡½æ•°ä¹Ÿç®€åŒ–äº†ä¸å°‘ã€‚</p>
<h3 id="14-6-å°æ”¹acceptorç±»">14.6 å°æ”¹Acceptorç±»</h3>
<p>Acceptor ç±»çš„é‡æ„ç±»ä¼¼ã€‚</p>
<ul>
<li>å°†ä¸€äº›æŒ‡é’ˆå˜æˆæ™ºèƒ½æŒ‡é’ˆï¼›</li>
<li>ä½¿ç”¨ä¹‹å‰å®šä¹‰çš„ <code>FLAG</code> æ ‡è®°ã€‚</li>
</ul>
<p>Acceptor ç±»å£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Acceptor</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	std::unique_ptr&lt;Socket&gt; mSocket;	<span class="comment">// ç”¨äºå¤„ç†å¥—æ¥å­—æ“ä½œçš„å¥—æ¥å­—æŒ‡é’ˆ</span></span><br><span class="line">	std::unique_ptr&lt;Channel&gt; mChannel;	<span class="comment">// ç”¨äºæ¥å—è¿æ¥çš„ Channel æŒ‡é’ˆ</span></span><br><span class="line">	<span class="comment">// å®šä¹‰ä¸€ä¸ªæ–°å»ºè¿æ¥çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(<span class="type">int</span>)&gt; mNewConnectionCallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DISALLOW_COPY_AND_MOVE</span>(Acceptor);</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">Acceptor</span><span class="params">(EventLoop *loop)</span></span>;</span><br><span class="line">	~<span class="built_in">Acceptor</span>();</span><br><span class="line"></span><br><span class="line">	<span class="function">FLAG <span class="title">acceptConnection</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setNewConnectionCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(<span class="type">int</span>)&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h3 id="14-7-å°æ”¹connectionç±»">14.7 å°æ”¹Connectionç±»</h3>
<p>å¯¹äº Connection ç±»ä¸­çš„æŒ‡é’ˆæ”¹ç”¨æ™ºèƒ½æŒ‡é’ˆï¼ŒåŒæ—¶æŒ‰éœ€æ±‚ç®€åŒ–äº†éƒ¨åˆ†å‡½æ•°ï¼Œå£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Connection</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="keyword">enum</span> <span class="title class_">State</span></span><br><span class="line">	{</span><br><span class="line">		Invalid = <span class="number">0</span>, <span class="comment">// åˆå§‹æ— æ•ˆçŠ¶æ€</span></span><br><span class="line">		Handshaking, <span class="comment">// æ¡æ‰‹è¿‡ç¨‹ä¸­çš„çŠ¶æ€</span></span><br><span class="line">		Connected,   <span class="comment">// è¿æ¥å»ºç«‹</span></span><br><span class="line">		Closed,      <span class="comment">// è¿æ¥å…³é—­</span></span><br><span class="line">		Failed,      <span class="comment">// è¿æ¥å¤±è´¥</span></span><br><span class="line">	};</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="comment">//EventLoop *mLoop;											// EventLoopæŒ‡é’ˆ</span></span><br><span class="line">	std::unique_ptr&lt;Socket&gt; mSocket;							<span class="comment">// SocketæŒ‡é’ˆ</span></span><br><span class="line">	std::unique_ptr&lt;Channel&gt; mChannel{ <span class="literal">nullptr</span> };				<span class="comment">// ChannelæŒ‡é’ˆ</span></span><br><span class="line">	std::unique_ptr&lt;Buffer&gt; mReadBuffer{ <span class="literal">nullptr</span> };				<span class="comment">// è¯»ç¼“å†²åŒº</span></span><br><span class="line">	std::unique_ptr&lt;Buffer&gt; mSendBuffer{ <span class="literal">nullptr</span> };				<span class="comment">// å†™ç¼“å†²åŒº</span></span><br><span class="line"></span><br><span class="line">	State mState{ Invalid };									<span class="comment">// è¿æ¥çŠ¶æ€</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(<span class="type">int</span>)&gt; mDeleteConnectionCallback;			<span class="comment">// åˆ é™¤è¿æ¥çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(Connection *)&gt; mOnMessageCallback;		<span class="comment">// ä¸šåŠ¡é€»è¾‘å›è°ƒå‡½æ•°</span></span><br><span class="line"></span><br><span class="line">	<span class="function">FLAG <span class="title">readNonBlocking</span><span class="params">()</span></span>;		<span class="comment">// éé˜»å¡è¯»</span></span><br><span class="line">	<span class="function">FLAG <span class="title">writeNonBlocking</span><span class="params">()</span></span>;	<span class="comment">// éé˜»å¡å†™</span></span><br><span class="line">	<span class="function">FLAG <span class="title">readBlocking</span><span class="params">()</span></span>;		<span class="comment">// é˜»å¡è¯»</span></span><br><span class="line">	<span class="function">FLAG <span class="title">writeBlocking</span><span class="params">()</span></span>;		<span class="comment">// é˜»å¡å†™</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">Connection</span><span class="params">(EventLoop *loop, <span class="type">int</span> fd)</span></span>;</span><br><span class="line">	~<span class="built_in">Connection</span>();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç¦æ­¢æ‹·è´å’Œç§»åŠ¨</span></span><br><span class="line">	<span class="built_in">DISALLOW_COPY_AND_MOVE</span>(Connection);</span><br><span class="line">	<span class="function">FLAG <span class="title">read</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">write</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	FLAG <span class="title">send</span><span class="params">(std::string msg)</span></span></span><br><span class="line"><span class="function">	<span class="type">void</span> <span class="title">setOnMessageCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setDeleteConnectionCallback</span><span class="params">(std::function&lt;<span class="type">void</span>(<span class="type">int</span>)&gt; <span class="type">const</span> &amp;callback)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">business</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">State <span class="title">getState</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">setSentBuffer</span><span class="params">(<span class="type">char</span> <span class="type">const</span> *str)</span></span>;</span><br><span class="line">	<span class="function">Buffer *<span class="title">getReadBuffer</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">Buffer *<span class="title">getSendBuffer</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function">Socket *<span class="title">getSocket</span><span class="params">()</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<h3 id="14-8-é‡å¤´æˆserverç±»">14.8 é‡å¤´æˆServerç±»</h3>
<p>å¯¹ Serverç±»çš„ä¼—å¤šæŒ‡é’ˆéƒ½æ”¹ä¸ºæ™ºèƒ½æŒ‡é’ˆï¼Œå£°æ˜å¦‚ä¸‹ï¼š</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Server</span></span><br><span class="line">{</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	std::unique_ptr&lt;EventLoop&gt; mainReactor;					<span class="comment">// åªè´Ÿè´£æ¥å—è¿æ¥ï¼Œç„¶ååˆ†å‘ç»™ä¸€ä¸ªsubReactor</span></span><br><span class="line">	std::vector&lt;std::unique_ptr&lt;EventLoop&gt;&gt; subReactors;	<span class="comment">// å¤„ç†äº‹ä»¶å¾ªç¯</span></span><br><span class="line">	std::unique_ptr&lt;Acceptor&gt; acceptor;						<span class="comment">// è¿æ¥æ¥å—å™¨</span></span><br><span class="line">	std::unordered_map&lt;<span class="type">int</span>, std::unique_ptr&lt;Connection&gt;&gt; connections;	<span class="comment">// å­˜å‚¨è¿æ¥åŠå…¶ç›¸åº”çš„æ–‡ä»¶æè¿°ç¬¦</span></span><br><span class="line">	std::unique_ptr&lt;ThreadPool&gt; threadPool;					<span class="comment">// çº¿ç¨‹æ± </span></span><br><span class="line"></span><br><span class="line">	std::function&lt;<span class="type">void</span>(Connection *)&gt; onConnectionCallback;	<span class="comment">// è¿æ¥çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line">	std::function&lt;<span class="type">void</span>(Connection *)&gt; onMessageCallback;	<span class="comment">// æ¥æ”¶æ¶ˆæ¯åçš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Server</span>();</span><br><span class="line">	~<span class="built_in">Server</span>();</span><br><span class="line">	<span class="built_in">DISALLOW_COPY_AND_MOVE</span>(Server);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">onConnect</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; fn)</span></span>;</span><br><span class="line">	<span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(std::function&lt;<span class="type">void</span>(Connection *)&gt; fn)</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">newConnection</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">	<span class="function">FLAG <span class="title">deleteConnection</span><span class="params">(<span class="type">int</span> fd)</span></span>;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>
<p>ä¿®æ”¹å®Œè¿™ä¹ˆå¤šç±»åï¼Œè®°å¾—æŸ¥çœ‹ä»£ç ä¿®æ”¹ä¸€ä¸‹æµ‹è¯•çš„ <code>server.cpp</code>ã€<code>SingleClient.cpp</code>ã€<code>MultipleClients.cpp</code> ç­‰æ–‡ä»¶ï¼Œç„¶åç¼–è¯‘å³å¯ã€‚</p>
<p>è¯¥èŠ‚ä»£ç ï¼š<a target="_blank" rel="noopener" href="https://github.com/Fingsinz/MakeServerInLinux/tree/master/Day14">Github</a>ï¼Œ<a target="_blank" rel="noopener" href="https://gitee.com/fingsinz/make-server-in-linux/tree/master/Day14">Gitee</a></p>
<hr>
<p><em>è¿™ä¸ªé¡¹ç›®åˆ°è¿™é‡Œä¹Ÿå‘Šä¸€æ®µè½äº†ï¼Œä¸€æ¥æ˜¯åŸä½œè€…æš‚æœªæ›´æ–°ï¼ŒäºŒæ¥æˆ‘ä¹Ÿè¿˜æ²¡èƒ½åŠ›ç»­å†™ä¸‹å»ã€‚æˆ‘çš„æƒ³æ³•æ˜¯æœ‰æ—¶é—´å†é‡æ–°ç»„ç»‡ä¸€ä¸‹è¯­è¨€ï¼Œç»†åŒ–ä¸€ä¸‹æ¯ä¸€ç« çš„æè¿°ã€‚è¿™ä¸ªé¡¹ç›®ä½œä¸ºä¸€ä¸ª Linux ç½‘ç»œç¼–ç¨‹çš„å…¥é—¨é¡¹ç›®è¿˜æ˜¯ç›¸å½“ä¸é”™çš„ï¼Œèƒ½å¤Ÿäº†è§£åˆ° Socketã€çº¿ç¨‹æ± ä»¥åŠä¸€ç³»åˆ—æŠ½è±¡ç¼–ç¨‹æ€æƒ³ã€‚å¦‚æœæƒ³ç»§ç»­æ·±å…¥å­¦ä¹ ç½‘ç»œç¼–ç¨‹ï¼Œé‚£è·¯è¿˜æœ‰å¾ˆé•¿å¾ˆé•¿â€¦â€¦</em></p>
<p><em>â€”â€”Fingsinzï¼Œ2024.06.06ç•™</em></p>
<hr>
<h2 id="é™„å½•">é™„å½•</h2>
<h3 id="é™„-1-ä»£ç è¿è¡Œç¯å¢ƒ">é™„ 1 - ä»£ç è¿è¡Œç¯å¢ƒ</h3>
<ul>
<li>ä»£ç ç¼–å†™ï¼šWindows ä¸‹ Visual Studio 2022</li>
<li>ä»£ç ç¼–è¯‘åŠæ‰§è¡Œï¼šé˜¿é‡Œäº‘ ECSï¼ŒUbuntu 20.04.6 LTS (GNU/Linux 5.4.0-169-generic x86_64)</li>
</ul>
<p>åœ¨ Visual Studio 2022 ä¸­ç¼–å†™ä»£ç ï¼Œæ¥ç€è¿æ¥è¿œç¨‹æœåŠ¡å™¨ï¼Œå°†ä»£ç éƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚</p>
<ul>
<li>å‰æœŸåœ¨æœåŠ¡å™¨ä½¿ç”¨ <code>make</code> ç¼–è¯‘ä»£ç ã€‚<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/798104">Ubuntuä¹‹makeï¼šmakeå‘½ä»¤è¡Œå·¥å…·çš„ç®€ä»‹ã€å®‰è£…ã€ä½¿ç”¨æ–¹æ³•ä¹‹è¯¦ç»†æ”»ç•¥</a>
<ul>
<li>ç¼–è¯‘å‘½ä»¤è§æ¯ä¸ª Day ä¸­çš„ Makefile æ–‡ä»¶ã€‚
<ul>
<li><code>make</code> å‘½ä»¤ä¸ºï¼š<code>make build</code> æˆ– <code>make</code>ã€‚</li>
<li>æ¸…ç†ç¼–è¯‘ç»“æœå‘½ä»¤ä¸ºï¼š<code>make clean</code>ã€‚</li>
</ul>
</li>
<li>è‹¥æ²¡æœ‰ <code>make</code>ï¼Œå¯ä»¥æ‰‹åŠ¨è¾“å…¥ï¼ˆMakefileä¸­çš„ï¼‰ <code>g++</code> å‘½ä»¤ç¼–è¯‘ã€‚</li>
</ul>
</li>
<li>åæœŸè€ƒè™‘ä½¿ç”¨ CMake å°†é¡¹ç›®å·¥ç¨‹åŒ–ï¼Œè¯¦æƒ…çœ‹é™„å½• 2ã€‚</li>
</ul>
<h3 id="é™„-2-cmakeçš„å®‰è£…å’Œä½¿ç”¨">é™„ 2 - CMakeçš„å®‰è£…å’Œä½¿ç”¨</h3>
<p>æ­¤å¤„çš„ç¯å¢ƒæ˜¯ï¼š<strong>Visual Studio 2022 è¿œç¨‹è¿æ¥ Ubuntu 20.04.6 LTS</strong></p>
<ul>
<li><em>å½“ç„¶ Windows ä¹Ÿæœ‰ CMakeï¼Œæ­¤å¤„ä¸»è¦æ˜¯åœ¨ Linux ä¸‹çš„ä½¿ç”¨ã€‚</em></li>
</ul>
<h4 id="é™„-2-1-æ£€æŸ¥è¿œç¨‹çš„cmakeç¯å¢ƒå’Œç¼–è¯‘ç¯å¢ƒ">é™„ 2.1 æ£€æŸ¥è¿œç¨‹çš„CMakeç¯å¢ƒå’Œç¼–è¯‘ç¯å¢ƒ</h4>
<p><em>å¯èƒ½éœ€è¦å…ˆ <code>apt-get update</code> æ›´æ–°ä¸€ä¸‹ aptã€‚</em></p>
<ol>
<li>å®‰è£… CMake å·¥å…·</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install cmake</span><br></pre></td></tr></tbody></table></figure>
<ol start="2">
<li>å¯é€‰æ‹©å®‰è£…ä½¿ç”¨ clang ç¼–è¯‘å™¨</li>
</ol>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install clang</span><br></pre></td></tr></tbody></table></figure>
<h4 id="é™„-2-2-visual-studio-2022ä¸­ä½¿ç”¨cmakeè¿›è¡Œè¿œç¨‹linuxæœåŠ¡å™¨å¼€å‘">é™„ 2.2 Visual Studio 2022ä¸­ä½¿ç”¨CMakeè¿›è¡Œè¿œç¨‹LinuxæœåŠ¡å™¨å¼€å‘</h4>
<ol>
<li>åˆ›å»ºé€‰æ‹© CMake é¡¹ç›®ï¼Œæˆ‘æ­¤å¤„æ„å»ºæ¼”ç¤ºé¡¹ç›® <code>CMakeTestProject</code>ã€‚</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-2.jpg" title="é€‰æ‹©CMakeé¡¹ç›®" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-2.jpg" alt="é€‰æ‹©CMakeé¡¹ç›®"></a></p>
<ol start="2">
<li>é€‰æ‹©è¿œç¨‹çš„ Linux è®¡ç®—æœºï¼Œç®¡ç†é…ç½®ï¼Œæ–°å»ºä¸€ä¸ªé…ç½®ã€‚</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-3.jpg" title="ç®¡ç†é…ç½®" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-3.jpg" alt="ç®¡ç†é…ç½®"></a></p>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-4.jpg" title="æ–°å»ºé…ç½®" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-4.jpg" alt="æ–°å»ºé…ç½®"></a></p>
<ol start="3">
<li>ç¼–è¾‘é…ç½®ï¼Œå…·ä½“çœ‹ä¸‹å›¾ï¼Œä¸»è¦ä¿®æ”¹éƒ¨åˆ†å·²ç»æ¡†é€‰ã€‚</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-5.jpg" title="ç¼–è¾‘é…ç½®" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-5.jpg" alt="ç¼–è¾‘é…ç½®"></a></p>
<ol start="4">
<li>
<p>æ­£å¸¸ç¼–å†™ä»£ç ï¼Œæ­¤å¤„æˆ‘ç”¨ Day12ï¼ˆç¬¬åäºŒç« ï¼‰çš„ä»£ç ä½œä¸ºæ¼”ç¤ºã€‚ç¼–å†™ä»£ç åï¼Œå¯ä»¥ç‚¹è¿›å»æ ¹ç›®å½•çš„ <code>CMakeLists.txt</code> æ–‡ä»¶ï¼Œä¿å­˜ä¸€ä¸‹ï¼ˆ<code>ctrl + s</code>ï¼‰ï¼Œå°±ä¼šè‡ªåŠ¨å¤åˆ¶åˆ°è¿œç¨‹ã€‚</p>
</li>
<li>
<p>è¿›è¡Œé¡¹ç›®ç”Ÿæˆå’Œç¼–è¯‘ï¼Œé¡¹ç›®ç”Ÿæˆæœ‰ä¸¤ç§æ–¹å¼ï¼š</p>
</li>
</ol>
<ul>
<li>å¯ä»¥é€‰æ‹©å³é”®é¡¹ç›®åï¼Œé€‰æ‹©ä»¥ CMake è§†å›¾æŸ¥çœ‹ã€‚å†è¿›è¡Œç”Ÿæˆæˆ–æ¸…ç†ï¼Œæœ€åä½¿ç”¨ç¼–è¯‘å‘½ä»¤è¿›è¡Œç¼–è¯‘ã€‚</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-6.jpg" title="é€‰æ‹©CMakeè§†å›¾" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-6.jpg" alt="é€‰æ‹©CMakeè§†å›¾"></a></p>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-7.jpg" title="ç”Ÿæˆå’Œæ¸…ç†" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-7.jpg" alt="ç”Ÿæˆå’Œæ¸…ç†"></a></p>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-8.jpg" title="ç”ŸæˆæˆåŠŸ1" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-8.jpg" alt="ç”ŸæˆæˆåŠŸ1"></a></p>
<ul>
<li>å¯ä»¥åœ¨ Linux çš„ç»ˆç«¯ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</li>
</ul>
<figure class="highlight bash"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake ../src/ &amp;&amp; make</span><br></pre></td></tr></tbody></table></figure>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-9.jpg" title="ç”ŸæˆæˆåŠŸ2" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-9.jpg" alt="ç”ŸæˆæˆåŠŸ2"></a></p>
<p><em>å¯ä»¥åœ¨ CMakeLists.txt ä¸­çš„é¡¹ç›®ä¿¡æ¯ä¹‹å‰è®¾ç½®ç¼–è¯‘å™¨ä¸ºClangã€‚</em></p>
<ol start="6">
<li>ç”ŸæˆæˆåŠŸåå°±å¯ä»¥åœ¨ <code>CMakeLists.txt</code> ä¸­æŒ‡å®šçš„è¾“å‡ºæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°å¯æ‰§è¡Œæ–‡ä»¶æˆ–å…¶ä»–ã€‚</li>
</ol>
<h4 id="é™„-2-2-visual-studio-2022ä¸­ä½¿ç”¨cmakeè¿›è¡Œwslå¼€å‘">é™„ 2.2 Visual Studio 2022ä¸­ä½¿ç”¨CMakeè¿›è¡ŒWSLå¼€å‘</h4>
<p><em>æœ‰çš„äººå¯èƒ½æ²¡æœ‰LinuxæœåŠ¡å™¨ï¼Œä½†æ˜¯WSLå¯ä»¥æœ‰çš„ã€‚å¦‚ä½•å®‰è£…WSLå¯ä»¥æŸ¥çœ‹<a target="_blank" rel="noopener" href="https://www.fingsinz.space/2024/20/">è¿™é‡Œ</a></em></p>
<p>åŸºæœ¬æ­¥éª¤åŒä¸Šï¼Œä½†åœ¨æ–°å»ºé…ç½®å’Œç¼–è¾‘æ—¶ï¼Œéœ€è¦åšä¸€äº›ä¿®æ”¹ï¼š</p>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-10.jpg" title="æ–°å»ºå…³äºWSLçš„é…ç½®" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-10.jpg" alt="æ–°å»ºå…³äºWSLçš„é…ç½®"></a></p>
<p><a target="_blank" rel="noopener" href="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-11.jpg" title="ç¼–è¾‘å…³äºWSLçš„é…ç½®" class="gallery-item" style="box-shadow: none;"> <img src="https://fblog-1257020106.cos.ap-shanghai.myqcloud.com/imgs/LinuxServer_Day12-11.jpg" alt="ç¼–è¾‘å…³äºWSLçš„é…ç½®"></a></p>
<h4 id="é™„-2-3-cmakeç›¸å…³èµ„æ–™">é™„ 2.3 CMakeç›¸å…³èµ„æ–™</h4>
<ul>
<li><a target="_blank" rel="noopener" href="https://modern-cmake-cn.github.io/Modern-CMake-zh_CN/">https://modern-cmake-cn.github.io/Modern-CMake-zh_CN/</a></li>
</ul>
<h3 id="é™„-3-å¯èƒ½å‡ºç°çš„é—®é¢˜">é™„ 3 - å¯èƒ½å‡ºç°çš„é—®é¢˜</h3>
<ul>
<li>
<p>åœ¨ Ubuntu ä¸­å®‰è£… <code>make</code> æ—¶ï¼Œå‡ºç° <font color="red">â€œdpkg: error processing package ***â€</font> çš„é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒ <a target="_blank" rel="noopener" href="https://blog.csdn.net/dou3516/article/details/105120221">CSDN</a>ã€‚</p>
</li>
<li>
<p>åœ¨çº¿ç¨‹æ± éƒ¨åˆ†ä¸­ï¼Œç›´æ¥ä½¿ç”¨ <code>g++</code> å‘½ä»¤ä¼šå‡ºç° <font color="red">â€œå¯¹â€˜pthread_createâ€™æœªå®šä¹‰çš„å¼•ç”¨â€</font> çš„é—®é¢˜ï¼Œéœ€è¦åŠ ä¸Š <code>-lpthread</code> å‚æ•°ï¼Œè¯¦è§ <a target="_blank" rel="noopener" href="https://blog.csdn.net/Dontla/article/details/122637407">CSDN</a> æˆ– <code>Makefile</code> ä¸­çš„åšæ³•ã€‚</p>
</li>
</ul>
</div><script src="https://jsd.onmicrosoft.cn/npm/hexo-theme-a4@latest/source/js/lightgallery.min.js"></script><script>if (typeof lightGallery !== 'undefined') {
        var options = {
            selector: '.gallery-item'
        };
        lightGallery(document.getElementsByClassName('.article-gallery')[0], options);
        }</script><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
    </div>

    <div class="post-meta">
        <i>
        
            <span>2024-03-22</span>
            
                <span>è¯¥ç¯‡æ–‡ç« è¢« Fingsinz</span>
            
            
                <span>æ‰“ä¸Šæ ‡ç­¾:
                    
                    
                        <a href='/tags/C/'>
                            C++
                        </a>
                    
                        <a href='/tags/Linux/'>
                            Linux
                        </a>
                    
                </span>
             
             
                <span>å½’ä¸ºåˆ†ç±»:
                    
                    
                        <a href='/categories/%E7%AC%94%E8%AE%B0/'>
                            ç¬”è®°
                        </a>
                    
                </span>
            
        
        </i>
    </div>
    <br>
    
    <!-- <div class="post-footer-pre-next">
        <span>ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
        <span class="post-footer-pre-next-last-span-right">ä¸Šä¸€ç¯‡ï¼š<a href=""></a></span>
    </div> -->

    
        

     
</div>



                                      
                    
                    
                    <div class="footer">
    
        <span> 
            Â©2023-2024 

            
                

            
                
                    / <a href="/"> Fingsinz&#39;s Space </a>
                

            
                
                    / <a target="_blank" rel="noopener" href="https://www.zhihu.com/people/fingsinz"> çŸ¥ä¹ </a>
                

            
        </span>
    
</div>
<!--è¿™æ˜¯æŒ‡ä¸€æ¡çº¿å¾€ä¸‹çš„å†…å®¹-->
<div class="footer-last">
    
            <span>æˆ‘åœ¨æƒ³ï¼Œæ—¶ä¸‹ä½ æ‰€éœ€è¦çš„ï¼Œåº”è¯¥æ˜¯ç—›ç—›å¿«å¿«æ¢ä¸ªå¿ƒæƒ…ï¼Œå¹²å¹²è„†è„†äº«å—äººç”Ÿã€‚</span>
            
    
</div>


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <!--ç›®å½•-->
    
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js" type="text/javascript" ></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tocify/1.9.0/javascripts/jquery.tocify.min.js" type="text/javascript" ></script>
        
<script src="/js/toc.js"></script>

    

    
<script src="/js/randomHeaderContent.js"></script>

    <!--å›åˆ°é¡¶éƒ¨æŒ‰é’®-->
    
        
<script src="/js/returnToTop.js"></script>

    

    
        
<script src="/js/returnToLastPage.js"></script>

    





<script src="/js/lightgallery.min.js"></script>



                </div>
            
            
                <!-- å›åˆ°é¡¶éƒ¨çš„æŒ‰é’®-->  
                <div class="progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
            
                <!-- è¿”å›çš„æŒ‰é’®-->  
                <div class="return-to-last-progress-wrap shadow-drop-2-bottom">
                    <svg class="progress-circle svg-content" width="100%" height="100%" viewBox="-1 -1 102 102">
                        <path d="M50,1 a49,49 0 0,1 0,98 a49,49 0 0,1 0,-98"/>
                    </svg>
                </div>
            
    </body>


</html>